<!DOCTYPE html>
<html lang="en">
<head>
  <!-- View Transitions API -->
  <meta name="view-transition" content="same-origin">
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-VLFHH5CPGM"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-VLFHH5CPGM');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <title>ACID in Rails PostgreSQL vs MongoDB - with Atomic Patterns | Software Engineering consultant</title>
  
  <meta name="theme-color" content="#006cac">

  <link rel="canonical" href="http://localhost:4000/blog/acid_in_rails_postgresql_vs_mongodb">
  <link rel="alternate" type="application/rss+xml" title="Software Engineering consultant" href="http://localhost:4000/feed.xml" />
  <link rel="shortcut icon" type="image/png" href="http://localhost:4000/favicon.png">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Stylesheets -->
  <link rel="stylesheet" href="/assets/css/global.css">
  <link rel="stylesheet" href="/assets/css/custom.css">
  <link rel="stylesheet" href="/assets/css/typography.css">

  <meta name="description"
    content="ACID in Rails PostgreSQL vs MongoDB with Atomic Patterns">
  <meta name="keywords"
    content="Software Engineering consultant, programming consultant, Ruby web development, agile Ruby development, Ruby on Rails web design, RoR consulting, Ruby on Rails service, RoR consultant, Ruby on Rails NYC, Ruby on Rails expertise, web agency, ios application development, mobile, api, frontend, backend, development, software engineer partner, sf developer, sf ruby on rails, berling ruby consultant, london consultant">
  <meta name="author" content="Max Lukin">

  <!-- Theme initialization - prevent flash -->
  <script>
    (function() {
      const savedTheme = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const theme = savedTheme || (prefersDark ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>ACID in Rails PostgreSQL vs MongoDB - with Atomic Patterns | Software Engineering consultant</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="ACID in Rails PostgreSQL vs MongoDB - with Atomic Patterns" />
<meta name="author" content="Max Lukin" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="ACID in Rails PostgreSQL vs MongoDB with Atomic Patterns" />
<meta property="og:description" content="ACID in Rails PostgreSQL vs MongoDB with Atomic Patterns" />
<link rel="canonical" href="http://localhost:4000/blog/acid_in_rails_postgresql_vs_mongodb" />
<meta property="og:url" content="http://localhost:4000/blog/acid_in_rails_postgresql_vs_mongodb" />
<meta property="og:site_name" content="Software Engineering consultant" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-09-01T14:00:00+05:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="ACID in Rails PostgreSQL vs MongoDB - with Atomic Patterns" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Max Lukin"},"dateModified":"2025-09-01T14:00:00+05:00","datePublished":"2025-09-01T14:00:00+05:00","description":"ACID in Rails PostgreSQL vs MongoDB with Atomic Patterns","headline":"ACID in Rails PostgreSQL vs MongoDB - with Atomic Patterns","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/blog/acid_in_rails_postgresql_vs_mongodb"},"url":"http://localhost:4000/blog/acid_in_rails_postgresql_vs_mongodb"}</script>
<!-- End Jekyll SEO tag -->

</head>


<body>
  <!-- Main content wrapper -->
  <div class="main-wrapper centered">
    <main>
      <!-- Reading progress bar -->
<div class="reading-progress" id="reading-progress"></div>

<article class="post-article">
  <!-- Back navigation -->
  <a href="/blog" class="back-home">
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M19 20H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v1m2 13a2 2 0 0 1-2-2V7m2 13a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-2m-4-3H9M7 16h6M7 12h10"/>
    </svg>
    <span>Blog</span>
  </a>

  <!-- Post header -->
  <header class="post-header">
    <h1 class="post-title">ACID in Rails PostgreSQL vs MongoDB - with Atomic Patterns</h1>
    <div class="post-meta">
      <time datetime="2025-09-01T14:00:00+05:00">Sep 1, 2025</time>
      
      
      
      <span>· 7 min read</span>
      
        <span>· Max Lukin</span>
      
      
        <span class="post-tags"><a href="/search?q=rails-8" class="tag">rails-8</a><a href="/search?q=database" class="tag">database</a></span>
      
    </div>
  </header>

  <div class="post-body">
    <!-- Table of Contents (generated by JS for posts with 4+ headings) -->
    <aside class="toc-sidebar" id="toc-sidebar">
      <nav class="toc" id="toc">
        <div class="toc-title">Contents</div>
        <ul class="toc-list" id="toc-list"></ul>
      </nav>
    </aside>

    <!-- Post content -->
    <div class="prose post-content" id="post-content">
      <h1 id="acid-atomicity-and-rails-patterns-postgresql-vs-mongodb">ACID, Atomicity, and Rails Patterns: PostgreSQL vs MongoDB</h1>

<p>This post consolidates our full discussion about <strong>ACID</strong> properties,
what’s atomic and what isn’t, and how this applies to <strong>Ruby on Rails</strong>
with <strong>PostgreSQL</strong> and <strong>MongoDB</strong>. It includes explanations, Rails
best practices, anti-patterns, and corrected implementations.</p>

<hr />

<h2 id="1-what-is-acid">1. What is ACID?</h2>

<p><strong>ACID</strong> is a set of four properties that guarantee database
reliability:</p>

<ol>
  <li><strong>Atomicity</strong> – A transaction is “all or nothing”. Either every
operation succeeds, or none are applied.</li>
  <li><strong>Consistency</strong> – Data must always move from one valid state to
another. Constraints, validations, and referential integrity must
hold true.</li>
  <li><strong>Isolation</strong> – Concurrent transactions should not interfere with
each other. Each transaction should behave as if it’s running alone.</li>
  <li><strong>Durability</strong> – Once a transaction is committed, it survives
crashes, restarts, and power loss.</li>
</ol>

<hr />

<h2 id="2-acid-in-postgresql-rails-default-relational-db">2. ACID in PostgreSQL (Rails default relational DB)</h2>

<p>PostgreSQL is <strong>fully ACID-compliant</strong>:</p>

<ul>
  <li>✅ <strong>Atomicity</strong>: <code class="language-plaintext highlighter-rouge">ActiveRecord::Base.transaction</code> ensures rollback
if any statement fails.\</li>
  <li>✅ <strong>Consistency</strong>: Enforced with primary keys, foreign keys, NOT
NULL, CHECK, Rails validations, etc.\</li>
  <li>✅ <strong>Isolation</strong>: PostgreSQL supports multiple isolation levels
(<code class="language-plaintext highlighter-rouge">READ COMMITTED</code>, <code class="language-plaintext highlighter-rouge">REPEATABLE READ</code>, <code class="language-plaintext highlighter-rouge">SERIALIZABLE</code>). Rails
defaults to <code class="language-plaintext highlighter-rouge">READ COMMITTED</code>.\</li>
  <li>✅ <strong>Durability</strong>: Uses write-ahead logging (WAL). Once committed,
data is safe.</li>
</ul>

<p>Example in Rails:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">transaction</span> <span class="k">do</span>
  <span class="n">user</span><span class="p">.</span><span class="nf">save!</span>
  <span class="n">profile</span><span class="p">.</span><span class="nf">save!</span>
<span class="k">end</span>
</code></pre></div></div>

<p>If <code class="language-plaintext highlighter-rouge">profile.save!</code> fails, <code class="language-plaintext highlighter-rouge">user.save!</code> rolls back automatically.</p>

<hr />

<h2 id="3-acid-in-mongodb-nosql">3. ACID in MongoDB (NoSQL)</h2>

<p>MongoDB is <strong>not fully ACID</strong> in the same sense as PostgreSQL:</p>

<ul>
  <li>✅ <strong>Atomicity</strong>: Guaranteed <strong>per single document</strong>.<br />
❌ Multi-document atomicity is only possible with multi-document
transactions (added in MongoDB 4.0, but with overhead).\</li>
  <li>⚠️ <strong>Consistency</strong>: Schema-less by default. Rails (via <code class="language-plaintext highlighter-rouge">mongoid</code>)
must enforce validations at app level.\</li>
  <li>⚠️ <strong>Isolation</strong>: Document-level isolation only. If two transactions
modify separate fields of the same document concurrently, one may
overwrite the other without detecting conflict.\</li>
  <li>⚠️ <strong>Durability</strong>: Configurable via <strong>write concerns</strong> (<code class="language-plaintext highlighter-rouge">w:1</code>,
<code class="language-plaintext highlighter-rouge">w:majority</code>). If not set properly, writes can be acknowledged
before being persisted.</li>
</ul>

<p>Rails (with Mongoid) example:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">User</span><span class="p">.</span><span class="nf">with_session</span> <span class="k">do</span> <span class="o">|</span><span class="n">session</span><span class="o">|</span>
  <span class="n">session</span><span class="p">.</span><span class="nf">start_transaction</span>
  <span class="n">user</span><span class="p">.</span><span class="nf">update!</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"Max"</span><span class="p">)</span>
  <span class="n">profile</span><span class="p">.</span><span class="nf">update!</span><span class="p">(</span><span class="ss">bio: </span><span class="s2">"Hello"</span><span class="p">)</span> <span class="c1"># multi-doc transaction</span>
  <span class="n">session</span><span class="p">.</span><span class="nf">commit_transaction</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Without a transaction, only <code class="language-plaintext highlighter-rouge">user.update!</code> might persist, breaking
atomicity.</p>

<hr />

<h2 id="4-what-should-be-atomic-in-rails">4. What Should Be <strong>Atomic</strong> in Rails?</h2>

<p>Atomicity should be applied to operations where <strong>partial success would
corrupt data integrity</strong>:</p>

<ul>
  <li>✅ <strong>Creating related records</strong> (e.g., <code class="language-plaintext highlighter-rouge">User</code> + <code class="language-plaintext highlighter-rouge">Profile</code>).\</li>
  <li>✅ <strong>Money transfers / payments</strong> (must debit &amp; credit atomically).\</li>
  <li>✅ <strong>Bulk inserts / updates</strong> where all must succeed together.\</li>
  <li>✅ <strong>Inventory changes</strong> (e.g., decrementing stock and creating an
order).</li>
</ul>

<p>What doesn’t need to be atomic:</p>

<ul>
  <li>❌ <strong>Read-only queries</strong> (no state change).\</li>
  <li>❌ <strong>Logging / analytics writes</strong> (failure doesn’t break core
business).\</li>
  <li>❌ <strong>Background jobs</strong> (can retry independently).\</li>
  <li>❌ <strong>Non-critical side effects</strong> (sending emails, audit trails —
wrap in <code class="language-plaintext highlighter-rouge">after_commit</code> hooks instead).</li>
</ul>

<hr />

<h2 id="5-rails-anti-patterns-vs-fixed-atomic-patterns">5. Rails Anti-Patterns vs Fixed Atomic Patterns</h2>

<h3 id="postgresql-examples">PostgreSQL Examples</h3>

<h4 id="-bad-user--profile-creation-partial-writes-possible">❌ Bad: User + Profile creation (partial writes possible)</h4>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">create</span>
  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">email: </span><span class="n">params</span><span class="p">[</span><span class="ss">:email</span><span class="p">])</span>
  <span class="n">profile</span> <span class="o">=</span> <span class="no">Profile</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">user: </span><span class="n">user</span><span class="p">,</span> <span class="ss">name: </span><span class="n">params</span><span class="p">[</span><span class="ss">:name</span><span class="p">])</span> <span class="c1"># may fail later</span>
<span class="k">end</span>
</code></pre></div></div>

<h4 id="-fixed-use-transaction">✅ Fixed: Use transaction</h4>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">transaction</span> <span class="k">do</span>
  <span class="n">user</span>    <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">email: </span><span class="n">params</span><span class="p">[</span><span class="ss">:email</span><span class="p">])</span>
  <span class="n">profile</span> <span class="o">=</span> <span class="no">Profile</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">user: </span><span class="n">user</span><span class="p">,</span> <span class="ss">name: </span><span class="n">params</span><span class="p">[</span><span class="ss">:name</span><span class="p">])</span>
<span class="k">end</span>
</code></pre></div></div>

<hr />

<h4 id="-bad-money-transfer-without-transaction">❌ Bad: Money transfer without transaction</h4>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">from</span><span class="p">.</span><span class="nf">balance_cents</span> <span class="o">-=</span> <span class="n">amount</span>
<span class="n">from</span><span class="p">.</span><span class="nf">save!</span>

<span class="n">to</span><span class="p">.</span><span class="nf">balance_cents</span> <span class="o">+=</span> <span class="n">amount</span>
<span class="n">to</span><span class="p">.</span><span class="nf">save!</span>
</code></pre></div></div>

<h4 id="-fixed-use-transaction--locks">✅ Fixed: Use transaction + locks</h4>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">transaction</span> <span class="k">do</span>
  <span class="n">from</span> <span class="o">=</span> <span class="no">Account</span><span class="p">.</span><span class="nf">lock</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">from_id</span><span class="p">)</span>
  <span class="n">to</span>   <span class="o">=</span> <span class="no">Account</span><span class="p">.</span><span class="nf">lock</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">to_id</span><span class="p">)</span>

  <span class="k">raise</span> <span class="s2">"Insufficient funds"</span> <span class="k">if</span> <span class="n">from</span><span class="p">.</span><span class="nf">balance_cents</span> <span class="o">&lt;</span> <span class="n">amount</span>

  <span class="n">from</span><span class="p">.</span><span class="nf">balance_cents</span> <span class="o">-=</span> <span class="n">amount</span>
  <span class="n">to</span><span class="p">.</span><span class="nf">balance_cents</span>   <span class="o">+=</span> <span class="n">amount</span>

  <span class="n">from</span><span class="p">.</span><span class="nf">save!</span>
  <span class="n">to</span><span class="p">.</span><span class="nf">save!</span>
<span class="k">end</span>
</code></pre></div></div>

<hr />

<h4 id="-best-practice-emailslogging-with-after_commit">✅ Best practice: Emails/logging with <code class="language-plaintext highlighter-rouge">after_commit</code></h4>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">after_commit</span> <span class="ss">:enqueue_welcome_email</span><span class="p">,</span> <span class="ss">on: :create</span>

  <span class="kp">private</span>
  <span class="k">def</span> <span class="nf">enqueue_welcome_email</span>
    <span class="no">SendWelcomeEmailJob</span><span class="p">.</span><span class="nf">perform_later</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<hr />

<h3 id="mongodb-examples">MongoDB Examples</h3>

<h4 id="-bad-multi-document-creation-without-transaction">❌ Bad: Multi-document creation without transaction</h4>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">user</span>    <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">email: </span><span class="n">email</span><span class="p">)</span>
<span class="n">profile</span> <span class="o">=</span> <span class="no">Profile</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">user_id: </span><span class="n">user</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="ss">name: </span><span class="nb">name</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="-fixed-wrap-in-transaction">✅ Fixed: Wrap in transaction</h4>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Mongoid</span><span class="o">::</span><span class="no">Clients</span><span class="p">.</span><span class="nf">default</span><span class="p">.</span><span class="nf">with</span><span class="p">(</span><span class="ss">write: </span><span class="p">{</span> <span class="ss">w: :majority</span> <span class="p">})</span> <span class="k">do</span> <span class="o">|</span><span class="n">client</span><span class="o">|</span>
  <span class="n">session</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">start_session</span>
  <span class="n">session</span><span class="p">.</span><span class="nf">with_transaction</span> <span class="k">do</span>
    <span class="n">user</span>    <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">with</span><span class="p">(</span><span class="ss">session: </span><span class="n">session</span><span class="p">).</span><span class="nf">create!</span><span class="p">(</span><span class="ss">email: </span><span class="n">email</span><span class="p">)</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="no">Profile</span><span class="p">.</span><span class="nf">with</span><span class="p">(</span><span class="ss">session: </span><span class="n">session</span><span class="p">).</span><span class="nf">create!</span><span class="p">(</span><span class="ss">user_id: </span><span class="n">user</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="ss">name: </span><span class="nb">name</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<hr />

<h4 id="-bad-inventory-decrement-non-atomic">❌ Bad: Inventory decrement (non-atomic)</h4>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">product</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">product_id</span><span class="p">)</span>
<span class="n">product</span><span class="p">.</span><span class="nf">stock</span> <span class="o">-=</span> <span class="mi">1</span>
<span class="n">product</span><span class="p">.</span><span class="nf">save!</span>
</code></pre></div></div>

<h4 id="-fixed-use-inc-atomic-operator">✅ Fixed: Use <code class="language-plaintext highlighter-rouge">$inc</code> (atomic operator)</h4>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Product</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">id: </span><span class="n">product_id</span><span class="p">,</span> <span class="ss">:stock</span><span class="p">.</span><span class="nf">gte</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">)</span>
       <span class="p">.</span><span class="nf">find_one_and_update</span><span class="p">(</span>
         <span class="p">{</span> <span class="s1">'$inc'</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">stock: </span><span class="o">-</span><span class="mi">1</span> <span class="p">}</span> <span class="p">},</span>
         <span class="ss">return_document: :after</span>
       <span class="p">)</span>
</code></pre></div></div>

<hr />

<h4 id="-money-transfer-with-mongoid-transaction">✅ Money transfer with Mongoid transaction</h4>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">session</span><span class="p">.</span><span class="nf">with_transaction</span> <span class="k">do</span>
  <span class="n">from</span> <span class="o">=</span> <span class="no">Account</span><span class="p">.</span><span class="nf">with</span><span class="p">(</span><span class="ss">session: </span><span class="n">session</span><span class="p">).</span><span class="nf">find</span><span class="p">(</span><span class="n">from_id</span><span class="p">)</span>
  <span class="n">to</span>   <span class="o">=</span> <span class="no">Account</span><span class="p">.</span><span class="nf">with</span><span class="p">(</span><span class="ss">session: </span><span class="n">session</span><span class="p">).</span><span class="nf">find</span><span class="p">(</span><span class="n">to_id</span><span class="p">)</span>

  <span class="k">raise</span> <span class="s2">"Insufficient funds"</span> <span class="k">if</span> <span class="n">from</span><span class="p">.</span><span class="nf">balance_cents</span> <span class="o">&lt;</span> <span class="n">amount_cents</span>

  <span class="n">from</span><span class="p">.</span><span class="nf">inc</span><span class="p">(</span><span class="ss">balance_cents: </span><span class="o">-</span><span class="n">amount_cents</span><span class="p">)</span>
  <span class="n">to</span><span class="p">.</span><span class="nf">inc</span><span class="p">(</span><span class="ss">balance_cents: </span><span class="n">amount_cents</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<hr />

<h2 id="6-how-to-call-these-patterns">6. How to Call These Patterns</h2>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># PostgreSQL</span>
<span class="no">Payments</span><span class="o">::</span><span class="no">TransferFunds</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="ss">from_id: </span><span class="mi">1</span><span class="p">,</span> <span class="ss">to_id: </span><span class="mi">2</span><span class="p">,</span> <span class="ss">amount_cents: </span><span class="mi">500</span><span class="p">)</span>

<span class="c1"># MongoDB</span>
<span class="no">Users</span><span class="o">::</span><span class="no">CreateWithProfileMongo</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="ss">email: </span><span class="s2">"a@b.com"</span><span class="p">,</span> <span class="ss">name: </span><span class="s2">"Max"</span><span class="p">)</span>
<span class="no">Inventory</span><span class="o">::</span><span class="no">ReserveItemMongo</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="ss">product_id: </span><span class="no">BSON</span><span class="o">::</span><span class="no">ObjectId</span><span class="p">(</span><span class="s2">"..."</span><span class="p">))</span>
</code></pre></div></div>

<hr />

<h2 id="7-what-must-be-atomic-vsnot">7. What Must Be Atomic vs. Not</h2>

<p><strong>Atomic:</strong> - User + Profile creation - Money transfers -
Inventory/quotas - State transitions</p>

<p><strong>Not atomic:</strong> - Emails - Logging - Background jobs - Cache</p>

<hr />

<h2 id="8-quick-checklist">8. Quick Checklist</h2>

<ul class="task-list">
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Use <code class="language-plaintext highlighter-rouge">ActiveRecord::Base.transaction</code> in Postgres.\</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Use row locks (<code class="language-plaintext highlighter-rouge">lock</code>, <code class="language-plaintext highlighter-rouge">with_lock</code>) where needed.\</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Enforce invariants with DB constraints + app validations.\</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Use <code class="language-plaintext highlighter-rouge">$inc</code> for atomic updates in MongoDB.\</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Use MongoDB transactions for cross-doc operations.\</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Use <code class="language-plaintext highlighter-rouge">after_commit</code> for side-effects.\</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Keep transactions short.\</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Consider idempotency keys for payments.</li>
</ul>

<hr />

<h2 id="9-final-thoughts">9. Final Thoughts</h2>

<ul>
  <li><strong>PostgreSQL</strong> = full ACID, perfect for transactional systems.\</li>
  <li><strong>MongoDB</strong> = atomic per document, transactions available but
heavier.\</li>
  <li><strong>Rails best practice</strong> = make critical paths atomic, decouple side
effects.</li>
</ul>

<p>By following these patterns, your Rails apps will remain consistent,
reliable, and scalable.</p>

    </div>
  </div>

  <!-- Post navigation (Previous/Next) -->
  
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      
      
      
      
      

  <nav class="post-navigation">
    
      <a href="/blog/rails-console-startup-banner" class="post-nav-link post-nav-prev">
        <span class="post-nav-label">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="19" y1="12" x2="5" y2="12"/>
            <polyline points="12 19 5 12 12 5"/>
          </svg>
          Older
        </span>
        <span class="post-nav-title">A tiny Rails console banner that show app...</span>
      </a>
    
    
      <a href="/blog/containerizing-rails-dev-with-docker" class="post-nav-link post-nav-next">
        <span class="post-nav-label">
          Newer
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="5" y1="12" x2="19" y2="12"/>
            <polyline points="12 5 19 12 12 19"/>
          </svg>
        </span>
        <span class="post-nav-title">Containerizing Your Rails Development with Docker + Dev...</span>
      </a>
    
  </nav>

  <!-- Back to top button -->
  <button id="back-to-top" class="back-to-top" onclick="window.scrollTo({top: 0, behavior: 'smooth'})" title="Back to top" aria-label="Back to top">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <line x1="12" y1="19" x2="12" y2="5"/>
      <polyline points="5 12 12 5 19 12"/>
    </svg>
  </button>
</article>

<script>
  // Show/hide back-to-top button based on scroll position
  const backToTop = document.getElementById('back-to-top');
  window.addEventListener('scroll', function() {
    if (window.scrollY > 400) {
      backToTop.classList.add('visible');
    } else {
      backToTop.classList.remove('visible');
    }
  });

  // Reading progress bar
  const progressBar = document.getElementById('reading-progress');
  const article = document.querySelector('.post-article');

  window.addEventListener('scroll', function() {
    const articleTop = article.offsetTop;
    const articleHeight = article.offsetHeight;
    const windowHeight = window.innerHeight;
    const scrolled = window.scrollY - articleTop + windowHeight * 0.3;
    const progress = Math.min(Math.max(scrolled / articleHeight * 100, 0), 100);
    progressBar.style.width = progress + '%';
  });

  // Generate Table of Contents
  const postContent = document.getElementById('post-content');
  const tocList = document.getElementById('toc-list');
  const tocSidebar = document.getElementById('toc-sidebar');
  const headings = postContent.querySelectorAll('h2, h3');

  if (headings.length >= 4) {
    tocSidebar.classList.add('visible');

    headings.forEach((heading, index) => {
      // Add ID to heading if not present
      if (!heading.id) {
        heading.id = 'heading-' + index;
      }

      const li = document.createElement('li');
      li.className = 'toc-item toc-' + heading.tagName.toLowerCase();

      const a = document.createElement('a');
      a.href = '#' + heading.id;
      a.textContent = heading.textContent;
      a.className = 'toc-link';

      li.appendChild(a);
      tocList.appendChild(li);
    });

    // Highlight current section in TOC
    const tocLinks = document.querySelectorAll('.toc-link');

    const observerOptions = {
      rootMargin: '-80px 0px -70% 0px'
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          tocLinks.forEach(link => link.classList.remove('active'));
          const activeLink = document.querySelector('.toc-link[href="#' + entry.target.id + '"]');
          if (activeLink) activeLink.classList.add('active');
        }
      });
    }, observerOptions);

    headings.forEach(heading => observer.observe(heading));
  }

  // Add copy buttons and language labels to code blocks
  document.querySelectorAll('.highlight, pre').forEach(element => {
    // Skip if already wrapped or if this is a pre inside a highlight we'll process
    if (element.closest('.code-block-wrapper')) return;
    if (element.tagName === 'PRE' && element.closest('.highlight')) return;

    // Determine what to wrap: the .highlight div or standalone pre
    const highlightDiv = element.classList.contains('highlight') ? element : null;
    const pre = highlightDiv ? highlightDiv.querySelector('pre') : element;
    if (!pre) return;

    const wrapper = document.createElement('div');
    wrapper.className = 'code-block-wrapper';

    // Wrap the highlight div if exists, otherwise wrap pre
    const toWrap = highlightDiv || pre;
    toWrap.parentNode.insertBefore(wrapper, toWrap);
    wrapper.appendChild(toWrap);

    // Detect language from class
    const code = pre.querySelector('code');
    let language = '';

    // Method 1: Check code element class
    if (code && code.className) {
      const match = code.className.match(/language-(\w+)/);
      if (match) language = match[1];
    }

    // Method 2: Check highlight div class (Rouge uses class like "highlight ruby")
    if (!language && highlightDiv) {
      const classes = highlightDiv.className.split(' ');
      for (const cls of classes) {
        if (cls !== 'highlight' && cls.length > 0 && !cls.startsWith('code')) {
          language = cls;
          break;
        }
      }
    }

    // Method 3: Try to detect from code patterns
    if (!language) {
      const text = pre.textContent.trim();
      if (text.startsWith('#') && !text.startsWith('#!/')) {
        const firstLine = text.split('\n')[0];
        if (firstLine.match(/\.rb$/)) language = 'ruby';
        else if (firstLine.match(/\.py$/)) language = 'python';
        else if (firstLine.match(/\.yml$|\.yaml$/)) language = 'yaml';
      } else if (text.startsWith('//')) {
        language = 'javascript';
      } else if (text.match(/^(RSpec|describe|it|context|let)\b/)) {
        language = 'ruby';
      } else if (text.match(/^(def |class |module |require )/)) {
        language = 'ruby';
      }
    }

    // Create header with language and copy button
    const header = document.createElement('div');
    header.className = 'code-block-header';

    if (language) {
      const langLabel = document.createElement('span');
      langLabel.className = 'code-lang';
      langLabel.textContent = language;
      header.appendChild(langLabel);
    }

    const copyBtn = document.createElement('button');
    copyBtn.className = 'code-copy-btn';
    copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg><span>Copy</span>';
    copyBtn.onclick = async function() {
      const text = pre.textContent;
      try {
        await navigator.clipboard.writeText(text);
        copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg><span>Copied!</span>';
        copyBtn.classList.add('copied');
        setTimeout(() => {
          copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg><span>Copy</span>';
          copyBtn.classList.remove('copied');
        }, 2000);
      } catch (err) {
        console.error('Failed to copy:', err);
      }
    };
    header.appendChild(copyBtn);

    // Insert header at the start of wrapper (before the highlight/pre)
    wrapper.insertBefore(header, wrapper.firstChild);
  });
</script>

    </main>

    <footer class="site-footer">
      <div class="footer-content">
  <div class="footer-links">
    <a href="/feed.xml" title="RSS Feed" class="footer-icon-link">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M4 11a9 9 0 0 1 9 9"/>
        <path d="M4 4a16 16 0 0 1 16 16"/>
        <circle cx="5" cy="19" r="1"/>
      </svg>
    </a>
    <span class="footer-divider">·</span>
    <button id="theme-btn" onclick="toggleTheme()" class="theme-toggle-btn" title="Toggle theme (press T)" aria-label="Toggle theme" aria-live="polite">
      <svg class="moon-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"/>
      </svg>
      <svg class="sun-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M14.828 14.828a4 4 0 1 0 -5.656 -5.656a4 4 0 0 0 5.656 5.656z"/>
        <path d="M6.343 17.657l-1.414 1.414"/>
        <path d="M6.343 6.343l-1.414 -1.414"/>
        <path d="M17.657 6.343l1.414 -1.414"/>
        <path d="M17.657 17.657l1.414 1.414"/>
        <path d="M4 12h-2"/>
        <path d="M12 4v-2"/>
        <path d="M20 12h2"/>
        <path d="M12 20v2"/>
      </svg>
    </button>
  </div>
</div>

    </footer>
  </div>

  <script>
    // Theme toggle
    function toggleTheme() {
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

      // Use View Transitions API if available
      if (document.startViewTransition) {
        document.startViewTransition(() => {
          html.setAttribute('data-theme', newTheme);
          localStorage.setItem('theme', newTheme);
        });
      } else {
        html.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
      }
    }

    // Keyboard shortcut: press 't' to toggle theme
    document.addEventListener('keydown', function(e) {
      // Don't trigger if user is typing in an input/textarea
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
        return;
      }
      if (e.key === 't' || e.key === 'T') {
        toggleTheme();
      }
    });
  </script>
</body>
</html>
