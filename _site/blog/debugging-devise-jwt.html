<!DOCTYPE html>
<html lang="en">
<head>
  <!-- View Transitions API -->
  <meta name="view-transition" content="same-origin">
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-VLFHH5CPGM"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-VLFHH5CPGM');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <title>From 401s to JWT Bliss: Debugging Devise‑JWT on a Rails 8 API‑only App | Software Engineering consultant</title>
  
  <meta name="theme-color" content="#006cac">

  <link rel="canonical" href="http://localhost:4000/blog/debugging-devise-jwt">
  <link rel="alternate" type="application/rss+xml" title="Software Engineering consultant" href="http://localhost:4000/feed.xml" />
  <link rel="shortcut icon" type="image/png" href="http://localhost:4000/favicon.png">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Stylesheets -->
  <link rel="stylesheet" href="/assets/css/global.css">
  <link rel="stylesheet" href="/assets/css/custom.css">
  <link rel="stylesheet" href="/assets/css/typography.css">

  <meta name="description"
    content="  “Postman logs me in, cURL gives ‘You need to sign in’, and somehowI can hit endpoints with no token at all—what on earth is going on?”">
  <meta name="keywords"
    content="Software Engineering consultant, programming consultant, Ruby web development, agile Ruby development, Ruby on Rails web design, RoR consulting, Ruby on Rails service, RoR consultant, Ruby on Rails NYC, Ruby on Rails expertise, web agency, ios application development, mobile, api, frontend, backend, development, software engineer partner, sf developer, sf ruby on rails, berling ruby consultant, london consultant">
  <meta name="author" content="Max Lukin">

  <!-- Theme initialization - prevent flash -->
  <script>
    (function() {
      const savedTheme = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const theme = savedTheme || (prefersDark ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>From 401s to JWT Bliss: Debugging Devise‑JWT on a Rails 8 API‑only App | Software Engineering consultant</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="From 401s to JWT Bliss: Debugging Devise‑JWT on a Rails 8 API‑only App" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A step‑by‑step log of the dead‑ends and the final, tidy setup— complete with code snippets, failure‑app JSON errors, and cURL recipes." />
<meta property="og:description" content="A step‑by‑step log of the dead‑ends and the final, tidy setup— complete with code snippets, failure‑app JSON errors, and cURL recipes." />
<link rel="canonical" href="http://localhost:4000/blog/debugging-devise-jwt" />
<meta property="og:url" content="http://localhost:4000/blog/debugging-devise-jwt" />
<meta property="og:site_name" content="Software Engineering consultant" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-07-24T00:00:00+05:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="From 401s to JWT Bliss: Debugging Devise‑JWT on a Rails 8 API‑only App" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-07-24T00:00:00+05:00","datePublished":"2025-07-24T00:00:00+05:00","description":"A step‑by‑step log of the dead‑ends and the final, tidy setup— complete with code snippets, failure‑app JSON errors, and cURL recipes.","headline":"From 401s to JWT Bliss: Debugging Devise‑JWT on a Rails 8 API‑only App","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/blog/debugging-devise-jwt"},"url":"http://localhost:4000/blog/debugging-devise-jwt"}</script>
<!-- End Jekyll SEO tag -->

</head>


<body>
  <!-- Main content wrapper -->
  <div class="main-wrapper centered">
    <main>
      <!-- Reading progress bar -->
<div class="reading-progress" id="reading-progress"></div>

<article class="post-article">
  <!-- Back navigation -->
  <a href="/blog" class="back-home">
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M19 20H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v1m2 13a2 2 0 0 1-2-2V7m2 13a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-2m-4-3H9M7 16h6M7 12h10"/>
    </svg>
    <span>Blog</span>
  </a>

  <!-- Post header -->
  <header class="post-header">
    <h1 class="post-title">From 401s to JWT Bliss: Debugging Devise‑JWT on a Rails 8 API‑only App</h1>
    <div class="post-meta">
      <time datetime="2025-07-24T00:00:00+05:00">Jul 24, 2025</time>
      
      
      
      <span>· 9 min read</span>
      
      
        <span class="post-tags"><a href="/search?q=rails" class="tag">rails</a><a href="/search?q=devise" class="tag">devise</a><a href="/search?q=jwt" class="tag">jwt</a><a href="/search?q=api" class="tag">api</a><a href="/search?q=debugging" class="tag">debugging</a></span>
      
    </div>
  </header>

  <div class="post-body">
    <!-- Table of Contents (generated by JS for posts with 4+ headings) -->
    <aside class="toc-sidebar" id="toc-sidebar">
      <nav class="toc" id="toc">
        <div class="toc-title">Contents</div>
        <ul class="toc-list" id="toc-list"></ul>
      </nav>
    </aside>

    <!-- Post content -->
    <div class="prose post-content" id="post-content">
      <blockquote>
  <p><em>“Postman logs me in, cURL gives ‘You need to sign in’, and somehow
I can hit endpoints with <strong>no</strong> token at all—what on earth is going on?”</em></p>
</blockquote>

<p>I spent two days chasing those puzzles.
Below is everything I learned, condensed into one checklist you can drop
into your own Rails 8 API‑only project.</p>

<h2 id="table-of-contents">Table of contents</h2>

<ol>
  <li><a href="#1-gemfile--migration">Gemfile &amp; migration</a></li>
  <li><a href="#2-user-model-jtirevocation">User model with <code class="language-plaintext highlighter-rouge">JTIMatcher</code></a></li>
  <li><a href="#3-devise-initializer">JWT‑aware <code class="language-plaintext highlighter-rouge">devise.rb</code></a></li>
  <li><a href="#4-json-failure-app">Failure app for uniform 401 JSON</a></li>
  <li><a href="#5-single-devisefor-line">Routes in <em>one</em> line</a></li>
  <li><a href="#6-authenticate-user">ApplicationController guard</a></li>
  <li><a href="#7-controllers">Custom Sessions &amp; Registrations controllers</a></li>
  <li><a href="#8-curl-cookbook">cURL cookbook</a></li>
  <li><a href="#9-pitfalls">Common pitfalls &amp; their fixes</a></li>
  <li><a href="#10-rspec">RSpec tests</a></li>
</ol>

<hr />

<h2 id="1gemfilemigration-">1  Gemfile &amp; migration <a name="1-gemfile--migration"></a></h2>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Gemfile</span>
<span class="n">gem</span> <span class="s1">'devise'</span>
<span class="n">gem</span> <span class="s1">'devise-jwt'</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bundle <span class="nb">install</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">db/migrate/xxxx_add_jti_to_users.rb</code></p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">AddJtiToUsers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.1</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:jti</span><span class="p">,</span> <span class="ss">:string</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span><span class="p">,</span> <span class="ss">default: </span><span class="o">-&gt;</span> <span class="p">{</span> <span class="s1">'gen_random_uuid()'</span> <span class="p">}</span>
    <span class="n">add_index</span>  <span class="ss">:users</span><span class="p">,</span> <span class="ss">:jti</span><span class="p">,</span> <span class="ss">unique: </span><span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rails db:migrate
</code></pre></div></div>

<hr />

<h2 id="2user-model-jti-revocation-">2  User model + JTI revocation <a name="2-user-model-jtirevocation"></a></h2>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">devise</span> <span class="ss">:database_authenticatable</span><span class="p">,</span> <span class="ss">:registerable</span><span class="p">,</span>
         <span class="ss">:jwt_authenticatable</span><span class="p">,</span> <span class="ss">jwt_revocation_strategy: </span><span class="nb">self</span>

  <span class="kp">include</span> <span class="no">Devise</span><span class="o">::</span><span class="no">JWT</span><span class="o">::</span><span class="no">RevocationStrategies</span><span class="o">::</span><span class="no">JTIMatcher</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">jwt_revoked?</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
    <span class="n">user</span><span class="p">.</span><span class="nf">jti</span> <span class="o">!=</span> <span class="n">payload</span><span class="p">[</span><span class="s1">'jti'</span><span class="p">]</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">revoke_jwt</span><span class="p">(</span><span class="n">_payload</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
    <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">debug</span> <span class="s1">'revoke_jwt TRIGGERED'</span>
    <span class="n">user</span><span class="p">.</span><span class="nf">update_column</span><span class="p">(</span><span class="ss">:jti</span><span class="p">,</span> <span class="no">SecureRandom</span><span class="p">.</span><span class="nf">uuid</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<hr />

<h2 id="3devise-initializer-">3  Devise initializer <a name="3-devise-initializer"></a></h2>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Devise</span><span class="p">.</span><span class="nf">setup</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">skip_session_storage</span> <span class="o">=</span> <span class="p">[</span><span class="ss">:http_auth</span><span class="p">,</span> <span class="ss">:params_auth</span><span class="p">,</span> <span class="ss">:token_auth</span><span class="p">,</span> <span class="ss">:cookie</span><span class="p">]</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">navigational_formats</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="n">config</span><span class="p">.</span><span class="nf">jwt</span> <span class="k">do</span> <span class="o">|</span><span class="n">jwt</span><span class="o">|</span>
    <span class="n">jwt</span><span class="p">.</span><span class="nf">secret</span> <span class="o">=</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">credentials</span><span class="p">.</span><span class="nf">devise_jwt_secret_key</span>
    <span class="n">jwt</span><span class="p">.</span><span class="nf">dispatch_requests</span> <span class="o">=</span> <span class="p">[</span>
      <span class="p">[</span><span class="s1">'POST'</span><span class="p">,</span> <span class="sr">%r{^/api/v1/sessions/sign_in$}</span><span class="p">],</span>
      <span class="p">[</span><span class="s1">'POST'</span><span class="p">,</span> <span class="sr">%r{^/api/v1/users$}</span><span class="p">]</span>
    <span class="p">]</span>
    <span class="n">jwt</span><span class="p">.</span><span class="nf">revocation_requests</span> <span class="o">=</span> <span class="p">[</span>
      <span class="p">[</span><span class="s1">'DELETE'</span><span class="p">,</span> <span class="sr">%r{^/api/v1/sessions/sign_out$}</span><span class="p">]</span>
    <span class="p">]</span>
    <span class="n">jwt</span><span class="p">.</span><span class="nf">expiration_time</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="nf">day</span><span class="p">.</span><span class="nf">to_i</span>
  <span class="k">end</span>

  <span class="n">config</span><span class="p">.</span><span class="nf">warden</span> <span class="k">do</span> <span class="o">|</span><span class="n">manager</span><span class="o">|</span>
    <span class="n">manager</span><span class="p">.</span><span class="nf">failure_app</span> <span class="o">=</span> <span class="no">ApiFailureApp</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<hr />

<h2 id="4json-failure-app-">4  JSON failure app <a name="4-json-failure-app"></a></h2>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ApiFailureApp</span> <span class="o">&lt;</span> <span class="no">Devise</span><span class="o">::</span><span class="no">FailureApp</span>
  <span class="k">def</span> <span class="nf">respond</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">status</span>        <span class="o">=</span> <span class="mi">401</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">content_type</span>  <span class="o">=</span> <span class="s1">'application/json'</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">response_body</span> <span class="o">=</span> <span class="p">{</span>
      <span class="ss">error: </span><span class="p">{</span>
        <span class="ss">code:    </span><span class="s1">'UNAUTHORIZED'</span><span class="p">,</span>
        <span class="ss">message: </span><span class="s1">'Invalid or missing JWT token'</span>
      <span class="p">}</span>
    <span class="p">}.</span><span class="nf">to_json</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<hr />

<h2 id="5singledevise_forlinekeeps-mappinguser-">5  Single <code class="language-plaintext highlighter-rouge">devise_for</code> line (keeps mapping <code class="language-plaintext highlighter-rouge">:user</code>) <a name="5-single-devisefor-line"></a></h2>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="n">devise_for</span> <span class="ss">:users</span><span class="p">,</span>
             <span class="ss">path: </span><span class="s1">'api/v1'</span><span class="p">,</span>
             <span class="ss">path_names: </span><span class="p">{</span>
               <span class="ss">sign_in:  </span><span class="s1">'sessions/sign_in'</span><span class="p">,</span>
               <span class="ss">sign_out: </span><span class="s1">'sessions/sign_out'</span><span class="p">,</span>
               <span class="ss">registration: </span><span class="s1">'users'</span>
             <span class="p">},</span>
             <span class="ss">controllers: </span><span class="p">{</span>
               <span class="ss">sessions:      </span><span class="s1">'api/v1/sessions'</span><span class="p">,</span>
               <span class="ss">registrations: </span><span class="s1">'api/v1/registrations'</span>
             <span class="p">}</span>

  <span class="n">namespace</span> <span class="ss">:api</span> <span class="k">do</span>
    <span class="n">namespace</span> <span class="ss">:v1</span> <span class="k">do</span>
      <span class="n">resources</span> <span class="ss">:users</span>
      <span class="c1"># … other resources …</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Run <code class="language-plaintext highlighter-rouge">rails r 'puts Devise.mappings.keys'</code> → <code class="language-plaintext highlighter-rouge">[:user]</code>.</p>

<hr />

<h2 id="6applicationwide-guard-">6  Application‑wide guard <a name="6-authenticate-user"></a></h2>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">API</span>
  <span class="kp">include</span> <span class="no">Devise</span><span class="o">::</span><span class="no">Controllers</span><span class="o">::</span><span class="no">Helpers</span>

  <span class="n">before_action</span> <span class="ss">:authenticate_user!</span><span class="p">,</span> <span class="ss">unless: :devise_controller?</span>

  <span class="n">rescue_from</span> <span class="no">JWT</span><span class="o">::</span><span class="no">DecodeError</span><span class="p">,</span> <span class="ss">with: :render_unauthorized</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">render_unauthorized</span><span class="p">(</span><span class="n">_e</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="p">{</span> <span class="ss">error: </span><span class="p">{</span> <span class="ss">code: </span><span class="s1">'UNAUTHORIZED'</span><span class="p">,</span>
                            <span class="ss">message: </span><span class="s1">'Invalid or missing JWT token'</span> <span class="p">}</span> <span class="p">},</span>
           <span class="ss">status: :unauthorized</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<hr />

<h2 id="7controllers-">7  Controllers <a name="7-controllers"></a></h2>

<h3 id="sessions">Sessions</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">Api</span>
  <span class="k">module</span> <span class="nn">V1</span>
    <span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">Devise</span><span class="o">::</span><span class="no">SessionsController</span>
      <span class="n">respond_to</span> <span class="ss">:json</span>
      <span class="n">wrap_parameters</span> <span class="kp">false</span>
      <span class="n">skip_before_action</span> <span class="ss">:verify_signed_out_user</span><span class="p">,</span> <span class="ss">only: :destroy</span>

      <span class="k">def</span> <span class="nf">respond_with</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">_opts</span> <span class="o">=</span> <span class="p">{})</span>
        <span class="n">render</span> <span class="ss">json: </span><span class="p">{</span>
          <span class="ss">message: </span><span class="s1">'Logged in successfully.'</span><span class="p">,</span>
          <span class="ss">user:    </span><span class="p">{</span> <span class="ss">id: </span><span class="n">resource</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="ss">email: </span><span class="n">resource</span><span class="p">.</span><span class="nf">email</span> <span class="p">}</span>
        <span class="p">},</span> <span class="ss">status: :ok</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">respond_to_on_destroy</span>
        <span class="n">render</span> <span class="ss">json: </span><span class="p">{</span> <span class="ss">status: </span><span class="mi">200</span><span class="p">,</span> <span class="ss">message: </span><span class="s1">'Logged out successfully.'</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="registrations-no-autologin">Registrations (no auto‑login)</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">Api</span>
  <span class="k">module</span> <span class="nn">V1</span>
    <span class="k">class</span> <span class="nc">RegistrationsController</span> <span class="o">&lt;</span> <span class="no">Devise</span><span class="o">::</span><span class="no">RegistrationsController</span>
      <span class="n">respond_to</span> <span class="ss">:json</span>
      <span class="n">wrap_parameters</span> <span class="kp">false</span>

      <span class="k">def</span> <span class="nf">sign_up</span><span class="p">(</span><span class="n">_scope</span><span class="p">,</span> <span class="n">_resource</span><span class="p">);</span> <span class="k">end</span> <span class="c1"># skip auto-login</span>

      <span class="kp">private</span>

      <span class="k">def</span> <span class="nf">respond_with</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">_opts</span> <span class="o">=</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="n">resource</span><span class="p">.</span><span class="nf">persisted?</span>
          <span class="n">render</span> <span class="ss">json: </span><span class="p">{</span>
            <span class="ss">message: </span><span class="s1">'Signed up successfully.'</span><span class="p">,</span>
            <span class="ss">user:    </span><span class="p">{</span> <span class="ss">email: </span><span class="n">resource</span><span class="p">.</span><span class="nf">email</span> <span class="p">}</span>
          <span class="p">},</span> <span class="ss">status: :ok</span>
        <span class="k">else</span>
          <span class="n">render</span> <span class="ss">json: </span><span class="p">{</span> <span class="ss">errors: </span><span class="n">resource</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">full_messages</span> <span class="p">},</span>
                 <span class="ss">status: :unprocessable_entity</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">sign_up_params</span>
        <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
              <span class="p">.</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<hr />

<h2 id="8curl-cookbook-">8  cURL cookbook <a name="8-curl-cookbook"></a></h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Sign‑up</span>
curl <span class="nt">-X</span> POST http://localhost:3000/api/v1/users   <span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span>   <span class="nt">-d</span> <span class="s1">'{"user":{"email":"alice@example.com",
               "password":"password123",
               "password_confirmation":"password123"}}'</span>

<span class="c"># Sign‑in</span>
curl <span class="nt">-X</span> POST http://localhost:3000/api/v1/sessions/sign_in   <span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span>   <span class="nt">-d</span> <span class="s1">'{"user":{"email":"alice@example.com","password":"password123"}}'</span> <span class="nt">-i</span>
<span class="c"># (copy token from Authorization header)</span>

<span class="c"># Protected endpoint</span>
curl http://localhost:3000/api/v1/users   <span class="nt">-H</span> <span class="s2">"Authorization: Bearer &lt;TOKEN&gt;"</span>

<span class="c"># Sign‑out</span>
curl <span class="nt">-X</span> DELETE http://localhost:3000/api/v1/sessions/sign_out   <span class="nt">-H</span> <span class="s2">"Authorization: Bearer &lt;TOKEN&gt;"</span>

<span class="c"># Token now invalid</span>
curl http://localhost:3000/api/v1/users   <span class="nt">-H</span> <span class="s2">"Authorization: Bearer &lt;TOKEN&gt;"</span>
</code></pre></div></div>

<hr />

<h2 id="9pitfalls--fixes-">9  Pitfalls &amp; fixes <a name="9-pitfalls"></a></h2>

<ul>
  <li>
    <p><strong>Mapping key mismatch</strong> → check <code class="language-plaintext highlighter-rouge">Devise.mappings.keys</code>.
<code class="language-plaintext highlighter-rouge">[:user]</code> means helpers are <code class="language-plaintext highlighter-rouge">authenticate_user!</code>.
Anything else means you must call <code class="language-plaintext highlighter-rouge">authenticate_&lt;scope&gt;_user!</code>.</p>
  </li>
  <li>
    <p><strong>Postman works, cURL fails</strong> → Postman was sending a cookie session.
Fix: <code class="language-plaintext highlighter-rouge">skip_session_storage = [:cookie]</code>.</p>
  </li>
  <li>
    <p><strong>Double‑slash paths block JWT dispatch</strong> → use <code class="language-plaintext highlighter-rouge">path: 'api/v1'</code>
(no leading <code class="language-plaintext highlighter-rouge">/</code>) and update regexes.</p>
  </li>
  <li>
    <p><strong>“Not enough or too many segments”</strong> → handled by failure app +
<code class="language-plaintext highlighter-rouge">rescue_from JWT::DecodeError</code>.</p>
  </li>
</ul>

<p>And that’s all: Rails 8 + Devise + JWT, with uniform JSON errors,
cookie‑free, and cURL‑/Postman‑compatible.</p>

<h2 id="10rspec-test-suite-">10  RSpec test suite <a name="10-rspec"></a></h2>

<h3 id="1factory">1 Factory</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># spec/factories/users.rb</span>
<span class="no">FactoryBot</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
    <span class="n">email</span>    <span class="p">{</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Internet</span><span class="p">.</span><span class="nf">unique</span><span class="p">.</span><span class="nf">email</span> <span class="p">}</span>
    <span class="n">password</span> <span class="p">{</span> <span class="s1">'password123'</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="2spec-helper-for-jwt-header">2 Spec helper for JWT header</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># spec/support/jwt_helpers.rb</span>
<span class="k">module</span> <span class="nn">JwtHelpers</span>
  <span class="k">def</span> <span class="nf">auth_header_for</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">post</span> <span class="s1">'/api/v1/sessions/sign_in'</span><span class="p">,</span>
         <span class="ss">params: </span><span class="p">{</span> <span class="ss">user: </span><span class="p">{</span> <span class="ss">email: </span><span class="n">user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="ss">password: </span><span class="s1">'password123'</span> <span class="p">}</span> <span class="p">}.</span><span class="nf">to_json</span><span class="p">,</span>
         <span class="ss">headers: </span><span class="p">{</span> <span class="s1">'Content-Type'</span> <span class="o">=&gt;</span> <span class="s1">'application/json'</span> <span class="p">}</span>

    <span class="n">token</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Authorization'</span><span class="p">].</span><span class="nf">split</span><span class="p">.</span><span class="nf">last</span>
    <span class="p">{</span> <span class="s1">'Authorization'</span> <span class="o">=&gt;</span> <span class="s2">"Bearer </span><span class="si">#{</span><span class="n">token</span><span class="si">}</span><span class="s2">"</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">configure</span> <span class="p">{</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span> <span class="n">c</span><span class="p">.</span><span class="nf">include</span> <span class="no">JwtHelpers</span><span class="p">,</span> <span class="ss">type: :request</span> <span class="p">}</span>
</code></pre></div></div>

<h3 id="31request-specs">3.1 Request specs</h3>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># spec/requests/auth_flow_spec.rb</span>
<span class="nb">require</span> <span class="s1">'rails_helper'</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="s1">'Auth flow'</span><span class="p">,</span> <span class="ss">type: :request</span> <span class="k">do</span>
  <span class="n">describe</span> <span class="s1">'sign‑up → sign‑in → protected → sign‑out'</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:user_attrs</span><span class="p">)</span> <span class="k">do</span>
      <span class="p">{</span> <span class="ss">email: </span><span class="s1">'alice@example.com'</span><span class="p">,</span>
        <span class="ss">password: </span><span class="s1">'password123'</span><span class="p">,</span>
        <span class="ss">password_confirmation: </span><span class="s1">'password123'</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'issues and revokes JWT'</span> <span class="k">do</span>
      <span class="c1"># 1) sign‑up (no auto‑login)</span>
      <span class="n">post</span> <span class="s1">'/api/v1/users'</span><span class="p">,</span>
           <span class="ss">params: </span><span class="p">{</span> <span class="ss">user: </span><span class="n">user_attrs</span> <span class="p">}.</span><span class="nf">to_json</span><span class="p">,</span>
           <span class="ss">headers: </span><span class="p">{</span> <span class="s1">'Content-Type'</span> <span class="o">=&gt;</span> <span class="s1">'application/json'</span> <span class="p">}</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_http_status</span><span class="p">(</span><span class="ss">:ok</span><span class="p">)</span>

      <span class="c1"># 2) sign‑in (get token in header)</span>
      <span class="n">post</span> <span class="s1">'/api/v1/sessions/sign_in'</span><span class="p">,</span>
           <span class="ss">params: </span><span class="p">{</span> <span class="ss">user: </span><span class="n">user_attrs</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">)</span> <span class="p">}.</span><span class="nf">to_json</span><span class="p">,</span>
           <span class="ss">headers: </span><span class="p">{</span> <span class="s1">'Content-Type'</span> <span class="o">=&gt;</span> <span class="s1">'application/json'</span> <span class="p">}</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_http_status</span><span class="p">(</span><span class="ss">:ok</span><span class="p">)</span>
      <span class="n">token</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Authorization'</span><span class="p">].</span><span class="nf">split</span><span class="p">.</span><span class="nf">last</span>
      <span class="n">auth</span>  <span class="o">=</span> <span class="p">{</span> <span class="s1">'Authorization'</span> <span class="o">=&gt;</span> <span class="s2">"Bearer </span><span class="si">#{</span><span class="n">token</span><span class="si">}</span><span class="s2">"</span> <span class="p">}</span>

      <span class="c1"># 3) hit protected endpoint</span>
      <span class="n">get</span> <span class="s1">'/api/v1/users'</span><span class="p">,</span> <span class="ss">headers: </span><span class="n">auth</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_http_status</span><span class="p">(</span><span class="ss">:ok</span><span class="p">)</span>

      <span class="c1"># 4) sign‑out</span>
      <span class="n">delete</span> <span class="s1">'/api/v1/sessions/sign_out'</span><span class="p">,</span> <span class="ss">headers: </span><span class="n">auth</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_http_status</span><span class="p">(</span><span class="ss">:ok</span><span class="p">)</span>

      <span class="c1"># 5) token should now be invalid</span>
      <span class="n">get</span> <span class="s1">'/api/v1/users'</span><span class="p">,</span> <span class="ss">headers: </span><span class="n">auth</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_http_status</span><span class="p">(</span><span class="ss">:unauthorized</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="32-bad-token-spec">3.2 Bad token spec</h3>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'rails_helper'</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="s1">'JWT failure cases'</span><span class="p">,</span> <span class="ss">type: :request</span> <span class="k">do</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:headers</span><span class="p">)</span> <span class="p">{</span> <span class="p">{</span> <span class="s1">'Authorization'</span> <span class="o">=&gt;</span> <span class="s1">'Bearer bad.token'</span> <span class="p">}</span> <span class="p">}</span>

  <span class="n">it</span> <span class="s1">'rejects malformed token'</span> <span class="k">do</span>
    <span class="n">get</span> <span class="s1">'/api/v1/users'</span><span class="p">,</span> <span class="ss">headers: </span><span class="n">headers</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_http_status</span><span class="p">(</span><span class="ss">:unauthorized</span><span class="p">)</span>
    <span class="n">body</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">body</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="s1">'error'</span><span class="p">,</span> <span class="s1">'code'</span><span class="p">)).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">'UNAUTHORIZED'</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="4model-spec">4 Model spec</h3>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># spec/models/user_spec.rb</span>
<span class="nb">require</span> <span class="s1">'rails_helper'</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">User</span><span class="p">,</span> <span class="ss">type: :model</span> <span class="k">do</span>
  <span class="n">describe</span> <span class="s1">'.revoke_jwt / .jwt_revoked?'</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:old_jti</span><span class="p">)</span> <span class="p">{</span> <span class="n">user</span><span class="p">.</span><span class="nf">jti</span> <span class="p">}</span>

    <span class="n">it</span> <span class="s1">'marks existing token invalid by changing jti'</span> <span class="k">do</span>
      <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">'jti'</span> <span class="o">=&gt;</span> <span class="n">old_jti</span> <span class="p">}</span>
      <span class="n">described_class</span><span class="p">.</span><span class="nf">revoke_jwt</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="nf">reload</span><span class="p">.</span><span class="nf">jti</span><span class="p">).</span><span class="nf">not_to</span> <span class="n">eq</span><span class="p">(</span><span class="n">old_jti</span><span class="p">)</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">described_class</span><span class="p">.</span><span class="nf">jwt_revoked?</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">user</span><span class="p">)).</span><span class="nf">to</span> <span class="n">be</span> <span class="kp">true</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

</code></pre></div></div>

    </div>
  </div>

  <!-- Post navigation (Previous/Next) -->
  
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      
      
      
      
      

  <nav class="post-navigation">
    
      <a href="/blog/minimalism-war-family-and-lessons" class="post-nav-link post-nav-prev">
        <span class="post-nav-label">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="19" y1="12" x2="5" y2="12"/>
            <polyline points="12 19 5 12 12 5"/>
          </svg>
          Older
        </span>
        <span class="post-nav-title">Minimalism, Family, war and lessons</span>
      </a>
    
    
      <a href="/blog/securing-jwt-with-rsa-keys" class="post-nav-link post-nav-next">
        <span class="post-nav-label">
          Newer
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="5" y1="12" x2="19" y2="12"/>
            <polyline points="12 5 19 12 12 19"/>
          </svg>
        </span>
        <span class="post-nav-title">Securing JWT Tokens in Rails API with Devise,...</span>
      </a>
    
  </nav>

  <!-- Back to top button -->
  <button id="back-to-top" class="back-to-top" onclick="window.scrollTo({top: 0, behavior: 'smooth'})" title="Back to top" aria-label="Back to top">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <line x1="12" y1="19" x2="12" y2="5"/>
      <polyline points="5 12 12 5 19 12"/>
    </svg>
  </button>
</article>

<script>
  // Show/hide back-to-top button based on scroll position
  const backToTop = document.getElementById('back-to-top');
  window.addEventListener('scroll', function() {
    if (window.scrollY > 400) {
      backToTop.classList.add('visible');
    } else {
      backToTop.classList.remove('visible');
    }
  });

  // Reading progress bar
  const progressBar = document.getElementById('reading-progress');
  const article = document.querySelector('.post-article');

  window.addEventListener('scroll', function() {
    const articleTop = article.offsetTop;
    const articleHeight = article.offsetHeight;
    const windowHeight = window.innerHeight;
    const scrolled = window.scrollY - articleTop + windowHeight * 0.3;
    const progress = Math.min(Math.max(scrolled / articleHeight * 100, 0), 100);
    progressBar.style.width = progress + '%';
  });

  // Generate Table of Contents
  const postContent = document.getElementById('post-content');
  const tocList = document.getElementById('toc-list');
  const tocSidebar = document.getElementById('toc-sidebar');
  const headings = postContent.querySelectorAll('h2, h3');

  if (headings.length >= 4) {
    tocSidebar.classList.add('visible');

    headings.forEach((heading, index) => {
      // Add ID to heading if not present
      if (!heading.id) {
        heading.id = 'heading-' + index;
      }

      const li = document.createElement('li');
      li.className = 'toc-item toc-' + heading.tagName.toLowerCase();

      const a = document.createElement('a');
      a.href = '#' + heading.id;
      a.textContent = heading.textContent;
      a.className = 'toc-link';

      li.appendChild(a);
      tocList.appendChild(li);
    });

    // Highlight current section in TOC
    const tocLinks = document.querySelectorAll('.toc-link');

    const observerOptions = {
      rootMargin: '-80px 0px -70% 0px'
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          tocLinks.forEach(link => link.classList.remove('active'));
          const activeLink = document.querySelector('.toc-link[href="#' + entry.target.id + '"]');
          if (activeLink) activeLink.classList.add('active');
        }
      });
    }, observerOptions);

    headings.forEach(heading => observer.observe(heading));
  }

  // Add copy buttons and language labels to code blocks
  document.querySelectorAll('.highlight, pre').forEach(element => {
    // Skip if already wrapped or if this is a pre inside a highlight we'll process
    if (element.closest('.code-block-wrapper')) return;
    if (element.tagName === 'PRE' && element.closest('.highlight')) return;

    // Determine what to wrap: the .highlight div or standalone pre
    const highlightDiv = element.classList.contains('highlight') ? element : null;
    const pre = highlightDiv ? highlightDiv.querySelector('pre') : element;
    if (!pre) return;

    const wrapper = document.createElement('div');
    wrapper.className = 'code-block-wrapper';

    // Wrap the highlight div if exists, otherwise wrap pre
    const toWrap = highlightDiv || pre;
    toWrap.parentNode.insertBefore(wrapper, toWrap);
    wrapper.appendChild(toWrap);

    // Detect language from class
    const code = pre.querySelector('code');
    let language = '';

    // Method 1: Check code element class
    if (code && code.className) {
      const match = code.className.match(/language-(\w+)/);
      if (match) language = match[1];
    }

    // Method 2: Check highlight div class (Rouge uses class like "highlight ruby")
    if (!language && highlightDiv) {
      const classes = highlightDiv.className.split(' ');
      for (const cls of classes) {
        if (cls !== 'highlight' && cls.length > 0 && !cls.startsWith('code')) {
          language = cls;
          break;
        }
      }
    }

    // Method 3: Try to detect from code patterns
    if (!language) {
      const text = pre.textContent.trim();
      if (text.startsWith('#') && !text.startsWith('#!/')) {
        const firstLine = text.split('\n')[0];
        if (firstLine.match(/\.rb$/)) language = 'ruby';
        else if (firstLine.match(/\.py$/)) language = 'python';
        else if (firstLine.match(/\.yml$|\.yaml$/)) language = 'yaml';
      } else if (text.startsWith('//')) {
        language = 'javascript';
      } else if (text.match(/^(RSpec|describe|it|context|let)\b/)) {
        language = 'ruby';
      } else if (text.match(/^(def |class |module |require )/)) {
        language = 'ruby';
      }
    }

    // Create header with language and copy button
    const header = document.createElement('div');
    header.className = 'code-block-header';

    if (language) {
      const langLabel = document.createElement('span');
      langLabel.className = 'code-lang';
      langLabel.textContent = language;
      header.appendChild(langLabel);
    }

    const copyBtn = document.createElement('button');
    copyBtn.className = 'code-copy-btn';
    copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg><span>Copy</span>';
    copyBtn.onclick = async function() {
      const text = pre.textContent;
      try {
        await navigator.clipboard.writeText(text);
        copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg><span>Copied!</span>';
        copyBtn.classList.add('copied');
        setTimeout(() => {
          copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg><span>Copy</span>';
          copyBtn.classList.remove('copied');
        }, 2000);
      } catch (err) {
        console.error('Failed to copy:', err);
      }
    };
    header.appendChild(copyBtn);

    // Insert header at the start of wrapper (before the highlight/pre)
    wrapper.insertBefore(header, wrapper.firstChild);
  });
</script>

    </main>

    <footer class="site-footer">
      <div class="footer-content">
  <div class="footer-links">
    <a href="/feed.xml" title="RSS Feed" class="footer-icon-link">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M4 11a9 9 0 0 1 9 9"/>
        <path d="M4 4a16 16 0 0 1 16 16"/>
        <circle cx="5" cy="19" r="1"/>
      </svg>
    </a>
    <span class="footer-divider">·</span>
    <button id="theme-btn" onclick="toggleTheme()" class="theme-toggle-btn" title="Toggle theme (press T)" aria-label="Toggle theme" aria-live="polite">
      <svg class="moon-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"/>
      </svg>
      <svg class="sun-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M14.828 14.828a4 4 0 1 0 -5.656 -5.656a4 4 0 0 0 5.656 5.656z"/>
        <path d="M6.343 17.657l-1.414 1.414"/>
        <path d="M6.343 6.343l-1.414 -1.414"/>
        <path d="M17.657 6.343l1.414 -1.414"/>
        <path d="M17.657 17.657l1.414 1.414"/>
        <path d="M4 12h-2"/>
        <path d="M12 4v-2"/>
        <path d="M20 12h2"/>
        <path d="M12 20v2"/>
      </svg>
    </button>
  </div>
</div>

    </footer>
  </div>

  <script>
    // Theme toggle
    function toggleTheme() {
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

      // Use View Transitions API if available
      if (document.startViewTransition) {
        document.startViewTransition(() => {
          html.setAttribute('data-theme', newTheme);
          localStorage.setItem('theme', newTheme);
        });
      } else {
        html.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
      }
    }

    // Keyboard shortcut: press 't' to toggle theme
    document.addEventListener('keydown', function(e) {
      // Don't trigger if user is typing in an input/textarea
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
        return;
      }
      if (e.key === 't' || e.key === 'T') {
        toggleTheme();
      }
    });
  </script>
</body>
</html>
