<!DOCTYPE html>
<html lang="en">
<head>
  <!-- View Transitions API -->
  <meta name="view-transition" content="same-origin">
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-VLFHH5CPGM"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-VLFHH5CPGM');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <title>Mastering ActiveSupport::LogSubscriber (Rails 8+): JSON logs, per-tenant routing, and production patterns | Software Engineering consultant</title>
  
  <meta name="theme-color" content="#006cac">

  <link rel="canonical" href="http://localhost:4000/blog/mastering-activesupport-logsubscriber-rails8">
  <link rel="alternate" type="application/rss+xml" title="Software Engineering consultant" href="http://localhost:4000/feed.xml" />
  <link rel="shortcut icon" type="image/png" href="http://localhost:4000/favicon.png">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Stylesheets -->
  <link rel="stylesheet" href="/assets/css/global.css">
  <link rel="stylesheet" href="/assets/css/custom.css">
  <link rel="stylesheet" href="/assets/css/typography.css">

  <meta name="description"
    content="This post is a deep dive into ActiveSupport::LogSubscriber. You’ll get production-ready patterns for:  Structured JSON logs that are ingestion-friendly (ELK,...">
  <meta name="keywords"
    content="Software Engineering consultant, programming consultant, Ruby web development, agile Ruby development, Ruby on Rails web design, RoR consulting, Ruby on Rails service, RoR consultant, Ruby on Rails NYC, Ruby on Rails expertise, web agency, ios application development, mobile, api, frontend, backend, development, software engineer partner, sf developer, sf ruby on rails, berling ruby consultant, london consultant">
  <meta name="author" content="Max Lukin">

  <!-- Theme initialization - prevent flash -->
  <script>
    (function() {
      const savedTheme = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const theme = savedTheme || (prefersDark ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Mastering ActiveSupport::LogSubscriber (Rails 8+): JSON logs, per-tenant routing, and production patterns | Software Engineering consultant</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Mastering ActiveSupport::LogSubscriber (Rails 8+): JSON logs, per-tenant routing, and production patterns" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A practical, production-grade guide to ActiveSupport::LogSubscriber for Rails 8+: structured JSON logs, log tags, and per-tenant log routing." />
<meta property="og:description" content="A practical, production-grade guide to ActiveSupport::LogSubscriber for Rails 8+: structured JSON logs, log tags, and per-tenant log routing." />
<link rel="canonical" href="http://localhost:4000/blog/mastering-activesupport-logsubscriber-rails8" />
<meta property="og:url" content="http://localhost:4000/blog/mastering-activesupport-logsubscriber-rails8" />
<meta property="og:site_name" content="Software Engineering consultant" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-08-11T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Mastering ActiveSupport::LogSubscriber (Rails 8+): JSON logs, per-tenant routing, and production patterns" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-08-11T00:00:00+00:00","datePublished":"2025-08-11T00:00:00+00:00","description":"A practical, production-grade guide to ActiveSupport::LogSubscriber for Rails 8+: structured JSON logs, log tags, and per-tenant log routing.","headline":"Mastering ActiveSupport::LogSubscriber (Rails 8+): JSON logs, per-tenant routing, and production patterns","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/blog/mastering-activesupport-logsubscriber-rails8"},"url":"http://localhost:4000/blog/mastering-activesupport-logsubscriber-rails8"}</script>
<!-- End Jekyll SEO tag -->

</head>


<body>
  <!-- Main content wrapper -->
  <div class="main-wrapper centered">
    <main>
      <!-- Reading progress bar -->
<div class="reading-progress" id="reading-progress"></div>

<article class="post-article">
  <!-- Back navigation -->
  <a href="/blog" class="back-home">
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M19 20H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v1m2 13a2 2 0 0 1-2-2V7m2 13a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-2m-4-3H9M7 16h6M7 12h10"/>
    </svg>
    <span>Blog</span>
  </a>

  <!-- Post header -->
  <header class="post-header">
    <h1 class="post-title">Mastering ActiveSupport::LogSubscriber (Rails 8+): JSON logs, per-tenant routing, and production patterns</h1>
    <div class="post-meta">
      <time datetime="2025-08-11T00:00:00+00:00">Aug 11, 2025</time>
      
      
      
      <span>· 10 min read</span>
      
      
        <span class="post-tags"><a href="/search?q=ruby-on-rails" class="tag">ruby-on-rails</a><a href="/search?q=rails-8" class="tag">rails-8</a><a href="/search?q=logging" class="tag">logging</a><a href="/search?q=logsubscriber" class="tag">logsubscriber</a><a href="/search?q=observability" class="tag">observability</a><a href="/search?q=json-logs" class="tag">json-logs</a></span>
      
    </div>
  </header>

  <div class="post-body">
    <!-- Table of Contents (generated by JS for posts with 4+ headings) -->
    <aside class="toc-sidebar" id="toc-sidebar">
      <nav class="toc" id="toc">
        <div class="toc-title">Contents</div>
        <ul class="toc-list" id="toc-list"></ul>
      </nav>
    </aside>

    <!-- Post content -->
    <div class="prose post-content" id="post-content">
      <p>This post is a deep dive into <strong>ActiveSupport::LogSubscriber</strong>. You’ll get <strong>production-ready</strong> patterns for:</p>
<ul>
  <li><strong>Structured JSON</strong> logs that are ingestion-friendly (ELK, Loki, Datadog, etc.).</li>
  <li><strong>Tagged context</strong> (request/tenant/user) included in every log line.</li>
  <li><strong>Per-tenant log routing</strong> with safe rotation and minimal overhead.</li>
  <li>Clean, copy‑pasteable subscribers for <strong>controllers</strong>, <strong>SQL</strong>, and <strong>background jobs</strong>.</li>
</ul>

<blockquote>
  <p>If you’re using <code class="language-plaintext highlighter-rouge">ActiveSupport::Notifications</code> already, use <code class="language-plaintext highlighter-rouge">LogSubscriber</code> to centralize <strong>formatting and routing</strong> of your logs. Keep metrics/auditing/side-effects in Notifications subscribers.</p>
</blockquote>

<hr />

<h2 id="0-minimal-mental-model">0) Minimal mental model</h2>

<ul>
  <li>Rails emits events (<code class="language-plaintext highlighter-rouge">"process_action.action_controller"</code>, <code class="language-plaintext highlighter-rouge">"sql.active_record"</code>, etc.).</li>
  <li>A <strong>LogSubscriber</strong> class defines methods matching the <strong>event name prefix</strong> (<code class="language-plaintext highlighter-rouge">process_action</code> for <code class="language-plaintext highlighter-rouge">"process_action.action_controller"</code>).</li>
  <li>You bind the subscriber to a <strong>namespace</strong> with <code class="language-plaintext highlighter-rouge">attach_to :action_controller</code>, <code class="language-plaintext highlighter-rouge">:active_record</code>, <code class="language-plaintext highlighter-rouge">:active_job</code>, etc.</li>
  <li>Inside the method you get an <code class="language-plaintext highlighter-rouge">event</code> with <code class="language-plaintext highlighter-rouge">event.duration</code>, and <code class="language-plaintext highlighter-rouge">event.payload</code> (hash). You write logs however you like.</li>
</ul>

<hr />

<h2 id="1-base-json-logger-container-friendly">1) Base JSON logger (container friendly)</h2>

<p>Use a <strong>JSON formatter</strong> so you can log Hashes and they become JSON automatically:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/initializers/json_logger.rb</span>
<span class="nb">require</span> <span class="s2">"json"</span>

<span class="k">class</span> <span class="nc">JsonFormatter</span> <span class="o">&lt;</span> <span class="o">::</span><span class="no">Logger</span><span class="o">::</span><span class="no">Formatter</span>
  <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">severity</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">progname</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
    <span class="n">event</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="no">Hash</span><span class="p">)</span> <span class="p">?</span> <span class="n">msg</span> <span class="p">:</span> <span class="p">{</span> <span class="ss">message: </span><span class="n">msg</span><span class="p">.</span><span class="nf">to_s</span> <span class="p">}</span>
    <span class="n">event</span><span class="p">[</span><span class="ss">:severity</span><span class="p">]</span> <span class="o">=</span> <span class="n">severity</span>
    <span class="n">event</span><span class="p">[</span><span class="ss">:time</span><span class="p">]</span>     <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">utc</span><span class="p">.</span><span class="nf">iso8601</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
    <span class="no">JSON</span><span class="p">.</span><span class="nf">generate</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">base</span> <span class="o">=</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Logger</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vg">$stdout</span><span class="p">)</span> <span class="c1"># good for Docker/Heroku/Render/etc.</span>
<span class="n">base</span><span class="p">.</span><span class="nf">formatter</span> <span class="o">=</span> <span class="no">JsonFormatter</span><span class="p">.</span><span class="nf">new</span>

<span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span> <span class="o">=</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TaggedLogging</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
</code></pre></div></div>

<blockquote>
  <p>From now on, when you do <code class="language-plaintext highlighter-rouge">Rails.logger.info({foo: "bar"})</code>, it prints JSON.</p>
</blockquote>

<hr />

<h2 id="2-current-attributes--request-tags">2) Current attributes &amp; request tags</h2>

<p>Expose common context that you want <strong>in every line</strong>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/models/current.rb</span>
<span class="k">class</span> <span class="nc">Current</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">CurrentAttributes</span>
  <span class="n">attribute</span> <span class="ss">:request_id</span><span class="p">,</span> <span class="ss">:tenant_id</span><span class="p">,</span> <span class="ss">:user_id</span>
<span class="k">end</span>

<span class="c1"># app/controllers/application_controller.rb</span>
<span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">before_action</span> <span class="k">do</span>
    <span class="no">Current</span><span class="p">.</span><span class="nf">request_id</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">request_id</span>
    <span class="no">Current</span><span class="p">.</span><span class="nf">tenant_id</span>  <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s2">"X-Tenant-Id"</span><span class="p">].</span><span class="nf">presence</span>
    <span class="no">Current</span><span class="p">.</span><span class="nf">user_id</span>    <span class="o">=</span> <span class="n">try</span><span class="p">(</span><span class="ss">:current_user</span><span class="p">)</span><span class="o">&amp;</span><span class="p">.</span><span class="nf">id</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<blockquote>
  <p>You can still use <code class="language-plaintext highlighter-rouge">config.log_tags = [:request_id]</code>, but placing core IDs on <code class="language-plaintext highlighter-rouge">Current</code> keeps things explicit and makes JSON logging dead simple.</p>
</blockquote>

<p>Helper:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/lib/logging/helpers.rb</span>
<span class="k">module</span> <span class="nn">Logging</span>
  <span class="k">module</span> <span class="nn">Helpers</span>
    <span class="k">def</span> <span class="nf">redact_params</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">params</span> <span class="k">unless</span> <span class="n">params</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="no">Hash</span><span class="p">)</span>
      <span class="n">params</span><span class="p">.</span><span class="nf">deep_dup</span><span class="p">.</span><span class="nf">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">h</span><span class="o">|</span>
        <span class="sx">%w[password password_confirmation token authorization]</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">k</span><span class="o">|</span>
          <span class="n">h</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"[FILTERED]"</span> <span class="k">if</span> <span class="n">h</span><span class="p">.</span><span class="nf">key?</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">current_tags</span>
      <span class="p">{</span> <span class="ss">request_id: </span><span class="no">Current</span><span class="p">.</span><span class="nf">request_id</span><span class="p">,</span> <span class="ss">tenant_id: </span><span class="no">Current</span><span class="p">.</span><span class="nf">tenant_id</span><span class="p">,</span> <span class="ss">user_id: </span><span class="no">Current</span><span class="p">.</span><span class="nf">user_id</span> <span class="p">}.</span><span class="nf">compact</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<hr />

<h2 id="3-controller-log-subscriber--json-with-tags">3) Controller log subscriber — JSON with tags</h2>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/log_subscribers/controller_log_subscriber.rb</span>
<span class="nb">require</span> <span class="s2">"json"</span>
<span class="nb">require</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"app/lib/logging/helpers"</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ControllerLogSubscriber</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">LogSubscriber</span>
  <span class="kp">include</span> <span class="no">Logging</span><span class="o">::</span><span class="no">Helpers</span>

  <span class="k">def</span> <span class="nf">process_action</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="nb">p</span> <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="nf">payload</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
      <span class="ss">at:          </span><span class="s2">"end"</span><span class="p">,</span>
      <span class="ss">controller:  </span><span class="nb">p</span><span class="p">[</span><span class="ss">:controller</span><span class="p">],</span>
      <span class="ss">action:      </span><span class="nb">p</span><span class="p">[</span><span class="ss">:action</span><span class="p">],</span>
      <span class="ss">method:      </span><span class="nb">p</span><span class="p">[</span><span class="ss">:method</span><span class="p">],</span>
      <span class="ss">path:        </span><span class="nb">p</span><span class="p">[</span><span class="ss">:path</span><span class="p">],</span>
      <span class="ss">status:      </span><span class="nb">p</span><span class="p">[</span><span class="ss">:status</span><span class="p">],</span>
      <span class="ss">view_ms:     </span><span class="nb">p</span><span class="p">[</span><span class="ss">:view_runtime</span><span class="p">],</span>
      <span class="ss">db_ms:       </span><span class="nb">p</span><span class="p">[</span><span class="ss">:db_runtime</span><span class="p">],</span>
      <span class="ss">duration_ms: </span><span class="n">event</span><span class="p">.</span><span class="nf">duration</span><span class="p">.</span><span class="nf">round</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
      <span class="ss">params:      </span><span class="n">redact_params</span><span class="p">(</span><span class="nb">p</span><span class="p">[</span><span class="ss">:params</span><span class="p">]</span> <span class="o">||</span> <span class="p">{})</span>
    <span class="p">}.</span><span class="nf">merge</span><span class="p">(</span><span class="ss">tags: </span><span class="n">current_tags</span><span class="p">)</span>

    <span class="c1"># Write to the normal Rails logger (JSON via formatter)</span>
    <span class="n">info</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># Also route to a per-tenant file (see Section 4)</span>
    <span class="n">tenant_logger</span><span class="p">(</span><span class="no">Current</span><span class="p">.</span><span class="nf">tenant_id</span><span class="p">).</span><span class="nf">info</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">ControllerLogSubscriber</span><span class="p">.</span><span class="nf">attach_to</span> <span class="ss">:action_controller</span>
</code></pre></div></div>

<hr />

<h2 id="4-per-tenant-log-routing">4) Per-tenant log routing</h2>

<p>Write a <strong>copy</strong> of selected events into a per-tenant file. This is handy for B2B debugging, SOC2 audit trails, or noisy customers.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/initializers/tenant_logging.rb</span>
<span class="nb">require</span> <span class="s2">"fileutils"</span>

<span class="no">TENANT_LOG_DIR</span> <span class="o">=</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"log/tenants"</span><span class="p">)</span>
<span class="no">FileUtils</span><span class="p">.</span><span class="nf">mkdir_p</span><span class="p">(</span><span class="no">TENANT_LOG_DIR</span><span class="p">)</span>

<span class="no">TENANT_LOGGER_MUTEX</span> <span class="o">=</span> <span class="no">Mutex</span><span class="p">.</span><span class="nf">new</span>
<span class="no">TENANT_LOGGERS</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">def</span> <span class="nf">tenant_logger</span><span class="p">(</span><span class="n">tenant_id</span><span class="p">)</span>
  <span class="nb">id</span> <span class="o">=</span> <span class="n">tenant_id</span><span class="p">.</span><span class="nf">presence</span> <span class="o">||</span> <span class="s2">"public"</span>
  <span class="no">TENANT_LOGGER_MUTEX</span><span class="p">.</span><span class="nf">synchronize</span> <span class="k">do</span>
    <span class="no">TENANT_LOGGERS</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">||=</span> <span class="k">begin</span>
      <span class="n">path</span> <span class="o">=</span> <span class="no">TENANT_LOG_DIR</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="nb">id</span><span class="si">}</span><span class="s2">.log"</span><span class="p">)</span>
      <span class="c1"># rotate 10 files, 10MB each; adjust to your ops constraints</span>
      <span class="n">logger</span> <span class="o">=</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Logger</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>
      <span class="n">logger</span><span class="p">.</span><span class="nf">formatter</span> <span class="o">=</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">formatter</span> <span class="c1"># same JSON formatter</span>
      <span class="n">logger</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># Optional: clean up rarely used tenant loggers every day</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">after_initialize</span> <span class="k">do</span>
  <span class="no">Thread</span><span class="p">.</span><span class="nf">new</span> <span class="k">do</span>
    <span class="kp">loop</span> <span class="k">do</span>
      <span class="nb">sleep</span> <span class="mi">86_400</span> <span class="c1"># 24h</span>
      <span class="no">TENANT_LOGGER_MUTEX</span><span class="p">.</span><span class="nf">synchronize</span> <span class="k">do</span>
        <span class="no">TENANT_LOGGERS</span><span class="p">.</span><span class="nf">delete_if</span> <span class="k">do</span> <span class="o">|</span><span class="nb">id</span><span class="p">,</span> <span class="n">logger</span><span class="o">|</span>
          <span class="c1"># close stale loggers (this is a naive example; adapt as needed)</span>
          <span class="kp">false</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<blockquote>
  <p>Don’t route <strong>everything</strong> to per-tenant logs—just events that matter (e.g., controller completions, domain events, security-sensitive flows).</p>
</blockquote>

<hr />

<h2 id="5-sql-log-subscriber--highlight-slow-queries">5) SQL log subscriber — highlight slow queries</h2>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/log_subscribers/sql_log_subscriber.rb</span>
<span class="k">class</span> <span class="nc">SqlLogSubscriber</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">LogSubscriber</span>
  <span class="no">SLOW_MS</span> <span class="o">=</span> <span class="mf">150.0</span>

  <span class="k">def</span> <span class="nf">sql</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="nf">payload</span>
    <span class="k">return</span> <span class="k">if</span> <span class="n">payload</span><span class="p">[</span><span class="ss">:name</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"SCHEMA"</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
      <span class="ss">at:          </span><span class="s2">"sql"</span><span class="p">,</span>
      <span class="ss">name:        </span><span class="n">payload</span><span class="p">[</span><span class="ss">:name</span><span class="p">],</span>
      <span class="ss">sql:         </span><span class="n">payload</span><span class="p">[</span><span class="ss">:sql</span><span class="p">],</span>
      <span class="ss">cached:      </span><span class="n">payload</span><span class="p">[</span><span class="ss">:cached</span><span class="p">],</span>
      <span class="ss">duration_ms: </span><span class="n">event</span><span class="p">.</span><span class="nf">duration</span><span class="p">.</span><span class="nf">round</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
      <span class="ss">tags:        </span><span class="p">{</span> <span class="ss">request_id: </span><span class="no">Current</span><span class="p">.</span><span class="nf">request_id</span><span class="p">,</span> <span class="ss">tenant_id: </span><span class="no">Current</span><span class="p">.</span><span class="nf">tenant_id</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">event</span><span class="p">.</span><span class="nf">duration</span> <span class="o">&gt;=</span> <span class="no">SLOW_MS</span>
      <span class="nb">warn</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="n">debug</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">SqlLogSubscriber</span><span class="p">.</span><span class="nf">attach_to</span> <span class="ss">:active_record</span>
</code></pre></div></div>

<blockquote>
  <p>For privacy, avoid logging bind values. If you must, log names only: <code class="language-plaintext highlighter-rouge">payload[:binds].map { |attr| attr.name }</code>.</p>
</blockquote>

<hr />

<h2 id="6-job-log-subscriber--queue-retries-exceptions">6) Job log subscriber — queue, retries, exceptions</h2>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/log_subscribers/job_log_subscriber.rb</span>
<span class="k">class</span> <span class="nc">JobLogSubscriber</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">LogSubscriber</span>
  <span class="k">def</span> <span class="nf">perform</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="n">job</span> <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="nf">payload</span><span class="p">[</span><span class="ss">:job</span><span class="p">]</span>
    <span class="n">ex</span>  <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="nf">payload</span><span class="p">[</span><span class="ss">:exception_object</span><span class="p">]</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
      <span class="ss">at:          </span><span class="s2">"job.perform"</span><span class="p">,</span>
      <span class="ss">job_class:   </span><span class="n">job</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">name</span><span class="p">,</span>
      <span class="ss">job_id:      </span><span class="n">job</span><span class="p">.</span><span class="nf">job_id</span><span class="p">,</span>
      <span class="ss">queue_name:  </span><span class="n">job</span><span class="p">.</span><span class="nf">queue_name</span><span class="p">,</span>
      <span class="ss">duration_ms: </span><span class="n">event</span><span class="p">.</span><span class="nf">duration</span><span class="p">.</span><span class="nf">round</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
      <span class="ss">error:       </span><span class="n">ex</span> <span class="o">&amp;&amp;</span> <span class="p">{</span> <span class="ss">type: </span><span class="n">ex</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">name</span><span class="p">,</span> <span class="ss">message: </span><span class="n">ex</span><span class="p">.</span><span class="nf">message</span> <span class="p">},</span>
      <span class="ss">tags:        </span><span class="p">{</span> <span class="ss">tenant_id: </span><span class="no">Current</span><span class="p">.</span><span class="nf">tenant_id</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">ex</span>
      <span class="n">error</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
      <span class="n">tenant_logger</span><span class="p">(</span><span class="no">Current</span><span class="p">.</span><span class="nf">tenant_id</span><span class="p">).</span><span class="nf">error</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="n">info</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">JobLogSubscriber</span><span class="p">.</span><span class="nf">attach_to</span> <span class="ss">:active_job</span>
</code></pre></div></div>

<hr />

<h2 id="7-multiplexing-logs-broadcasting">7) Multiplexing logs (broadcasting)</h2>

<p>Sometimes you want <strong>the same JSON line</strong> to go to multiple sinks (stdout + file). Ruby’s logger can broadcast:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/initializers/broadcast_logger.rb</span>
<span class="n">json_stdout</span> <span class="o">=</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span> <span class="c1"># from Section 1</span>
<span class="n">json_file</span>   <span class="o">=</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Logger</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"log/combined.json.log"</span><span class="p">))</span>
<span class="n">json_file</span><span class="p">.</span><span class="nf">formatter</span> <span class="o">=</span> <span class="n">json_stdout</span><span class="p">.</span><span class="nf">formatter</span>

<span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Logger</span><span class="p">.</span><span class="nf">broadcast</span><span class="p">(</span><span class="n">json_file</span><span class="p">))</span>
</code></pre></div></div>

<blockquote>
  <p>You can also broadcast only <strong>inside</strong> subscribers for specific events (e.g., only controller completions).</p>
</blockquote>

<hr />

<h2 id="8-sampling--noise-control">8) Sampling &amp; noise control</h2>

<p>High-volume apps need sampling to keep costs sane:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/log_subscribers/sql_log_subscriber.rb (variation)</span>
<span class="k">class</span> <span class="nc">SqlLogSubscriber</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">LogSubscriber</span>
  <span class="no">SAMPLE</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="c1"># 10%</span>
  <span class="no">SLOW_MS</span> <span class="o">=</span> <span class="mf">150.0</span>

  <span class="k">def</span> <span class="nf">sql</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="nf">payload</span>
    <span class="k">return</span> <span class="k">if</span> <span class="n">payload</span><span class="p">[</span><span class="ss">:name</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"SCHEMA"</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nb">rand</span> <span class="o">&gt;</span> <span class="no">SAMPLE</span> <span class="o">&amp;&amp;</span> <span class="n">event</span><span class="p">.</span><span class="nf">duration</span> <span class="o">&lt;</span> <span class="no">SLOW_MS</span>

    <span class="n">info</span><span class="p">({</span>
      <span class="ss">at: </span><span class="s2">"sql"</span><span class="p">,</span>
      <span class="ss">name: </span><span class="n">payload</span><span class="p">[</span><span class="ss">:name</span><span class="p">],</span>
      <span class="ss">sql: </span><span class="n">payload</span><span class="p">[</span><span class="ss">:sql</span><span class="p">],</span>
      <span class="ss">duration_ms: </span><span class="n">event</span><span class="p">.</span><span class="nf">duration</span><span class="p">.</span><span class="nf">round</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
      <span class="ss">tags: </span><span class="p">{</span> <span class="ss">request_id: </span><span class="no">Current</span><span class="p">.</span><span class="nf">request_id</span><span class="p">,</span> <span class="ss">tenant_id: </span><span class="no">Current</span><span class="p">.</span><span class="nf">tenant_id</span> <span class="p">}</span>
    <span class="p">})</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<hr />

<h2 id="9-domain-specific-subscribers">9) Domain-specific subscribers</h2>

<p>You can define your own <strong>namespace</strong> and attach a <code class="language-plaintext highlighter-rouge">LogSubscriber</code> to it. Combine with <code class="language-plaintext highlighter-rouge">Notifications</code> to emit domain events:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/log_subscribers/orders_log_subscriber.rb</span>
<span class="k">class</span> <span class="nc">OrdersLogSubscriber</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">LogSubscriber</span>
  <span class="k">def</span> <span class="nf">checkout</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">at: </span><span class="s2">"orders.checkout"</span><span class="p">,</span> <span class="ss">duration_ms: </span><span class="n">event</span><span class="p">.</span><span class="nf">duration</span><span class="p">.</span><span class="nf">round</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="ss">payload: </span><span class="n">event</span><span class="p">.</span><span class="nf">payload</span><span class="p">,</span> <span class="ss">tags: </span><span class="p">{</span> <span class="ss">tenant_id: </span><span class="no">Current</span><span class="p">.</span><span class="nf">tenant_id</span> <span class="p">}</span> <span class="p">}</span>
    <span class="n">info</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">tenant_logger</span><span class="p">(</span><span class="no">Current</span><span class="p">.</span><span class="nf">tenant_id</span><span class="p">).</span><span class="nf">info</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="no">OrdersLogSubscriber</span><span class="p">.</span><span class="nf">attach_to</span> <span class="ss">:orders</span>
</code></pre></div></div>

<p>Emit events from your code:</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Notifications</span><span class="p">.</span><span class="nf">instrument</span><span class="p">(</span><span class="s2">"checkout.orders"</span><span class="p">,</span> <span class="ss">order_id: </span><span class="n">order</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="ss">total_cents: </span><span class="n">order</span><span class="p">.</span><span class="nf">total_cents</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="10-production-checklist">10) Production checklist</h2>

<ul>
  <li>✅ <strong>JSON</strong> base logger to stdout (containers).</li>
  <li>✅ <strong>Tags</strong>: request_id, tenant_id, user_id (via <code class="language-plaintext highlighter-rouge">Current</code>).</li>
  <li>✅ <strong>Subscribers</strong>: controller, SQL (slow/high volume), job (errors).</li>
  <li>✅ <strong>Per‑tenant routing</strong> only for important events.</li>
  <li>✅ <strong>Sampling</strong> for noisy data.</li>
  <li>✅ <strong>Redaction</strong> for secrets (<code class="language-plaintext highlighter-rouge">password</code>, <code class="language-plaintext highlighter-rouge">token</code>, <code class="language-plaintext highlighter-rouge">authorization</code>).</li>
  <li>✅ Rotate files and set sensible size limits.</li>
</ul>

<hr />

<h2 id="appendix-quick-test-snippet">Appendix: Quick test snippet</h2>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># spec/log_subscribers/controller_log_subscriber_spec.rb</span>
<span class="nb">require</span> <span class="s2">"rails_helper"</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">ControllerLogSubscriber</span> <span class="k">do</span>
  <span class="n">it</span> <span class="s2">"logs process_action with JSON"</span> <span class="k">do</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">controller: </span><span class="s2">"HomeController"</span><span class="p">,</span> <span class="ss">action: </span><span class="s2">"index"</span><span class="p">,</span> <span class="ss">method: </span><span class="s2">"GET"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"/"</span><span class="p">,</span> <span class="ss">status: </span><span class="mi">200</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{}</span> <span class="p">}</span>
    <span class="n">event</span> <span class="o">=</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Notifications</span><span class="o">::</span><span class="no">Event</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"process_action.action_controller"</span><span class="p">,</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span> <span class="o">+</span> <span class="mf">0.012</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
    <span class="n">expect</span> <span class="p">{</span> <span class="no">ControllerLogSubscriber</span><span class="p">.</span><span class="nf">new</span><span class="p">.</span><span class="nf">process_action</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">}.</span><span class="nf">not_to</span> <span class="n">raise_error</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>That’s it—you now have a <strong>clean, structured</strong> logging pipeline powered by <code class="language-plaintext highlighter-rouge">ActiveSupport::LogSubscriber</code>, with JSON, tags, and per‑tenant routing you can turn on/off as needed.</p>

    </div>
  </div>

  <!-- Post navigation (Previous/Next) -->
  
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      
      
      
      
      

  <nav class="post-navigation">
    
      <a href="/blog/securing-jwt-with-rsa-keys" class="post-nav-link post-nav-prev">
        <span class="post-nav-label">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="19" y1="12" x2="5" y2="12"/>
            <polyline points="12 19 5 12 12 5"/>
          </svg>
          Older
        </span>
        <span class="post-nav-title">Securing JWT Tokens in Rails API with Devise,...</span>
      </a>
    
    
      <a href="/blog/rails-instrumentation-notifications-logsubscriber" class="post-nav-link post-nav-next">
        <span class="post-nav-label">
          Newer
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="5" y1="12" x2="19" y2="12"/>
            <polyline points="12 5 19 12 12 19"/>
          </svg>
        </span>
        <span class="post-nav-title">Deep Rails Instrumentation: ActiveSupport::Notifications & LogSubscriber (Rails 8+)...</span>
      </a>
    
  </nav>

  <!-- Back to top button -->
  <button id="back-to-top" class="back-to-top" onclick="window.scrollTo({top: 0, behavior: 'smooth'})" title="Back to top" aria-label="Back to top">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <line x1="12" y1="19" x2="12" y2="5"/>
      <polyline points="5 12 12 5 19 12"/>
    </svg>
  </button>
</article>

<script>
  // Show/hide back-to-top button based on scroll position
  const backToTop = document.getElementById('back-to-top');
  window.addEventListener('scroll', function() {
    if (window.scrollY > 400) {
      backToTop.classList.add('visible');
    } else {
      backToTop.classList.remove('visible');
    }
  });

  // Reading progress bar
  const progressBar = document.getElementById('reading-progress');
  const article = document.querySelector('.post-article');

  window.addEventListener('scroll', function() {
    const articleTop = article.offsetTop;
    const articleHeight = article.offsetHeight;
    const windowHeight = window.innerHeight;
    const scrolled = window.scrollY - articleTop + windowHeight * 0.3;
    const progress = Math.min(Math.max(scrolled / articleHeight * 100, 0), 100);
    progressBar.style.width = progress + '%';
  });

  // Generate Table of Contents
  const postContent = document.getElementById('post-content');
  const tocList = document.getElementById('toc-list');
  const tocSidebar = document.getElementById('toc-sidebar');
  const headings = postContent.querySelectorAll('h2, h3');

  if (headings.length >= 4) {
    tocSidebar.classList.add('visible');

    headings.forEach((heading, index) => {
      // Add ID to heading if not present
      if (!heading.id) {
        heading.id = 'heading-' + index;
      }

      const li = document.createElement('li');
      li.className = 'toc-item toc-' + heading.tagName.toLowerCase();

      const a = document.createElement('a');
      a.href = '#' + heading.id;
      a.textContent = heading.textContent;
      a.className = 'toc-link';

      li.appendChild(a);
      tocList.appendChild(li);
    });

    // Highlight current section in TOC
    const tocLinks = document.querySelectorAll('.toc-link');

    const observerOptions = {
      rootMargin: '-80px 0px -70% 0px'
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          tocLinks.forEach(link => link.classList.remove('active'));
          const activeLink = document.querySelector('.toc-link[href="#' + entry.target.id + '"]');
          if (activeLink) activeLink.classList.add('active');
        }
      });
    }, observerOptions);

    headings.forEach(heading => observer.observe(heading));
  }

  // Add copy buttons and language labels to code blocks
  document.querySelectorAll('.highlight, pre').forEach(element => {
    // Skip if already wrapped or if this is a pre inside a highlight we'll process
    if (element.closest('.code-block-wrapper')) return;
    if (element.tagName === 'PRE' && element.closest('.highlight')) return;

    // Determine what to wrap: the .highlight div or standalone pre
    const highlightDiv = element.classList.contains('highlight') ? element : null;
    const pre = highlightDiv ? highlightDiv.querySelector('pre') : element;
    if (!pre) return;

    const wrapper = document.createElement('div');
    wrapper.className = 'code-block-wrapper';

    // Wrap the highlight div if exists, otherwise wrap pre
    const toWrap = highlightDiv || pre;
    toWrap.parentNode.insertBefore(wrapper, toWrap);
    wrapper.appendChild(toWrap);

    // Detect language from class
    const code = pre.querySelector('code');
    let language = '';

    // Method 1: Check code element class
    if (code && code.className) {
      const match = code.className.match(/language-(\w+)/);
      if (match) language = match[1];
    }

    // Method 2: Check highlight div class (Rouge uses class like "highlight ruby")
    if (!language && highlightDiv) {
      const classes = highlightDiv.className.split(' ');
      for (const cls of classes) {
        if (cls !== 'highlight' && cls.length > 0 && !cls.startsWith('code')) {
          language = cls;
          break;
        }
      }
    }

    // Method 3: Try to detect from code patterns
    if (!language) {
      const text = pre.textContent.trim();
      if (text.startsWith('#') && !text.startsWith('#!/')) {
        const firstLine = text.split('\n')[0];
        if (firstLine.match(/\.rb$/)) language = 'ruby';
        else if (firstLine.match(/\.py$/)) language = 'python';
        else if (firstLine.match(/\.yml$|\.yaml$/)) language = 'yaml';
      } else if (text.startsWith('//')) {
        language = 'javascript';
      } else if (text.match(/^(RSpec|describe|it|context|let)\b/)) {
        language = 'ruby';
      } else if (text.match(/^(def |class |module |require )/)) {
        language = 'ruby';
      }
    }

    // Create header with language and copy button
    const header = document.createElement('div');
    header.className = 'code-block-header';

    if (language) {
      const langLabel = document.createElement('span');
      langLabel.className = 'code-lang';
      langLabel.textContent = language;
      header.appendChild(langLabel);
    }

    const copyBtn = document.createElement('button');
    copyBtn.className = 'code-copy-btn';
    copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg><span>Copy</span>';
    copyBtn.onclick = async function() {
      const text = pre.textContent;
      try {
        await navigator.clipboard.writeText(text);
        copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg><span>Copied!</span>';
        copyBtn.classList.add('copied');
        setTimeout(() => {
          copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg><span>Copy</span>';
          copyBtn.classList.remove('copied');
        }, 2000);
      } catch (err) {
        console.error('Failed to copy:', err);
      }
    };
    header.appendChild(copyBtn);

    // Insert header at the start of wrapper (before the highlight/pre)
    wrapper.insertBefore(header, wrapper.firstChild);
  });
</script>

    </main>

    <footer class="site-footer">
      <div class="footer-content">
  <div class="footer-links">
    <a href="/feed.xml" title="RSS Feed" class="footer-icon-link">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M4 11a9 9 0 0 1 9 9"/>
        <path d="M4 4a16 16 0 0 1 16 16"/>
        <circle cx="5" cy="19" r="1"/>
      </svg>
    </a>
    <span class="footer-divider">·</span>
    <button id="theme-btn" onclick="toggleTheme()" class="theme-toggle-btn" title="Toggle theme (press T)" aria-label="Toggle theme" aria-live="polite">
      <svg class="moon-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"/>
      </svg>
      <svg class="sun-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M14.828 14.828a4 4 0 1 0 -5.656 -5.656a4 4 0 0 0 5.656 5.656z"/>
        <path d="M6.343 17.657l-1.414 1.414"/>
        <path d="M6.343 6.343l-1.414 -1.414"/>
        <path d="M17.657 6.343l1.414 -1.414"/>
        <path d="M17.657 17.657l1.414 1.414"/>
        <path d="M4 12h-2"/>
        <path d="M12 4v-2"/>
        <path d="M20 12h2"/>
        <path d="M12 20v2"/>
      </svg>
    </button>
  </div>
</div>

    </footer>
  </div>

  <script>
    // Theme toggle
    function toggleTheme() {
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

      // Use View Transitions API if available
      if (document.startViewTransition) {
        document.startViewTransition(() => {
          html.setAttribute('data-theme', newTheme);
          localStorage.setItem('theme', newTheme);
        });
      } else {
        html.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
      }
    }

    // Keyboard shortcut: press 't' to toggle theme
    document.addEventListener('keydown', function(e) {
      // Don't trigger if user is typing in an input/textarea
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
        return;
      }
      if (e.key === 't' || e.key === 'T') {
        toggleTheme();
      }
    });
  </script>
</body>
</html>
