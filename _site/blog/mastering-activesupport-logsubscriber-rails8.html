<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="canonical" href="http://localhost:4000/blog/mastering-activesupport-logsubscriber-rails8">
  <link rel="alternate" type="application/rss+xml" title="Software Engineering consultant" href="http://localhost:4000/%20feed.xml" />

  <title>Mastering Activesupport Logsubscriber Rails8 — Software Engineering consultant</title>

  <!-- Remove Bootstrap <link> here if present -->
  <link rel="stylesheet" href="/assets/css/styles.css">
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-VLFHH5CPGM"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-VLFHH5CPGM');
  </script>
  <meta name="description" content="layout: posttitle: “Mastering ActiveSupport::LogSubscriber (Rails 8+): JSON logs, per-tenant routing, and production patterns”date: 2025-08-11tags: [ruby-on-...">
  <meta name="keywords" content="Software Engineering consultant, programming consultant, Ruby web development, agile Ruby development, Ruby on Rails web design, RoR consulting, Ruby on Rails service, RoR consultant, Ruby on Rails NYC, Ruby on Rails expertise, web agency, ios application development, mobile, api, frontend, backend, development, software engineer partner, sf developer, sf ruby on rails, berling ruby consultant, london consultant">
  <meta name="author" content="Max Lukin">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Mastering Activesupport Logsubscriber Rails8 | Software Engineering consultant</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Mastering Activesupport Logsubscriber Rails8" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="layout: post title: “Mastering ActiveSupport::LogSubscriber (Rails 8+): JSON logs, per-tenant routing, and production patterns” date: 2025-08-11 tags: [ruby-on-rails, rails-8, logging, logsubscriber, observability, json-logs] description: “A practical, production-grade guide to ActiveSupport::LogSubscriber for Rails 8+: structured JSON logs, log tags, and per-tenant log routing.” —" />
<meta property="og:description" content="layout: post title: “Mastering ActiveSupport::LogSubscriber (Rails 8+): JSON logs, per-tenant routing, and production patterns” date: 2025-08-11 tags: [ruby-on-rails, rails-8, logging, logsubscriber, observability, json-logs] description: “A practical, production-grade guide to ActiveSupport::LogSubscriber for Rails 8+: structured JSON logs, log tags, and per-tenant log routing.” —" />
<link rel="canonical" href="http://localhost:4000/blog/mastering-activesupport-logsubscriber-rails8" />
<meta property="og:url" content="http://localhost:4000/blog/mastering-activesupport-logsubscriber-rails8" />
<meta property="og:site_name" content="Software Engineering consultant" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-08-11T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Mastering Activesupport Logsubscriber Rails8" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-08-11T00:00:00+00:00","datePublished":"2025-08-11T00:00:00+00:00","description":"layout: post title: “Mastering ActiveSupport::LogSubscriber (Rails 8+): JSON logs, per-tenant routing, and production patterns” date: 2025-08-11 tags: [ruby-on-rails, rails-8, logging, logsubscriber, observability, json-logs] description: “A practical, production-grade guide to ActiveSupport::LogSubscriber for Rails 8+: structured JSON logs, log tags, and per-tenant log routing.” —","headline":"Mastering Activesupport Logsubscriber Rails8","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/blog/mastering-activesupport-logsubscriber-rails8"},"url":"http://localhost:4000/blog/mastering-activesupport-logsubscriber-rails8"}</script>
<!-- End Jekyll SEO tag -->

</head>

<body>
  <header class="header">
    <div class="wrap nav">
      <a class="brand" href="/">Software Engineering consultant</a>
      <nav class="nav">
        <a href="/blog">Blog</a>
      </nav>
    </div>
  </header>

  <main class="page wrap">
    <article class="article">
  <header>
    <h1>Mastering Activesupport Logsubscriber Rails8</h1>
    <time datetime="2025-08-11T00:00:00+00:00">11 August 2025</time>
    <p class="lead">

layout: post
title: “Mastering ActiveSupport::LogSubscriber (Rails 8+): JSON logs, per-tenant routing, and production patterns”
date: 2025-08-11
tags: [ruby-on-rails, rails-8, logging, logsubscriber, observability, json-logs]
description: “A practical, production-grade guide to ActiveSupport::LogSubscriber for Rails 8+: structured JSON logs, log tags, and per-tenant log routing.”
—
</p>
    <hr />
  </header>

  <div class="prose">
    
<hr />
<p>layout: post
title: “Mastering ActiveSupport::LogSubscriber (Rails 8+): JSON logs, per-tenant routing, and production patterns”
date: 2025-08-11
tags: [ruby-on-rails, rails-8, logging, logsubscriber, observability, json-logs]
description: “A practical, production-grade guide to ActiveSupport::LogSubscriber for Rails 8+: structured JSON logs, log tags, and per-tenant log routing.”
—</p>

<p>This post is a deep dive into <strong>ActiveSupport::LogSubscriber</strong>. You’ll get <strong>production-ready</strong> patterns for:</p>
<ul>
  <li><strong>Structured JSON</strong> logs that are ingestion-friendly (ELK, Loki, Datadog, etc.).</li>
  <li><strong>Tagged context</strong> (request/tenant/user) included in every log line.</li>
  <li><strong>Per-tenant log routing</strong> with safe rotation and minimal overhead.</li>
  <li>Clean, copy‑pasteable subscribers for <strong>controllers</strong>, <strong>SQL</strong>, and <strong>background jobs</strong>.</li>
</ul>

<blockquote>
  <p>If you’re using <code class="language-plaintext highlighter-rouge">ActiveSupport::Notifications</code> already, use <code class="language-plaintext highlighter-rouge">LogSubscriber</code> to centralize <strong>formatting and routing</strong> of your logs. Keep metrics/auditing/side-effects in Notifications subscribers.</p>
</blockquote>

<hr />

<h2 id="0-minimal-mental-model">0) Minimal mental model</h2>

<ul>
  <li>Rails emits events (<code class="language-plaintext highlighter-rouge">"process_action.action_controller"</code>, <code class="language-plaintext highlighter-rouge">"sql.active_record"</code>, etc.).</li>
  <li>A <strong>LogSubscriber</strong> class defines methods matching the <strong>event name prefix</strong> (<code class="language-plaintext highlighter-rouge">process_action</code> for <code class="language-plaintext highlighter-rouge">"process_action.action_controller"</code>).</li>
  <li>You bind the subscriber to a <strong>namespace</strong> with <code class="language-plaintext highlighter-rouge">attach_to :action_controller</code>, <code class="language-plaintext highlighter-rouge">:active_record</code>, <code class="language-plaintext highlighter-rouge">:active_job</code>, etc.</li>
  <li>Inside the method you get an <code class="language-plaintext highlighter-rouge">event</code> with <code class="language-plaintext highlighter-rouge">event.duration</code>, and <code class="language-plaintext highlighter-rouge">event.payload</code> (hash). You write logs however you like.</li>
</ul>

<hr />

<h2 id="1-base-json-logger-container-friendly">1) Base JSON logger (container friendly)</h2>

<p>Use a <strong>JSON formatter</strong> so you can log Hashes and they become JSON automatically:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="c1"># config/initializers/json_logger.rb</span>
<span class="nb">require</span> <span class="s2">"json"</span>

<span class="k">class</span> <span class="nc">JsonFormatter</span> <span class="o">&lt;</span> <span class="o">::</span><span class="no">Logger</span><span class="o">::</span><span class="no">Formatter</span>
  <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">severity</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">progname</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
    <span class="n">event</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="no">Hash</span><span class="p">)</span> <span class="p">?</span> <span class="n">msg</span> <span class="p">:</span> <span class="p">{</span> <span class="ss">message: </span><span class="n">msg</span><span class="p">.</span><span class="nf">to_s</span> <span class="p">}</span>
    <span class="n">event</span><span class="p">[</span><span class="ss">:severity</span><span class="p">]</span> <span class="o">=</span> <span class="n">severity</span>
    <span class="n">event</span><span class="p">[</span><span class="ss">:time</span><span class="p">]</span>     <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">utc</span><span class="p">.</span><span class="nf">iso8601</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
    <span class="no">JSON</span><span class="p">.</span><span class="nf">generate</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">base</span> <span class="o">=</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Logger</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vg">$stdout</span><span class="p">)</span> <span class="c1"># good for Docker/Heroku/Render/etc.</span>
<span class="n">base</span><span class="p">.</span><span class="nf">formatter</span> <span class="o">=</span> <span class="no">JsonFormatter</span><span class="p">.</span><span class="nf">new</span>

<span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span> <span class="o">=</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TaggedLogging</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>From now on, when you do <code class="language-plaintext highlighter-rouge">Rails.logger.info({foo: "bar"})</code>, it prints JSON.</p>
</blockquote>

<hr />

<h2 id="2-current-attributes--request-tags">2) Current attributes &amp; request tags</h2>

<p>Expose common context that you want <strong>in every line</strong>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="c1"># app/models/current.rb</span>
<span class="k">class</span> <span class="nc">Current</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">CurrentAttributes</span>
  <span class="n">attribute</span> <span class="ss">:request_id</span><span class="p">,</span> <span class="ss">:tenant_id</span><span class="p">,</span> <span class="ss">:user_id</span>
<span class="k">end</span>

<span class="c1"># app/controllers/application_controller.rb</span>
<span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">before_action</span> <span class="k">do</span>
    <span class="no">Current</span><span class="p">.</span><span class="nf">request_id</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">request_id</span>
    <span class="no">Current</span><span class="p">.</span><span class="nf">tenant_id</span>  <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s2">"X-Tenant-Id"</span><span class="p">].</span><span class="nf">presence</span>
    <span class="no">Current</span><span class="p">.</span><span class="nf">user_id</span>    <span class="o">=</span> <span class="n">try</span><span class="p">(</span><span class="ss">:current_user</span><span class="p">)</span><span class="o">&amp;</span><span class="p">.</span><span class="nf">id</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>You can still use <code class="language-plaintext highlighter-rouge">config.log_tags = [:request_id]</code>, but placing core IDs on <code class="language-plaintext highlighter-rouge">Current</code> keeps things explicit and makes JSON logging dead simple.</p>
</blockquote>

<p>Helper:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="c1"># app/lib/logging/helpers.rb</span>
<span class="k">module</span> <span class="nn">Logging</span>
  <span class="k">module</span> <span class="nn">Helpers</span>
    <span class="k">def</span> <span class="nf">redact_params</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">params</span> <span class="k">unless</span> <span class="n">params</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="no">Hash</span><span class="p">)</span>
      <span class="n">params</span><span class="p">.</span><span class="nf">deep_dup</span><span class="p">.</span><span class="nf">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">h</span><span class="o">|</span>
        <span class="sx">%w[password password_confirmation token authorization]</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">k</span><span class="o">|</span>
          <span class="n">h</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"[FILTERED]"</span> <span class="k">if</span> <span class="n">h</span><span class="p">.</span><span class="nf">key?</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">current_tags</span>
      <span class="p">{</span> <span class="ss">request_id: </span><span class="no">Current</span><span class="p">.</span><span class="nf">request_id</span><span class="p">,</span> <span class="ss">tenant_id: </span><span class="no">Current</span><span class="p">.</span><span class="nf">tenant_id</span><span class="p">,</span> <span class="ss">user_id: </span><span class="no">Current</span><span class="p">.</span><span class="nf">user_id</span> <span class="p">}.</span><span class="nf">compact</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<hr />

<h2 id="3-controller-log-subscriber--json-with-tags">3) Controller log subscriber — JSON with tags</h2>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre><span class="c1"># app/log_subscribers/controller_log_subscriber.rb</span>
<span class="nb">require</span> <span class="s2">"json"</span>
<span class="nb">require</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"app/lib/logging/helpers"</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ControllerLogSubscriber</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">LogSubscriber</span>
  <span class="kp">include</span> <span class="no">Logging</span><span class="o">::</span><span class="no">Helpers</span>

  <span class="k">def</span> <span class="nf">process_action</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="nb">p</span> <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="nf">payload</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
      <span class="ss">at:          </span><span class="s2">"end"</span><span class="p">,</span>
      <span class="ss">controller:  </span><span class="nb">p</span><span class="p">[</span><span class="ss">:controller</span><span class="p">],</span>
      <span class="ss">action:      </span><span class="nb">p</span><span class="p">[</span><span class="ss">:action</span><span class="p">],</span>
      <span class="ss">method:      </span><span class="nb">p</span><span class="p">[</span><span class="ss">:method</span><span class="p">],</span>
      <span class="ss">path:        </span><span class="nb">p</span><span class="p">[</span><span class="ss">:path</span><span class="p">],</span>
      <span class="ss">status:      </span><span class="nb">p</span><span class="p">[</span><span class="ss">:status</span><span class="p">],</span>
      <span class="ss">view_ms:     </span><span class="nb">p</span><span class="p">[</span><span class="ss">:view_runtime</span><span class="p">],</span>
      <span class="ss">db_ms:       </span><span class="nb">p</span><span class="p">[</span><span class="ss">:db_runtime</span><span class="p">],</span>
      <span class="ss">duration_ms: </span><span class="n">event</span><span class="p">.</span><span class="nf">duration</span><span class="p">.</span><span class="nf">round</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
      <span class="ss">params:      </span><span class="n">redact_params</span><span class="p">(</span><span class="nb">p</span><span class="p">[</span><span class="ss">:params</span><span class="p">]</span> <span class="o">||</span> <span class="p">{})</span>
    <span class="p">}.</span><span class="nf">merge</span><span class="p">(</span><span class="ss">tags: </span><span class="n">current_tags</span><span class="p">)</span>

    <span class="c1"># Write to the normal Rails logger (JSON via formatter)</span>
    <span class="n">info</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># Also route to a per-tenant file (see Section 4)</span>
    <span class="n">tenant_logger</span><span class="p">(</span><span class="no">Current</span><span class="p">.</span><span class="nf">tenant_id</span><span class="p">).</span><span class="nf">info</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">ControllerLogSubscriber</span><span class="p">.</span><span class="nf">attach_to</span> <span class="ss">:action_controller</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<hr />

<h2 id="4-per-tenant-log-routing">4) Per-tenant log routing</h2>

<p>Write a <strong>copy</strong> of selected events into a per-tenant file. This is handy for B2B debugging, SOC2 audit trails, or noisy customers.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre><span class="c1"># config/initializers/tenant_logging.rb</span>
<span class="nb">require</span> <span class="s2">"fileutils"</span>

<span class="no">TENANT_LOG_DIR</span> <span class="o">=</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"log/tenants"</span><span class="p">)</span>
<span class="no">FileUtils</span><span class="p">.</span><span class="nf">mkdir_p</span><span class="p">(</span><span class="no">TENANT_LOG_DIR</span><span class="p">)</span>

<span class="no">TENANT_LOGGER_MUTEX</span> <span class="o">=</span> <span class="no">Mutex</span><span class="p">.</span><span class="nf">new</span>
<span class="no">TENANT_LOGGERS</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">def</span> <span class="nf">tenant_logger</span><span class="p">(</span><span class="n">tenant_id</span><span class="p">)</span>
  <span class="nb">id</span> <span class="o">=</span> <span class="n">tenant_id</span><span class="p">.</span><span class="nf">presence</span> <span class="o">||</span> <span class="s2">"public"</span>
  <span class="no">TENANT_LOGGER_MUTEX</span><span class="p">.</span><span class="nf">synchronize</span> <span class="k">do</span>
    <span class="no">TENANT_LOGGERS</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">||=</span> <span class="k">begin</span>
      <span class="n">path</span> <span class="o">=</span> <span class="no">TENANT_LOG_DIR</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="nb">id</span><span class="si">}</span><span class="s2">.log"</span><span class="p">)</span>
      <span class="c1"># rotate 10 files, 10MB each; adjust to your ops constraints</span>
      <span class="n">logger</span> <span class="o">=</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Logger</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>
      <span class="n">logger</span><span class="p">.</span><span class="nf">formatter</span> <span class="o">=</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">formatter</span> <span class="c1"># same JSON formatter</span>
      <span class="n">logger</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># Optional: clean up rarely used tenant loggers every day</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">after_initialize</span> <span class="k">do</span>
  <span class="no">Thread</span><span class="p">.</span><span class="nf">new</span> <span class="k">do</span>
    <span class="kp">loop</span> <span class="k">do</span>
      <span class="nb">sleep</span> <span class="mi">86_400</span> <span class="c1"># 24h</span>
      <span class="no">TENANT_LOGGER_MUTEX</span><span class="p">.</span><span class="nf">synchronize</span> <span class="k">do</span>
        <span class="no">TENANT_LOGGERS</span><span class="p">.</span><span class="nf">delete_if</span> <span class="k">do</span> <span class="o">|</span><span class="nb">id</span><span class="p">,</span> <span class="n">logger</span><span class="o">|</span>
          <span class="c1"># close stale loggers (this is a naive example; adapt as needed)</span>
          <span class="kp">false</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>Don’t route <strong>everything</strong> to per-tenant logs—just events that matter (e.g., controller completions, domain events, security-sensitive flows).</p>
</blockquote>

<hr />

<h2 id="5-sql-log-subscriber--highlight-slow-queries">5) SQL log subscriber — highlight slow queries</h2>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre><span class="c1"># app/log_subscribers/sql_log_subscriber.rb</span>
<span class="k">class</span> <span class="nc">SqlLogSubscriber</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">LogSubscriber</span>
  <span class="no">SLOW_MS</span> <span class="o">=</span> <span class="mf">150.0</span>

  <span class="k">def</span> <span class="nf">sql</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="nf">payload</span>
    <span class="k">return</span> <span class="k">if</span> <span class="n">payload</span><span class="p">[</span><span class="ss">:name</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"SCHEMA"</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
      <span class="ss">at:          </span><span class="s2">"sql"</span><span class="p">,</span>
      <span class="ss">name:        </span><span class="n">payload</span><span class="p">[</span><span class="ss">:name</span><span class="p">],</span>
      <span class="ss">sql:         </span><span class="n">payload</span><span class="p">[</span><span class="ss">:sql</span><span class="p">],</span>
      <span class="ss">cached:      </span><span class="n">payload</span><span class="p">[</span><span class="ss">:cached</span><span class="p">],</span>
      <span class="ss">duration_ms: </span><span class="n">event</span><span class="p">.</span><span class="nf">duration</span><span class="p">.</span><span class="nf">round</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
      <span class="ss">tags:        </span><span class="p">{</span> <span class="ss">request_id: </span><span class="no">Current</span><span class="p">.</span><span class="nf">request_id</span><span class="p">,</span> <span class="ss">tenant_id: </span><span class="no">Current</span><span class="p">.</span><span class="nf">tenant_id</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">event</span><span class="p">.</span><span class="nf">duration</span> <span class="o">&gt;=</span> <span class="no">SLOW_MS</span>
      <span class="nb">warn</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="n">debug</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">SqlLogSubscriber</span><span class="p">.</span><span class="nf">attach_to</span> <span class="ss">:active_record</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>For privacy, avoid logging bind values. If you must, log names only: <code class="language-plaintext highlighter-rouge">payload[:binds].map { |attr| attr.name }</code>.</p>
</blockquote>

<hr />

<h2 id="6-job-log-subscriber--queue-retries-exceptions">6) Job log subscriber — queue, retries, exceptions</h2>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre><span class="c1"># app/log_subscribers/job_log_subscriber.rb</span>
<span class="k">class</span> <span class="nc">JobLogSubscriber</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">LogSubscriber</span>
  <span class="k">def</span> <span class="nf">perform</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="n">job</span> <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="nf">payload</span><span class="p">[</span><span class="ss">:job</span><span class="p">]</span>
    <span class="n">ex</span>  <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="nf">payload</span><span class="p">[</span><span class="ss">:exception_object</span><span class="p">]</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
      <span class="ss">at:          </span><span class="s2">"job.perform"</span><span class="p">,</span>
      <span class="ss">job_class:   </span><span class="n">job</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">name</span><span class="p">,</span>
      <span class="ss">job_id:      </span><span class="n">job</span><span class="p">.</span><span class="nf">job_id</span><span class="p">,</span>
      <span class="ss">queue_name:  </span><span class="n">job</span><span class="p">.</span><span class="nf">queue_name</span><span class="p">,</span>
      <span class="ss">duration_ms: </span><span class="n">event</span><span class="p">.</span><span class="nf">duration</span><span class="p">.</span><span class="nf">round</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
      <span class="ss">error:       </span><span class="n">ex</span> <span class="o">&amp;&amp;</span> <span class="p">{</span> <span class="ss">type: </span><span class="n">ex</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">name</span><span class="p">,</span> <span class="ss">message: </span><span class="n">ex</span><span class="p">.</span><span class="nf">message</span> <span class="p">},</span>
      <span class="ss">tags:        </span><span class="p">{</span> <span class="ss">tenant_id: </span><span class="no">Current</span><span class="p">.</span><span class="nf">tenant_id</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">ex</span>
      <span class="n">error</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
      <span class="n">tenant_logger</span><span class="p">(</span><span class="no">Current</span><span class="p">.</span><span class="nf">tenant_id</span><span class="p">).</span><span class="nf">error</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="n">info</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">JobLogSubscriber</span><span class="p">.</span><span class="nf">attach_to</span> <span class="ss">:active_job</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<hr />

<h2 id="7-multiplexing-logs-broadcasting">7) Multiplexing logs (broadcasting)</h2>

<p>Sometimes you want <strong>the same JSON line</strong> to go to multiple sinks (stdout + file). Ruby’s logger can broadcast:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="c1"># config/initializers/broadcast_logger.rb</span>
<span class="n">json_stdout</span> <span class="o">=</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span> <span class="c1"># from Section 1</span>
<span class="n">json_file</span>   <span class="o">=</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Logger</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"log/combined.json.log"</span><span class="p">))</span>
<span class="n">json_file</span><span class="p">.</span><span class="nf">formatter</span> <span class="o">=</span> <span class="n">json_stdout</span><span class="p">.</span><span class="nf">formatter</span>

<span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Logger</span><span class="p">.</span><span class="nf">broadcast</span><span class="p">(</span><span class="n">json_file</span><span class="p">))</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>You can also broadcast only <strong>inside</strong> subscribers for specific events (e.g., only controller completions).</p>
</blockquote>

<hr />

<h2 id="8-sampling--noise-control">8) Sampling &amp; noise control</h2>

<p>High-volume apps need sampling to keep costs sane:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="c1"># app/log_subscribers/sql_log_subscriber.rb (variation)</span>
<span class="k">class</span> <span class="nc">SqlLogSubscriber</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">LogSubscriber</span>
  <span class="no">SAMPLE</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="c1"># 10%</span>
  <span class="no">SLOW_MS</span> <span class="o">=</span> <span class="mf">150.0</span>

  <span class="k">def</span> <span class="nf">sql</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="nf">payload</span>
    <span class="k">return</span> <span class="k">if</span> <span class="n">payload</span><span class="p">[</span><span class="ss">:name</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"SCHEMA"</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nb">rand</span> <span class="o">&gt;</span> <span class="no">SAMPLE</span> <span class="o">&amp;&amp;</span> <span class="n">event</span><span class="p">.</span><span class="nf">duration</span> <span class="o">&lt;</span> <span class="no">SLOW_MS</span>

    <span class="n">info</span><span class="p">({</span>
      <span class="ss">at: </span><span class="s2">"sql"</span><span class="p">,</span>
      <span class="ss">name: </span><span class="n">payload</span><span class="p">[</span><span class="ss">:name</span><span class="p">],</span>
      <span class="ss">sql: </span><span class="n">payload</span><span class="p">[</span><span class="ss">:sql</span><span class="p">],</span>
      <span class="ss">duration_ms: </span><span class="n">event</span><span class="p">.</span><span class="nf">duration</span><span class="p">.</span><span class="nf">round</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
      <span class="ss">tags: </span><span class="p">{</span> <span class="ss">request_id: </span><span class="no">Current</span><span class="p">.</span><span class="nf">request_id</span><span class="p">,</span> <span class="ss">tenant_id: </span><span class="no">Current</span><span class="p">.</span><span class="nf">tenant_id</span> <span class="p">}</span>
    <span class="p">})</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<hr />

<h2 id="9-domain-specific-subscribers">9) Domain-specific subscribers</h2>

<p>You can define your own <strong>namespace</strong> and attach a <code class="language-plaintext highlighter-rouge">LogSubscriber</code> to it. Combine with <code class="language-plaintext highlighter-rouge">Notifications</code> to emit domain events:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="c1"># app/log_subscribers/orders_log_subscriber.rb</span>
<span class="k">class</span> <span class="nc">OrdersLogSubscriber</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">LogSubscriber</span>
  <span class="k">def</span> <span class="nf">checkout</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">at: </span><span class="s2">"orders.checkout"</span><span class="p">,</span> <span class="ss">duration_ms: </span><span class="n">event</span><span class="p">.</span><span class="nf">duration</span><span class="p">.</span><span class="nf">round</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="ss">payload: </span><span class="n">event</span><span class="p">.</span><span class="nf">payload</span><span class="p">,</span> <span class="ss">tags: </span><span class="p">{</span> <span class="ss">tenant_id: </span><span class="no">Current</span><span class="p">.</span><span class="nf">tenant_id</span> <span class="p">}</span> <span class="p">}</span>
    <span class="n">info</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">tenant_logger</span><span class="p">(</span><span class="no">Current</span><span class="p">.</span><span class="nf">tenant_id</span><span class="p">).</span><span class="nf">info</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="no">OrdersLogSubscriber</span><span class="p">.</span><span class="nf">attach_to</span> <span class="ss">:orders</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Emit events from your code:</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Notifications</span><span class="p">.</span><span class="nf">instrument</span><span class="p">(</span><span class="s2">"checkout.orders"</span><span class="p">,</span> <span class="ss">order_id: </span><span class="n">order</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="ss">total_cents: </span><span class="n">order</span><span class="p">.</span><span class="nf">total_cents</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<hr />

<h2 id="10-production-checklist">10) Production checklist</h2>

<ul>
  <li>✅ <strong>JSON</strong> base logger to stdout (containers).</li>
  <li>✅ <strong>Tags</strong>: request_id, tenant_id, user_id (via <code class="language-plaintext highlighter-rouge">Current</code>).</li>
  <li>✅ <strong>Subscribers</strong>: controller, SQL (slow/high volume), job (errors).</li>
  <li>✅ <strong>Per‑tenant routing</strong> only for important events.</li>
  <li>✅ <strong>Sampling</strong> for noisy data.</li>
  <li>✅ <strong>Redaction</strong> for secrets (<code class="language-plaintext highlighter-rouge">password</code>, <code class="language-plaintext highlighter-rouge">token</code>, <code class="language-plaintext highlighter-rouge">authorization</code>).</li>
  <li>✅ Rotate files and set sensible size limits.</li>
</ul>

<hr />

<h2 id="appendix-quick-test-snippet">Appendix: Quick test snippet</h2>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="c1"># spec/log_subscribers/controller_log_subscriber_spec.rb</span>
<span class="nb">require</span> <span class="s2">"rails_helper"</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">ControllerLogSubscriber</span> <span class="k">do</span>
  <span class="n">it</span> <span class="s2">"logs process_action with JSON"</span> <span class="k">do</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">controller: </span><span class="s2">"HomeController"</span><span class="p">,</span> <span class="ss">action: </span><span class="s2">"index"</span><span class="p">,</span> <span class="ss">method: </span><span class="s2">"GET"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"/"</span><span class="p">,</span> <span class="ss">status: </span><span class="mi">200</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{}</span> <span class="p">}</span>
    <span class="n">event</span> <span class="o">=</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Notifications</span><span class="o">::</span><span class="no">Event</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"process_action.action_controller"</span><span class="p">,</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span> <span class="o">+</span> <span class="mf">0.012</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
    <span class="n">expect</span> <span class="p">{</span> <span class="no">ControllerLogSubscriber</span><span class="p">.</span><span class="nf">new</span><span class="p">.</span><span class="nf">process_action</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">}.</span><span class="nf">not_to</span> <span class="n">raise_error</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>That’s it—you now have a <strong>clean, structured</strong> logging pipeline powered by <code class="language-plaintext highlighter-rouge">ActiveSupport::LogSubscriber</code>, with JSON, tags, and per‑tenant routing you can turn on/off as needed.</p>

  </div>
</article>

  </main>

  <footer class="footer">
    <div class="wrap">
      <a href="https://lukin.io/cv.pdf" target="_blank">cv</a>
    </div>
  </footer>
</body>

</html>
