<!DOCTYPE html>
<html lang="en">
<head>
  <!-- View Transitions API -->
  <meta name="view-transition" content="same-origin">
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-VLFHH5CPGM"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-VLFHH5CPGM');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <title>Mastering freeze_time in Rails Tests: Practical Patterns and Pitfalls | Software Engineering consultant</title>
  
  <meta name="theme-color" content="#006cac">

  <link rel="canonical" href="http://localhost:4000/blog/mastering-freeze_time-in-rails-tests">
  <link rel="alternate" type="application/rss+xml" title="Software Engineering consultant" href="http://localhost:4000/feed.xml" />
  <link rel="shortcut icon" type="image/png" href="http://localhost:4000/favicon.png">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Stylesheets -->
  <link rel="stylesheet" href="/assets/css/global.css">
  <link rel="stylesheet" href="/assets/css/custom.css">
  <link rel="stylesheet" href="/assets/css/typography.css">

  <meta name="description"
    content="If your test suite ever fails “only sometimes,” there’s a good chance time is involved. Rails ships with the excellent ActiveSupport::Testing::TimeHelpers, g...">
  <meta name="keywords"
    content="Software Engineering consultant, programming consultant, Ruby web development, agile Ruby development, Ruby on Rails web design, RoR consulting, Ruby on Rails service, RoR consultant, Ruby on Rails NYC, Ruby on Rails expertise, web agency, ios application development, mobile, api, frontend, backend, development, software engineer partner, sf developer, sf ruby on rails, berling ruby consultant, london consultant">
  <meta name="author" content="Max Lukin">

  <!-- Theme initialization - prevent flash -->
  <script>
    (function() {
      const savedTheme = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const theme = savedTheme || (prefersDark ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Mastering freeze_time in Rails Tests: Practical Patterns and Pitfalls | Software Engineering consultant</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Mastering freeze_time in Rails Tests: Practical Patterns and Pitfalls" />
<meta name="author" content="Max Lukin" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="If your test suite ever fails “only sometimes,” there’s a good chance time is involved. Rails ships with the excellent ActiveSupport::Testing::TimeHelpers, giving you tools like freeze_time, travel_to, and travel to control the clock deterministically. In this post, you’ll learn when to use freeze_time, how it differs from travel_to, and a handful of real-world patterns (Rails 7/8+ friendly) you can drop straight into your specs." />
<meta property="og:description" content="If your test suite ever fails “only sometimes,” there’s a good chance time is involved. Rails ships with the excellent ActiveSupport::Testing::TimeHelpers, giving you tools like freeze_time, travel_to, and travel to control the clock deterministically. In this post, you’ll learn when to use freeze_time, how it differs from travel_to, and a handful of real-world patterns (Rails 7/8+ friendly) you can drop straight into your specs." />
<link rel="canonical" href="http://localhost:4000/blog/mastering-freeze_time-in-rails-tests" />
<meta property="og:url" content="http://localhost:4000/blog/mastering-freeze_time-in-rails-tests" />
<meta property="og:site_name" content="Software Engineering consultant" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-08-12T03:01:01+03:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Mastering freeze_time in Rails Tests: Practical Patterns and Pitfalls" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Max Lukin"},"dateModified":"2025-08-12T03:01:01+03:00","datePublished":"2025-08-12T03:01:01+03:00","description":"If your test suite ever fails “only sometimes,” there’s a good chance time is involved. Rails ships with the excellent ActiveSupport::Testing::TimeHelpers, giving you tools like freeze_time, travel_to, and travel to control the clock deterministically. In this post, you’ll learn when to use freeze_time, how it differs from travel_to, and a handful of real-world patterns (Rails 7/8+ friendly) you can drop straight into your specs.","headline":"Mastering freeze_time in Rails Tests: Practical Patterns and Pitfalls","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/blog/mastering-freeze_time-in-rails-tests"},"url":"http://localhost:4000/blog/mastering-freeze_time-in-rails-tests"}</script>
<!-- End Jekyll SEO tag -->

</head>


<body>
  <!-- Main content wrapper -->
  <div class="main-wrapper centered">
    <main>
      <!-- Reading progress bar -->
<div class="reading-progress" id="reading-progress"></div>

<article class="post-article">
  <!-- Back navigation -->
  <a href="/blog" class="back-home">
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M19 20H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v1m2 13a2 2 0 0 1-2-2V7m2 13a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-2m-4-3H9M7 16h6M7 12h10"/>
    </svg>
    <span>Blog</span>
  </a>

  <!-- Post header -->
  <header class="post-header">
    <h1 class="post-title">Mastering freeze_time in Rails Tests: Practical Patterns and Pitfalls</h1>
    <div class="post-meta">
      <time datetime="2025-08-12T03:01:01+03:00">Aug 12, 2025</time>
      
      
      
      <span>· 6 min read</span>
      
        <span>· Max Lukin</span>
      
      
        <span class="post-tags"></span>
      
    </div>
  </header>

  <div class="post-body">
    <!-- Table of Contents (generated by JS for posts with 4+ headings) -->
    <aside class="toc-sidebar" id="toc-sidebar">
      <nav class="toc" id="toc">
        <div class="toc-title">Contents</div>
        <ul class="toc-list" id="toc-list"></ul>
      </nav>
    </aside>

    <!-- Post content -->
    <div class="prose post-content" id="post-content">
      <p>If your test suite ever fails “only sometimes,” there’s a good chance time is involved. Rails ships with the excellent <code class="language-plaintext highlighter-rouge">ActiveSupport::Testing::TimeHelpers</code>, giving you tools like <code class="language-plaintext highlighter-rouge">freeze_time</code>, <code class="language-plaintext highlighter-rouge">travel_to</code>, and <code class="language-plaintext highlighter-rouge">travel</code> to control the clock deterministically. In this post, you’ll learn when to use <code class="language-plaintext highlighter-rouge">freeze_time</code>, how it differs from <code class="language-plaintext highlighter-rouge">travel_to</code>, and a handful of real-world patterns (Rails 7/8+ friendly) you can drop straight into your specs.</p>

<hr />

<h2 id="tldr">TL;DR</h2>

<ul>
  <li><strong>Use <code class="language-plaintext highlighter-rouge">freeze_time</code></strong> when the <em>current moment</em> shouldn’t move during a test (timestamps, cache keys, token generation).</li>
  <li><strong>Use <code class="language-plaintext highlighter-rouge">travel_to</code></strong> when you want the current time to be a specific instant (and keep it fixed).</li>
  <li><strong>Use <code class="language-plaintext highlighter-rouge">travel</code></strong> when you want to <em>advance/rewind</em> the clock relative to now.</li>
  <li>Prefer <strong><code class="language-plaintext highlighter-rouge">Time.current</code></strong> over <code class="language-plaintext highlighter-rouge">Time.now</code> so your tests respect Rails time zones.</li>
  <li>Always <strong><code class="language-plaintext highlighter-rouge">travel_back</code></strong> (or use the block form) to avoid leaking frozen time to other tests.</li>
</ul>

<hr />

<h2 id="setup-rspec--minitest">Setup (RSpec &amp; Minitest)</h2>

<h3 id="rspec">RSpec</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># spec/rails_helper.rb</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">include</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Testing</span><span class="o">::</span><span class="no">TimeHelpers</span>

  <span class="c1"># Optional: automatically unfreeze/travel back after each example</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">around</span> <span class="k">do</span> <span class="o">|</span><span class="n">example</span><span class="o">|</span>
    <span class="n">travel_back</span>
    <span class="n">example</span><span class="p">.</span><span class="nf">run</span>
    <span class="n">travel_back</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>You can also use block forms of <code class="language-plaintext highlighter-rouge">freeze_time</code>/<code class="language-plaintext highlighter-rouge">travel_to</code> to avoid needing <code class="language-plaintext highlighter-rouge">travel_back</code>.</p>

<h3 id="minitest">Minitest</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test/test_helper.rb</span>
<span class="k">class</span> <span class="nc">ActiveSupport::TestCase</span>
  <span class="kp">include</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Testing</span><span class="o">::</span><span class="no">TimeHelpers</span>
<span class="k">end</span>
</code></pre></div></div>

<hr />

<h2 id="1-stabilize-timestamps-in-model-specs">1) Stabilize Timestamps in Model Specs</h2>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Profile</span><span class="p">,</span> <span class="ss">type: :model</span> <span class="k">do</span>
  <span class="n">it</span> <span class="s2">"sets deterministic timestamps"</span> <span class="k">do</span>
    <span class="n">freeze_time</span> <span class="k">do</span>
      <span class="n">profile</span> <span class="o">=</span> <span class="no">Profile</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"Max"</span><span class="p">)</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">profile</span><span class="p">.</span><span class="nf">created_at</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="no">Time</span><span class="p">.</span><span class="nf">current</span><span class="p">)</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">profile</span><span class="p">.</span><span class="nf">updated_at</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="no">Time</span><span class="p">.</span><span class="nf">current</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<hr />

<h2 id="2-token-generation--expiration">2) Token Generation &amp; Expiration</h2>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">JwtIssuer</span> <span class="k">do</span>
  <span class="n">it</span> <span class="s2">"sets exp 15 minutes from now and expires correctly"</span> <span class="k">do</span>
    <span class="n">freeze_time</span> <span class="k">do</span>
      <span class="n">token</span> <span class="o">=</span> <span class="no">JwtIssuer</span><span class="p">.</span><span class="nf">issue</span><span class="p">(</span><span class="ss">sub: </span><span class="mi">123</span><span class="p">)</span>
      <span class="n">payload</span> <span class="o">=</span> <span class="no">JwtIssuer</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

      <span class="n">expect</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="s2">"iat"</span><span class="p">]).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="no">Time</span><span class="p">.</span><span class="nf">current</span><span class="p">.</span><span class="nf">to_i</span><span class="p">)</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="s2">"exp"</span><span class="p">]).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">15</span><span class="p">.</span><span class="nf">minutes</span><span class="p">.</span><span class="nf">from_now</span><span class="p">.</span><span class="nf">to_i</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">travel</span> <span class="mi">16</span><span class="p">.</span><span class="nf">minutes</span>
    <span class="n">expect</span> <span class="p">{</span> <span class="no">JwtIssuer</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="p">}.</span><span class="nf">to</span> <span class="n">raise_error</span><span class="p">(</span><span class="no">JwtIssuer</span><span class="o">::</span><span class="no">ExpiredToken</span><span class="p">)</span>
  <span class="k">ensure</span>
    <span class="n">travel_back</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<hr />

<h2 id="3-cache-keys--expirations">3) Cache Keys &amp; Expirations</h2>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Profiles</span><span class="o">::</span><span class="no">CachedFinder</span> <span class="k">do</span>
  <span class="n">it</span> <span class="s2">"caches and expires as expected"</span> <span class="k">do</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span><span class="ss">:profile</span><span class="p">)</span>

    <span class="n">freeze_time</span> <span class="k">do</span>
      <span class="n">expect</span> <span class="p">{</span> <span class="n">described_class</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">profile</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span> <span class="p">}</span>
        <span class="p">.</span><span class="nf">to</span> <span class="n">change</span> <span class="p">{</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">cache</span><span class="p">.</span><span class="nf">exist?</span><span class="p">(</span><span class="s2">"profile:</span><span class="si">#{</span><span class="n">profile</span><span class="p">.</span><span class="nf">id</span><span class="si">}</span><span class="s2">:</span><span class="si">#{</span><span class="n">profile</span><span class="p">.</span><span class="nf">updated_at</span><span class="p">.</span><span class="nf">to_i</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span> <span class="p">}</span>
        <span class="p">.</span><span class="nf">from</span><span class="p">(</span><span class="kp">false</span><span class="p">).</span><span class="nf">to</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">travel</span> <span class="mi">1</span><span class="p">.</span><span class="nf">hour</span>
    <span class="n">expect</span><span class="p">(</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">cache</span><span class="p">.</span><span class="nf">exist?</span><span class="p">(</span><span class="s2">"profile:</span><span class="si">#{</span><span class="n">profile</span><span class="p">.</span><span class="nf">id</span><span class="si">}</span><span class="s2">:</span><span class="si">#{</span><span class="n">profile</span><span class="p">.</span><span class="nf">updated_at</span><span class="p">.</span><span class="nf">to_i</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="p">).</span><span class="nf">to</span> <span class="n">be</span><span class="p">(</span><span class="kp">false</span><span class="p">)</span>
  <span class="k">ensure</span>
    <span class="n">travel_back</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<hr />

<h2 id="4-time-dependent-scopes">4) Time-Dependent Scopes</h2>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Session</span><span class="p">,</span> <span class="ss">type: :model</span> <span class="k">do</span>
  <span class="n">it</span> <span class="s2">"moves from active to expired over time"</span> <span class="k">do</span>
    <span class="n">freeze_time</span> <span class="k">do</span>
      <span class="n">session</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span><span class="ss">:session</span><span class="p">,</span> <span class="ss">expires_at: </span><span class="mi">10</span><span class="p">.</span><span class="nf">minutes</span><span class="p">.</span><span class="nf">from_now</span><span class="p">)</span>
      <span class="n">expect</span><span class="p">(</span><span class="no">Session</span><span class="p">.</span><span class="nf">active</span><span class="p">).</span><span class="nf">to</span> <span class="kp">include</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">travel</span> <span class="mi">11</span><span class="p">.</span><span class="nf">minutes</span>
    <span class="n">expect</span><span class="p">(</span><span class="no">Session</span><span class="p">.</span><span class="nf">active</span><span class="p">).</span><span class="nf">to</span> <span class="n">be_empty</span>
  <span class="k">ensure</span>
    <span class="n">travel_back</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<hr />

<h2 id="5-background-jobs">5) Background Jobs</h2>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">ReminderScheduler</span> <span class="k">do</span>
  <span class="kp">include</span> <span class="no">ActiveJob</span><span class="o">::</span><span class="no">TestHelper</span>

  <span class="n">it</span> <span class="s2">"schedules a reminder exactly 24 hours before"</span> <span class="k">do</span>
    <span class="n">freeze_time</span> <span class="k">do</span>
      <span class="n">event</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span><span class="ss">:event</span><span class="p">,</span> <span class="ss">starts_at: </span><span class="mi">3</span><span class="p">.</span><span class="nf">days</span><span class="p">.</span><span class="nf">from_now</span><span class="p">)</span>
      <span class="n">expect</span> <span class="p">{</span>
        <span class="no">ReminderScheduler</span><span class="p">.</span><span class="nf">schedule!</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
      <span class="p">}.</span><span class="nf">to</span> <span class="n">have_enqueued_job</span><span class="p">(</span><span class="no">ReminderJob</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">at</span><span class="p">(</span><span class="mi">2</span><span class="p">.</span><span class="nf">days</span><span class="p">.</span><span class="nf">from_now</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">with</span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<hr />

<h2 id="6-humanized-times">6) Humanized Times</h2>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">ActivityPresenter</span> <span class="k">do</span>
  <span class="n">it</span> <span class="s2">"renders stable relative time"</span> <span class="k">do</span>
    <span class="n">freeze_time</span> <span class="k">do</span>
      <span class="n">activity</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span><span class="ss">:activity</span><span class="p">,</span> <span class="ss">created_at: </span><span class="mi">5</span><span class="p">.</span><span class="nf">minutes</span><span class="p">.</span><span class="nf">ago</span><span class="p">)</span>
      <span class="n">text</span> <span class="o">=</span> <span class="no">ActivityPresenter</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">activity</span><span class="p">).</span><span class="nf">relative_created_at</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">text</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s2">"5 minutes ago"</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<hr />

<h2 id="7-dst--time-zones">7) DST &amp; Time Zones</h2>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="s2">"DST boundary"</span><span class="p">,</span> <span class="ss">type: :system</span> <span class="k">do</span>
  <span class="n">it</span> <span class="s2">"shows local times correctly across DST change"</span> <span class="k">do</span>
    <span class="no">Time</span><span class="p">.</span><span class="nf">use_zone</span><span class="p">(</span><span class="s2">"Europe/Kyiv"</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">freeze_time</span> <span class="no">Time</span><span class="p">.</span><span class="nf">zone</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="s2">"2025-03-30 02:30"</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">visit</span> <span class="n">dashboard_path</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_content</span><span class="p">(</span><span class="s2">"02:30"</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<hr />

<h2 id="8-grace-periods">8) Grace Periods</h2>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Orders</span><span class="o">::</span><span class="no">CancellationPolicy</span> <span class="k">do</span>
  <span class="n">it</span> <span class="s2">"rejects cancellation after 24 hours"</span> <span class="k">do</span>
    <span class="n">freeze_time</span> <span class="k">do</span>
      <span class="n">order</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span><span class="ss">:order</span><span class="p">,</span> <span class="ss">created_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">current</span><span class="p">)</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">described_class</span><span class="p">.</span><span class="nf">allowed?</span><span class="p">(</span><span class="n">order</span><span class="p">)).</span><span class="nf">to</span> <span class="n">be</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">travel</span> <span class="mi">25</span><span class="p">.</span><span class="nf">hours</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">described_class</span><span class="p">.</span><span class="nf">allowed?</span><span class="p">(</span><span class="no">Order</span><span class="p">.</span><span class="nf">last</span><span class="p">)).</span><span class="nf">to</span> <span class="n">be</span><span class="p">(</span><span class="kp">false</span><span class="p">)</span>
  <span class="k">ensure</span>
    <span class="n">travel_back</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<hr />

<h2 id="9-deterministic-factories">9) Deterministic Factories</h2>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">AttachmentBlueprint</span> <span class="k">do</span>
  <span class="n">it</span> <span class="s2">"serializes with fixed timestamps"</span> <span class="k">do</span>
    <span class="n">freeze_time</span> <span class="k">do</span>
      <span class="n">attachment</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span><span class="ss">:attachment</span><span class="p">,</span> <span class="ss">:with_file</span><span class="p">)</span>
      <span class="n">json</span> <span class="o">=</span> <span class="no">AttachmentBlueprint</span><span class="p">.</span><span class="nf">render_as_hash</span><span class="p">(</span><span class="n">attachment</span><span class="p">)</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">json</span><span class="p">[</span><span class="ss">:created_at</span><span class="p">]).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="no">Time</span><span class="p">.</span><span class="nf">current</span><span class="p">.</span><span class="nf">iso8601</span><span class="p">)</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">json</span><span class="p">[</span><span class="ss">:updated_at</span><span class="p">]).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="no">Time</span><span class="p">.</span><span class="nf">current</span><span class="p">.</span><span class="nf">iso8601</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<hr />

<h2 id="freeze_time-vs-travel_to-vs-travel">freeze_time vs travel_to vs travel</h2>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">freeze_time</code></strong> – Freeze the current time and keep it from moving.</li>
  <li><strong><code class="language-plaintext highlighter-rouge">travel_to(time)</code></strong> – Set the current time to a specific instant.</li>
  <li><strong><code class="language-plaintext highlighter-rouge">travel(duration)</code></strong> – Move the clock forward/back.</li>
</ul>

<hr />

<h2 id="pitfalls">Pitfalls</h2>

<ol>
  <li>Use <code class="language-plaintext highlighter-rouge">Time.current</code> instead of <code class="language-plaintext highlighter-rouge">Time.now</code>.</li>
  <li>DB-side NOW() is not affected by Ruby helpers.</li>
  <li>Always <code class="language-plaintext highlighter-rouge">travel_back</code> if not using block form.</li>
  <li>Watch out for libs reading OS time.</li>
  <li>Be careful with DST.</li>
</ol>

<hr />

<h2 id="final-thoughts">Final Thoughts</h2>

<p><code class="language-plaintext highlighter-rouge">freeze_time</code> reduces flakiness, makes assertions crisp, and keeps tests fast. If your tests depend on the current moment, wrap them in <code class="language-plaintext highlighter-rouge">freeze_time</code> and combine with <code class="language-plaintext highlighter-rouge">travel</code> for simulating time passage.</p>

<p>Happy testing!</p>

    </div>
  </div>

  <!-- Post navigation (Previous/Next) -->
  
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      
      
      
      
      

  <nav class="post-navigation">
    
      <a href="/blog/rails-under-the-hood" class="post-nav-link post-nav-prev">
        <span class="post-nav-label">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="19" y1="12" x2="5" y2="12"/>
            <polyline points="12 19 5 12 12 5"/>
          </svg>
          Older
        </span>
        <span class="post-nav-title">Under-the-Hood Mechanisms of Ruby on Rails You Should...</span>
      </a>
    
    
      <a href="/blog/rails-8-stable-up-health-endpoint-env-driven" class="post-nav-link post-nav-next">
        <span class="post-nav-label">
          Newer
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="5" y1="12" x2="19" y2="12"/>
            <polyline points="12 5 19 12 12 19"/>
          </svg>
        </span>
        <span class="post-nav-title">Rails 8: A Stable `/up` Health Endpoint with...</span>
      </a>
    
  </nav>

  <!-- Back to top button -->
  <button id="back-to-top" class="back-to-top" onclick="window.scrollTo({top: 0, behavior: 'smooth'})" title="Back to top" aria-label="Back to top">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <line x1="12" y1="19" x2="12" y2="5"/>
      <polyline points="5 12 12 5 19 12"/>
    </svg>
  </button>
</article>

<script>
  // Show/hide back-to-top button based on scroll position
  const backToTop = document.getElementById('back-to-top');
  window.addEventListener('scroll', function() {
    if (window.scrollY > 400) {
      backToTop.classList.add('visible');
    } else {
      backToTop.classList.remove('visible');
    }
  });

  // Reading progress bar
  const progressBar = document.getElementById('reading-progress');
  const article = document.querySelector('.post-article');

  window.addEventListener('scroll', function() {
    const articleTop = article.offsetTop;
    const articleHeight = article.offsetHeight;
    const windowHeight = window.innerHeight;
    const scrolled = window.scrollY - articleTop + windowHeight * 0.3;
    const progress = Math.min(Math.max(scrolled / articleHeight * 100, 0), 100);
    progressBar.style.width = progress + '%';
  });

  // Generate Table of Contents
  const postContent = document.getElementById('post-content');
  const tocList = document.getElementById('toc-list');
  const tocSidebar = document.getElementById('toc-sidebar');
  const headings = postContent.querySelectorAll('h2, h3');

  if (headings.length >= 4) {
    tocSidebar.classList.add('visible');

    headings.forEach((heading, index) => {
      // Add ID to heading if not present
      if (!heading.id) {
        heading.id = 'heading-' + index;
      }

      const li = document.createElement('li');
      li.className = 'toc-item toc-' + heading.tagName.toLowerCase();

      const a = document.createElement('a');
      a.href = '#' + heading.id;
      a.textContent = heading.textContent;
      a.className = 'toc-link';

      li.appendChild(a);
      tocList.appendChild(li);
    });

    // Highlight current section in TOC
    const tocLinks = document.querySelectorAll('.toc-link');

    const observerOptions = {
      rootMargin: '-80px 0px -70% 0px'
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          tocLinks.forEach(link => link.classList.remove('active'));
          const activeLink = document.querySelector('.toc-link[href="#' + entry.target.id + '"]');
          if (activeLink) activeLink.classList.add('active');
        }
      });
    }, observerOptions);

    headings.forEach(heading => observer.observe(heading));
  }

  // Add copy buttons and language labels to code blocks
  document.querySelectorAll('.highlight, pre').forEach(element => {
    // Skip if already wrapped or if this is a pre inside a highlight we'll process
    if (element.closest('.code-block-wrapper')) return;
    if (element.tagName === 'PRE' && element.closest('.highlight')) return;

    // Determine what to wrap: the .highlight div or standalone pre
    const highlightDiv = element.classList.contains('highlight') ? element : null;
    const pre = highlightDiv ? highlightDiv.querySelector('pre') : element;
    if (!pre) return;

    const wrapper = document.createElement('div');
    wrapper.className = 'code-block-wrapper';

    // Wrap the highlight div if exists, otherwise wrap pre
    const toWrap = highlightDiv || pre;
    toWrap.parentNode.insertBefore(wrapper, toWrap);
    wrapper.appendChild(toWrap);

    // Detect language from class
    const code = pre.querySelector('code');
    let language = '';

    // Method 1: Check code element class
    if (code && code.className) {
      const match = code.className.match(/language-(\w+)/);
      if (match) language = match[1];
    }

    // Method 2: Check highlight div class (Rouge uses class like "highlight ruby")
    if (!language && highlightDiv) {
      const classes = highlightDiv.className.split(' ');
      for (const cls of classes) {
        if (cls !== 'highlight' && cls.length > 0 && !cls.startsWith('code')) {
          language = cls;
          break;
        }
      }
    }

    // Method 3: Try to detect from code patterns
    if (!language) {
      const text = pre.textContent.trim();
      if (text.startsWith('#') && !text.startsWith('#!/')) {
        const firstLine = text.split('\n')[0];
        if (firstLine.match(/\.rb$/)) language = 'ruby';
        else if (firstLine.match(/\.py$/)) language = 'python';
        else if (firstLine.match(/\.yml$|\.yaml$/)) language = 'yaml';
      } else if (text.startsWith('//')) {
        language = 'javascript';
      } else if (text.match(/^(RSpec|describe|it|context|let)\b/)) {
        language = 'ruby';
      } else if (text.match(/^(def |class |module |require )/)) {
        language = 'ruby';
      }
    }

    // Create header with language and copy button
    const header = document.createElement('div');
    header.className = 'code-block-header';

    if (language) {
      const langLabel = document.createElement('span');
      langLabel.className = 'code-lang';
      langLabel.textContent = language;
      header.appendChild(langLabel);
    }

    const copyBtn = document.createElement('button');
    copyBtn.className = 'code-copy-btn';
    copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg><span>Copy</span>';
    copyBtn.onclick = async function() {
      const text = pre.textContent;
      try {
        await navigator.clipboard.writeText(text);
        copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg><span>Copied!</span>';
        copyBtn.classList.add('copied');
        setTimeout(() => {
          copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg><span>Copy</span>';
          copyBtn.classList.remove('copied');
        }, 2000);
      } catch (err) {
        console.error('Failed to copy:', err);
      }
    };
    header.appendChild(copyBtn);

    // Insert header at the start of wrapper (before the highlight/pre)
    wrapper.insertBefore(header, wrapper.firstChild);
  });
</script>

    </main>

    <footer class="site-footer">
      <div class="footer-content">
  <div class="footer-links">
    <a href="/feed.xml" title="RSS Feed" class="footer-icon-link">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M4 11a9 9 0 0 1 9 9"/>
        <path d="M4 4a16 16 0 0 1 16 16"/>
        <circle cx="5" cy="19" r="1"/>
      </svg>
    </a>
    <span class="footer-divider">·</span>
    <button id="theme-btn" onclick="toggleTheme()" class="theme-toggle-btn" title="Toggle theme (press T)" aria-label="Toggle theme" aria-live="polite">
      <svg class="moon-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"/>
      </svg>
      <svg class="sun-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M14.828 14.828a4 4 0 1 0 -5.656 -5.656a4 4 0 0 0 5.656 5.656z"/>
        <path d="M6.343 17.657l-1.414 1.414"/>
        <path d="M6.343 6.343l-1.414 -1.414"/>
        <path d="M17.657 6.343l1.414 -1.414"/>
        <path d="M17.657 17.657l1.414 1.414"/>
        <path d="M4 12h-2"/>
        <path d="M12 4v-2"/>
        <path d="M20 12h2"/>
        <path d="M12 20v2"/>
      </svg>
    </button>
  </div>
</div>

    </footer>
  </div>

  <script>
    // Theme toggle
    function toggleTheme() {
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

      // Use View Transitions API if available
      if (document.startViewTransition) {
        document.startViewTransition(() => {
          html.setAttribute('data-theme', newTheme);
          localStorage.setItem('theme', newTheme);
        });
      } else {
        html.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
      }
    }

    // Keyboard shortcut: press 't' to toggle theme
    document.addEventListener('keydown', function(e) {
      // Don't trigger if user is typing in an input/textarea
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
        return;
      }
      if (e.key === 't' || e.key === 'T') {
        toggleTheme();
      }
    });
  </script>
</body>
</html>
