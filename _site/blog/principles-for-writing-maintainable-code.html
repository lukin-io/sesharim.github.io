<!DOCTYPE html>
<html lang="en">
<head>
  <!-- View Transitions API -->
  <meta name="view-transition" content="same-origin">
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-VLFHH5CPGM"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-VLFHH5CPGM');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <title>Principles for Writing Maintainable Code | Software Engineering consultant</title>
  
  <meta name="theme-color" content="#006cac">

  <link rel="canonical" href="http://localhost:4000/blog/principles-for-writing-maintainable-code">
  <link rel="alternate" type="application/rss+xml" title="Software Engineering consultant" href="http://localhost:4000/feed.xml" />
  <link rel="shortcut icon" type="image/png" href="http://localhost:4000/favicon.png">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Stylesheets -->
  <link rel="stylesheet" href="/assets/css/global.css">
  <link rel="stylesheet" href="/assets/css/custom.css">
  <link rel="stylesheet" href="/assets/css/typography.css">

  <meta name="description"
    content="Applications always change. This post collects practical principles and Rails‑friendly patterns I use to keep code maintainable over the long run—leaning on ...">
  <meta name="keywords"
    content="Software Engineering consultant, programming consultant, Ruby web development, agile Ruby development, Ruby on Rails web design, RoR consulting, Ruby on Rails service, RoR consultant, Ruby on Rails NYC, Ruby on Rails expertise, web agency, ios application development, mobile, api, frontend, backend, development, software engineer partner, sf developer, sf ruby on rails, berling ruby consultant, london consultant">
  <meta name="author" content="Max Lukin">

  <!-- Theme initialization - prevent flash -->
  <script>
    (function() {
      const savedTheme = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const theme = savedTheme || (prefersDark ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Principles for Writing Maintainable Code | Software Engineering consultant</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Principles for Writing Maintainable Code" />
<meta name="author" content="Max Lukin" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Applications always change. This post collects practical principles and Rails‑friendly patterns I use to keep code maintainable over the long run—leaning on Ruby on Rails conventions, small POROs, and simple seams you can scale as your app (or game) grows." />
<meta property="og:description" content="Applications always change. This post collects practical principles and Rails‑friendly patterns I use to keep code maintainable over the long run—leaning on Ruby on Rails conventions, small POROs, and simple seams you can scale as your app (or game) grows." />
<link rel="canonical" href="http://localhost:4000/blog/principles-for-writing-maintainable-code" />
<meta property="og:url" content="http://localhost:4000/blog/principles-for-writing-maintainable-code" />
<meta property="og:site_name" content="Software Engineering consultant" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-09-12T17:00:00+05:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Principles for Writing Maintainable Code" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Max Lukin"},"dateModified":"2020-09-12T17:00:00+05:00","datePublished":"2020-09-12T17:00:00+05:00","description":"Applications always change. This post collects practical principles and Rails‑friendly patterns I use to keep code maintainable over the long run—leaning on Ruby on Rails conventions, small POROs, and simple seams you can scale as your app (or game) grows.","headline":"Principles for Writing Maintainable Code","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/blog/principles-for-writing-maintainable-code"},"url":"http://localhost:4000/blog/principles-for-writing-maintainable-code"}</script>
<!-- End Jekyll SEO tag -->

</head>


<body>
  <!-- Main content wrapper -->
  <div class="main-wrapper centered">
    <main>
      <!-- Reading progress bar -->
<div class="reading-progress" id="reading-progress"></div>

<article class="post-article">
  <!-- Back navigation -->
  <a href="/blog" class="back-home">
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M19 20H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v1m2 13a2 2 0 0 1-2-2V7m2 13a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-2m-4-3H9M7 16h6M7 12h10"/>
    </svg>
    <span>Blog</span>
  </a>

  <!-- Post header -->
  <header class="post-header">
    <h1 class="post-title">Principles for Writing Maintainable Code</h1>
    <div class="post-meta">
      <time datetime="2020-09-12T17:00:00+05:00">Sep 12, 2020</time>
      
      
      
      <span>· 9 min read</span>
      
        <span>· Max Lukin</span>
      
      
        <span class="post-tags"></span>
      
    </div>
  </header>

  <div class="post-body">
    <!-- Table of Contents (generated by JS for posts with 4+ headings) -->
    <aside class="toc-sidebar" id="toc-sidebar">
      <nav class="toc" id="toc">
        <div class="toc-title">Contents</div>
        <ul class="toc-list" id="toc-list"></ul>
      </nav>
    </aside>

    <!-- Post content -->
    <div class="prose post-content" id="post-content">
      <p>Applications always change. This post collects <strong>practical principles and Rails‑friendly patterns</strong> I use to keep code maintainable over the long run—leaning on Ruby on Rails conventions, small POROs, and simple seams you can scale as your app (or game) grows.</p>

<blockquote>
  <p><strong>What’s new in this revision?</strong>
It expands the original article with concrete Rails examples, explains how to apply the ideas in production code, and adds a checklist you can drop into your workflow <em>today</em>. It also aligns examples with a modern Rails monolith (Hotwire/Turbo, API responses via Blueprinter, presenters, and snake_case JSON keys).</p>
</blockquote>

<hr />

<h2 id="at-a-glance-the-roadmap">At a glance: the roadmap</h2>

<ol>
  <li><strong>Foundations</strong> — KISS, DRY, YAGNI, SOLID, Law of Demeter, TRUE, Rails Way, PORO.</li>
  <li><strong>Rails‑friendly “seams”</strong> — Query Objects (CQS), Service Objects (idempotent + transactional), Domain Events, Ports &amp; Adapters.</li>
  <li><strong>Presentation boundaries</strong> — Blueprinter &amp; Presenters for clean JSON/UI separation.</li>
  <li><strong>Safety &amp; speed</strong> — Transactions, invariants, observability, performance, security.</li>
  <li><strong>Tests &amp; docs</strong> — BDD/TDD, contract tests, ADRs.</li>
  <li><strong>How to use these in your app</strong> — short, copy‑paste examples.</li>
  <li><strong>Checklist</strong> — adopt in small steps.</li>
</ol>

<hr />

<h1 id="1-foundations">1) Foundations</h1>

<p>Below, each principle is shown as <strong>Action → Rule → Example → Explanation</strong>.</p>

<h3 id="11-kiss-keep-it-simple-stupid-rails-way-of-saying-convention-over-configuration">1.1 KISS (Keep it simple, stupid) [Rail’s way of saying “convention over configuration”]</h3>
<p><strong>Action →</strong> Prefer the obvious Rails convention before inventing a custom abstraction.
<strong>Rule →</strong> Reach for generators, models, concerns, presenters before custom frameworks.
<strong>Example →</strong> Don’t build a custom background job runner when Active Job + Sidekiq works.
<strong>Explanation →</strong> Simplicity reduces maintenance and makes it easy for teammates to help.</p>

<h3 id="12-dry-dont-repeat-yourself-dry">1.2 DRY (Don’t Repeat Yourself) <a href="https://en.wikipedia.org/wiki/Don%27t_repeat_yourself">dry</a></h3>
<p><strong>Action →</strong> Extract <em>stable</em> duplication—the stuff that’s obviously the same.
<strong>Rule →</strong> Duplicate twice, abstract on the third (see AHA/Rule‑of‑Three below).
<strong>Example →</strong> Extract shared JSON serialization into a Blueprint (see §3).
<strong>Explanation →</strong> DRY keeps behavior consistent and reduces bug surface area.</p>

<h3 id="13-yagni-you-arent-gonna-need-it-yagni--aha-avoid-hasty-abstractions">1.3 YAGNI (You Aren’t Gonna Need It) <a href="https://en.wikipedia.org/wiki/You_aren%27t_gonna_need_it">yagni</a> + AHA (Avoid Hasty Abstractions)</h3>
<p><strong>Action →</strong> Ship the simplest thing that works for the next milestone.
<strong>Rule →</strong> Prefer a small, local duplication over a premature base class.
<strong>Example →</strong> Keep <code class="language-plaintext highlighter-rouge">MeleeDamageCalculator</code> and <code class="language-plaintext highlighter-rouge">MagicDamageCalculator</code> separate until a third type appears.
<strong>Explanation →</strong> You can always generalize later—after you see the real pattern.</p>

<h3 id="14-solid-oo-design-guardrails">1.4 SOLID (OO design guardrails)</h3>
<p><strong>Action →</strong> Design objects with one job, and depend on interfaces, not implementations.
<strong>Rule →</strong> SRP, OCP, LSP, ISP, DIP guide refactors and extensions.
<strong>Example →</strong> A <code class="language-plaintext highlighter-rouge">GrantGold</code> service updates balances; it <em>publishes</em> an event instead of directly sending notifications (DIP).
<strong>Explanation →</strong> SOLID keeps modules extensible without ripple effects.</p>

<h3 id="15-law-of-demeter-lod">1.5 Law of Demeter (LoD)</h3>
<p><strong>Action →</strong> Ask objects to <em>do things</em>; avoid “train‑wreck” calls (<code class="language-plaintext highlighter-rouge">a.b.c.d</code>).
<strong>Rule →</strong> Talk to friends, not strangers; hide internal structure.
<strong>Example →</strong> Provide <code class="language-plaintext highlighter-rouge">character.inventory.overweight?</code> instead of summing item weights externally.
<strong>Explanation →</strong> Reduces coupling and eases refactors.</p>

<h3 id="16-true-code-transparent-reasonable-usable-exemplary">1.6 TRUE Code (Transparent, Reasonable, Usable, Exemplary)</h3>
<p><strong>Action →</strong> Make the consequences of change obvious and local.
<strong>Rule →</strong> Favor small, well‑named methods and data structures.
<strong>Example →</strong> A Query Object that says what it returns in its name and docstring.
<strong>Explanation →</strong> TRUE code supports today’s features and tomorrow’s changes.</p>

<h3 id="17-rails-way--poro">1.7 Rails Way + PORO</h3>
<p><strong>Action →</strong> Start with Rails primitives; move domain logic to POROs as it grows.
<strong>Rule →</strong> Keep controllers thin, models focused, services/presenters clear.
<strong>Example →</strong> Business rules in <code class="language-plaintext highlighter-rouge">app/services/…</code> and <code class="language-plaintext highlighter-rouge">app/queries/…</code>, rendering in Blueprints/Presenters.
<strong>Explanation →</strong> Balances Rails productivity with separation of concerns.</p>

<hr />

<h1 id="2-railsfriendly-seams">2) Rails‑friendly “seams”</h1>

<h2 id="21-query-objects-cqs-separate-reads-from-writes">2.1 Query Objects (CQS: separate reads from writes)</h2>
<p><strong>Action →</strong> Put non‑trivial reads in PORO query objects; commands mutate, queries don’t.</p>

<p><strong><code class="language-plaintext highlighter-rouge">app/queries/top_guilds_by_power_query.rb</code></strong></p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Example usage:</span>
<span class="c1">#   TopGuildsByPowerQuery.call(limit: 10)</span>
<span class="c1"># Returns:</span>
<span class="c1">#   ActiveRecord::Relation&lt;Guild&gt; ordered by total_power desc, limited.</span>
<span class="k">class</span> <span class="nc">TopGuildsByPowerQuery</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">call</span><span class="p">(</span><span class="n">limit</span><span class="p">:)</span>
    <span class="no">Guild</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="s1">'guilds.*, SUM(players.power) AS total_power'</span><span class="p">)</span>
         <span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:players</span><span class="p">)</span>
         <span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="s1">'guilds.id'</span><span class="p">)</span>
         <span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="s1">'total_power DESC'</span><span class="p">)</span>
         <span class="p">.</span><span class="nf">limit</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="22-service-objects-idempotent-transactional">2.2 Service Objects (idempotent, transactional)</h2>
<p><strong>Action →</strong> Wrap side‑effects in a single transaction; make them safe to retry.</p>

<p><strong><code class="language-plaintext highlighter-rouge">app/models/idempotency_key.rb</code></strong></p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">IdempotencyKey</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">validates</span> <span class="ss">:key</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">uniqueness: </span><span class="kp">true</span>
<span class="k">end</span>
<span class="c1"># Migration: add_index :idempotency_keys, :key, unique: true</span>
</code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">app/services/economy/grant_gold.rb</code></strong></p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">Economy</span>
  <span class="k">class</span> <span class="nc">GrantGold</span>
    <span class="c1"># Example usage:</span>
    <span class="c1">#   Economy::GrantGold.call(</span>
    <span class="c1">#     player_id: 42,</span>
    <span class="c1">#     amount: 100,</span>
    <span class="c1">#     key: "grant_gold:quest:123:player:42"</span>
    <span class="c1">#   )</span>
    <span class="c1"># Returns:</span>
    <span class="c1">#   Player (updated) if applied; Player (unchanged) if idempotency key was already used.</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">call</span><span class="p">(</span><span class="n">player_id</span><span class="p">:,</span> <span class="n">amount</span><span class="p">:,</span> <span class="n">key</span><span class="p">:)</span>
      <span class="n">new</span><span class="p">(</span><span class="n">player_id</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">key</span><span class="p">).</span><span class="nf">call</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">player_id</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
      <span class="vi">@player_id</span><span class="p">,</span> <span class="vi">@amount</span><span class="p">,</span> <span class="vi">@key</span> <span class="o">=</span> <span class="n">player_id</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">key</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">call</span>
      <span class="no">ApplicationRecord</span><span class="p">.</span><span class="nf">transaction</span> <span class="k">do</span>
        <span class="no">IdempotencyKey</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">key: </span><span class="vi">@key</span><span class="p">)</span> <span class="c1"># raises if reused</span>
        <span class="n">player</span> <span class="o">=</span> <span class="no">Player</span><span class="p">.</span><span class="nf">lock</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="vi">@player_id</span><span class="p">)</span>
        <span class="n">player</span><span class="p">.</span><span class="nf">update!</span><span class="p">(</span><span class="ss">current_gold: </span><span class="n">player</span><span class="p">.</span><span class="nf">current_gold</span> <span class="o">+</span> <span class="vi">@amount</span><span class="p">)</span>
        <span class="no">DomainEvents</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span><span class="s1">'economy.gold_granted'</span><span class="p">,</span>
                             <span class="ss">player_id: </span><span class="n">player</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span>
                             <span class="ss">amount: </span><span class="vi">@amount</span><span class="p">,</span>
                             <span class="ss">key: </span><span class="vi">@key</span><span class="p">)</span>
        <span class="n">player</span>
      <span class="k">end</span>
    <span class="k">rescue</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">RecordNotUnique</span>
      <span class="no">Player</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="vi">@player_id</span><span class="p">)</span> <span class="c1"># no‑op: already granted</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="23-domain-events-decouple-via-publishsubscribe">2.3 Domain Events (decouple via publish/subscribe)</h2>
<p><strong>Action →</strong> Publish high‑level events; let subscribers react independently.</p>

<p><strong><code class="language-plaintext highlighter-rouge">app/lib/domain_events.rb</code></strong></p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">DomainEvents</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">publish</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">payload</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Notifications</span><span class="p">.</span><span class="nf">instrument</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Notifications</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span> <span class="k">do</span> <span class="o">|*</span><span class="n">args</span><span class="o">|</span>
      <span class="n">event</span> <span class="o">=</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Notifications</span><span class="o">::</span><span class="no">Event</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
      <span class="n">block</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="nf">payload</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">app/subscribers/analytics/economy_subscriber.rb</code></strong></p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">Analytics</span>
  <span class="k">class</span> <span class="nc">EconomySubscriber</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">boot!</span>
      <span class="no">DomainEvents</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="s1">'economy.gold_granted'</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">payload</span><span class="o">|</span>
        <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="ss">event: </span><span class="s1">'gold_granted'</span><span class="p">,</span>
                          <span class="ss">player_id: </span><span class="n">payload</span><span class="p">[</span><span class="ss">:player_id</span><span class="p">],</span>
                          <span class="ss">amount: </span><span class="n">payload</span><span class="p">[</span><span class="ss">:amount</span><span class="p">])</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">config/initializers/subscribers.rb</code></strong></p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Analytics</span><span class="o">::</span><span class="no">EconomySubscriber</span><span class="p">.</span><span class="nf">boot!</span>
</code></pre></div></div>

<h2 id="24-ports--adapters-hexagonallite">2.4 Ports &amp; Adapters (hexagonal‑lite)</h2>
<p><strong>Action →</strong> Depend on interfaces; swap adapters at the edges.</p>

<p><strong><code class="language-plaintext highlighter-rouge">app/interfaces/notifiers/global_notifier.rb</code></strong></p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">Notifiers</span>
  <span class="k">class</span> <span class="nc">GlobalNotifier</span>
    <span class="c1"># Example usage:</span>
    <span class="c1">#   Notifiers::ActionCableNotifier.new.broadcast("Server restart in 5 minutes")</span>
    <span class="c1"># Returns:</span>
    <span class="c1">#   void</span>
    <span class="k">def</span> <span class="nf">broadcast</span><span class="p">(</span><span class="n">_message</span><span class="p">)</span> <span class="o">=</span> <span class="k">raise</span> <span class="no">NotImplementedError</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">app/adapters/notifiers/action_cable_notifier.rb</code></strong></p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">Notifiers</span>
  <span class="k">class</span> <span class="nc">ActionCableNotifier</span> <span class="o">&lt;</span> <span class="no">GlobalNotifier</span>
    <span class="k">def</span> <span class="nf">broadcast</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
      <span class="no">ActionCable</span><span class="p">.</span><span class="nf">server</span><span class="p">.</span><span class="nf">broadcast</span><span class="p">(</span><span class="s1">'global'</span><span class="p">,</span> <span class="n">message</span><span class="p">:)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<hr />

<h1 id="3-presentation-boundaries-jsonui">3) Presentation boundaries (JSON/UI)</h1>

<p><strong>Goal:</strong> Keep API/UI code out of domain logic; keep JSON keys <strong>snake_case</strong> to match DB fields.</p>

<p><strong><code class="language-plaintext highlighter-rouge">app/blueprints/player_blueprint.rb</code></strong></p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">PlayerBlueprint</span> <span class="o">&lt;</span> <span class="no">Blueprinter</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">identifier</span> <span class="ss">:id</span>

  <span class="n">field</span> <span class="ss">:name</span> <span class="k">do</span> <span class="o">|</span><span class="n">player</span><span class="o">|</span>
    <span class="n">player</span><span class="p">.</span><span class="nf">name</span>
  <span class="k">end</span>

  <span class="n">field</span> <span class="ss">:current_gold</span> <span class="k">do</span> <span class="o">|</span><span class="n">player</span><span class="o">|</span>
    <span class="n">player</span><span class="p">.</span><span class="nf">current_gold</span>
  <span class="k">end</span>

  <span class="n">field</span> <span class="ss">:level</span> <span class="k">do</span> <span class="o">|</span><span class="n">player</span><span class="o">|</span>
    <span class="n">player</span><span class="p">.</span><span class="nf">level</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p><strong>Presenter example (namespaced path):</strong>
<strong><code class="language-plaintext highlighter-rouge">app/presenters/avatars/predefined_avatar.rb</code></strong></p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">Avatars</span>
  <span class="k">class</span> <span class="nc">PredefinedAvatar</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
      <span class="vi">@code</span> <span class="o">=</span> <span class="n">code</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">url</span>
      <span class="s2">"/images/avatars/</span><span class="si">#{</span><span class="vi">@code</span><span class="si">}</span><span class="s2">.png"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<hr />

<h1 id="4-safety-speed--operability">4) Safety, speed &amp; operability</h1>

<h2 id="41-transactions-concurrency--invariants">4.1 Transactions, concurrency &amp; invariants</h2>
<ul>
  <li>Wrap multi‑row updates in a transaction.</li>
  <li>Lock rows you read‑modify‑write (e.g., <code class="language-plaintext highlighter-rouge">Player.lock.find</code>).</li>
  <li>Keep invariant checks close to the data (model validations + DB constraints).</li>
</ul>

<h2 id="42-observability">4.2 Observability</h2>
<ul>
  <li>Add <code class="language-plaintext highlighter-rouge">config.log_tags = [:request_id]</code> in <code class="language-plaintext highlighter-rouge">config/environments/production.rb</code>.</li>
  <li>Prefer structured logs: <code class="language-plaintext highlighter-rouge">Rails.logger.info(event: 'battle_started', player_ids: [p1.id, p2.id])</code>.</li>
  <li>Publish domain events for key actions (see §2.3).</li>
</ul>

<h2 id="43-performance-guardrails">4.3 Performance guardrails</h2>
<ul>
  <li>Paginate by default; beware N+1 (use <code class="language-plaintext highlighter-rouge">includes</code>).</li>
  <li>Cache read‑heavy endpoints; memoize inside request scope.</li>
  <li>Budget queries per request; measure with logs.</li>
</ul>

<h2 id="44-security-defaults">4.4 Security defaults</h2>
<ul>
  <li>Validate/whitelist params; <strong>never</strong> map camelCase to snake_case in controllers—use native <code class="language-plaintext highlighter-rouge">snake_case</code> everywhere.</li>
  <li>Least‑privilege roles; rate‑limit sensitive endpoints.</li>
</ul>

<hr />

<h1 id="5-tests--documentation">5) Tests &amp; documentation</h1>

<h2 id="51-bddtdd-short-feedback-loops">5.1 BDD/TDD (short feedback loops)</h2>
<ul>
  <li>Drive services/queries with fast unit tests.</li>
  <li>Add a few request/system tests for the happy path.</li>
  <li>Use contract tests around external ports (adapters).</li>
</ul>

<h2 id="52-documentationascode">5.2 Documentation‑as‑code</h2>
<ul>
  <li>Keep lightweight ADRs in <code class="language-plaintext highlighter-rouge">doc/adr/</code> to record decisions.</li>
  <li>Add README.md per top‑level folder explaining responsibilities.</li>
</ul>

<hr />

<h1 id="6-how-youll-call-this-from-your-app">6) How you’ll call this from your app</h1>

<p><strong>Grant gold from a controller</strong>
<strong><code class="language-plaintext highlighter-rouge">app/controllers/economy/gold_grants_controller.rb</code></strong></p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">Economy</span>
  <span class="k">class</span> <span class="nc">GoldGrantsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
    <span class="k">def</span> <span class="nf">create</span>
      <span class="n">player</span> <span class="o">=</span> <span class="no">Economy</span><span class="o">::</span><span class="no">GrantGold</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span>
        <span class="ss">player_id: </span><span class="n">params</span><span class="p">[</span><span class="ss">:player_id</span><span class="p">],</span>
        <span class="ss">amount: </span><span class="n">params</span><span class="p">[</span><span class="ss">:amount</span><span class="p">].</span><span class="nf">to_i</span><span class="p">,</span>
        <span class="ss">key: </span><span class="s2">"quest:</span><span class="si">#{</span><span class="n">params</span><span class="p">[</span><span class="ss">:quest_id</span><span class="p">]</span><span class="si">}</span><span class="s2">:grant_gold:player:</span><span class="si">#{</span><span class="n">params</span><span class="p">[</span><span class="ss">:player_id</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
      <span class="p">)</span>

      <span class="n">render</span> <span class="ss">json: </span><span class="no">PlayerBlueprint</span><span class="p">.</span><span class="nf">render</span><span class="p">(</span><span class="n">player</span><span class="p">)</span> <span class="c1"># snake_case keys</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p><strong>Use a query object in a controller</strong>
<strong><code class="language-plaintext highlighter-rouge">app/controllers/guilds_controller.rb</code></strong></p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">GuildsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="n">limit</span>   <span class="o">=</span> <span class="n">params</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="ss">:limit</span><span class="p">,</span> <span class="mi">10</span><span class="p">).</span><span class="nf">to_i</span>
    <span class="vi">@guilds</span> <span class="o">=</span> <span class="no">TopGuildsByPowerQuery</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="ss">limit: </span><span class="n">limit</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p><strong>Notify via a port (adapter injected where needed)</strong></p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">notifier</span> <span class="o">=</span> <span class="no">Notifiers</span><span class="o">::</span><span class="no">ActionCableNotifier</span><span class="p">.</span><span class="nf">new</span>
<span class="n">notifier</span><span class="p">.</span><span class="nf">broadcast</span><span class="p">(</span><span class="s2">"Double XP weekend starts now!"</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h1 id="7-adoption-checklist">7) Adoption checklist</h1>

<ul class="task-list">
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Create <code class="language-plaintext highlighter-rouge">app/services/</code>, <code class="language-plaintext highlighter-rouge">app/queries/</code>, <code class="language-plaintext highlighter-rouge">app/interfaces/</code>, <code class="language-plaintext highlighter-rouge">app/adapters/</code>, <code class="language-plaintext highlighter-rouge">app/subscribers/</code>, <code class="language-plaintext highlighter-rouge">app/blueprints/</code>, <code class="language-plaintext highlighter-rouge">app/presenters/</code>.</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Add <code class="language-plaintext highlighter-rouge">IdempotencyKey</code> + unique index on <code class="language-plaintext highlighter-rouge">key</code>.</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Convert one heavy controller scope into a <strong>Query Object</strong>.</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Wrap one risky write in a <strong>Service</strong> with transaction + row lock.</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" /><strong>Publish one Domain Event</strong> and log a subscriber reaction.</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Introduce one <strong>Port</strong> (notifier) and one <strong>Adapter</strong> (ActionCable).</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Move one JSON response to <strong>Blueprinter</strong> (multi‑line fields).</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Turn on structured logging with <code class="language-plaintext highlighter-rouge">request_id</code>.</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Delete obsolete files after refactors (keep PRs small and reversible).</li>
</ul>

<hr />

<p><em>Eating your own dog food</em> matters too—use your own API/UI flows end‑to‑end to feel the rough edges daily. <a href="https://en.wikipedia.org/wiki/Eating_your_own_dog_food">eyodf</a></p>

<hr />


    </div>
  </div>

  <!-- Post navigation (Previous/Next) -->
  
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      
      
      
      
      

  <nav class="post-navigation">
    
      <span class="post-nav-spacer"></span>
    
    
      <a href="/blog/minimalism-war-family-and-lessons" class="post-nav-link post-nav-next">
        <span class="post-nav-label">
          Newer
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="5" y1="12" x2="19" y2="12"/>
            <polyline points="12 5 19 12 12 19"/>
          </svg>
        </span>
        <span class="post-nav-title">Minimalism, Family, war and lessons</span>
      </a>
    
  </nav>

  <!-- Back to top button -->
  <button id="back-to-top" class="back-to-top" onclick="window.scrollTo({top: 0, behavior: 'smooth'})" title="Back to top" aria-label="Back to top">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <line x1="12" y1="19" x2="12" y2="5"/>
      <polyline points="5 12 12 5 19 12"/>
    </svg>
  </button>
</article>

<script>
  // Show/hide back-to-top button based on scroll position
  const backToTop = document.getElementById('back-to-top');
  window.addEventListener('scroll', function() {
    if (window.scrollY > 400) {
      backToTop.classList.add('visible');
    } else {
      backToTop.classList.remove('visible');
    }
  });

  // Reading progress bar
  const progressBar = document.getElementById('reading-progress');
  const article = document.querySelector('.post-article');

  window.addEventListener('scroll', function() {
    const articleTop = article.offsetTop;
    const articleHeight = article.offsetHeight;
    const windowHeight = window.innerHeight;
    const scrolled = window.scrollY - articleTop + windowHeight * 0.3;
    const progress = Math.min(Math.max(scrolled / articleHeight * 100, 0), 100);
    progressBar.style.width = progress + '%';
  });

  // Generate Table of Contents
  const postContent = document.getElementById('post-content');
  const tocList = document.getElementById('toc-list');
  const tocSidebar = document.getElementById('toc-sidebar');
  const headings = postContent.querySelectorAll('h2, h3');

  if (headings.length >= 4) {
    tocSidebar.classList.add('visible');

    headings.forEach((heading, index) => {
      // Add ID to heading if not present
      if (!heading.id) {
        heading.id = 'heading-' + index;
      }

      const li = document.createElement('li');
      li.className = 'toc-item toc-' + heading.tagName.toLowerCase();

      const a = document.createElement('a');
      a.href = '#' + heading.id;
      a.textContent = heading.textContent;
      a.className = 'toc-link';

      li.appendChild(a);
      tocList.appendChild(li);
    });

    // Highlight current section in TOC
    const tocLinks = document.querySelectorAll('.toc-link');

    const observerOptions = {
      rootMargin: '-80px 0px -70% 0px'
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          tocLinks.forEach(link => link.classList.remove('active'));
          const activeLink = document.querySelector('.toc-link[href="#' + entry.target.id + '"]');
          if (activeLink) activeLink.classList.add('active');
        }
      });
    }, observerOptions);

    headings.forEach(heading => observer.observe(heading));
  }

  // Add copy buttons and language labels to code blocks
  document.querySelectorAll('.highlight, pre').forEach(element => {
    // Skip if already wrapped or if this is a pre inside a highlight we'll process
    if (element.closest('.code-block-wrapper')) return;
    if (element.tagName === 'PRE' && element.closest('.highlight')) return;

    // Determine what to wrap: the .highlight div or standalone pre
    const highlightDiv = element.classList.contains('highlight') ? element : null;
    const pre = highlightDiv ? highlightDiv.querySelector('pre') : element;
    if (!pre) return;

    const wrapper = document.createElement('div');
    wrapper.className = 'code-block-wrapper';

    // Wrap the highlight div if exists, otherwise wrap pre
    const toWrap = highlightDiv || pre;
    toWrap.parentNode.insertBefore(wrapper, toWrap);
    wrapper.appendChild(toWrap);

    // Detect language from class
    const code = pre.querySelector('code');
    let language = '';

    // Method 1: Check code element class
    if (code && code.className) {
      const match = code.className.match(/language-(\w+)/);
      if (match) language = match[1];
    }

    // Method 2: Check highlight div class (Rouge uses class like "highlight ruby")
    if (!language && highlightDiv) {
      const classes = highlightDiv.className.split(' ');
      for (const cls of classes) {
        if (cls !== 'highlight' && cls.length > 0 && !cls.startsWith('code')) {
          language = cls;
          break;
        }
      }
    }

    // Method 3: Try to detect from code patterns
    if (!language) {
      const text = pre.textContent.trim();
      if (text.startsWith('#') && !text.startsWith('#!/')) {
        const firstLine = text.split('\n')[0];
        if (firstLine.match(/\.rb$/)) language = 'ruby';
        else if (firstLine.match(/\.py$/)) language = 'python';
        else if (firstLine.match(/\.yml$|\.yaml$/)) language = 'yaml';
      } else if (text.startsWith('//')) {
        language = 'javascript';
      } else if (text.match(/^(RSpec|describe|it|context|let)\b/)) {
        language = 'ruby';
      } else if (text.match(/^(def |class |module |require )/)) {
        language = 'ruby';
      }
    }

    // Create header with language and copy button
    const header = document.createElement('div');
    header.className = 'code-block-header';

    if (language) {
      const langLabel = document.createElement('span');
      langLabel.className = 'code-lang';
      langLabel.textContent = language;
      header.appendChild(langLabel);
    }

    const copyBtn = document.createElement('button');
    copyBtn.className = 'code-copy-btn';
    copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg><span>Copy</span>';
    copyBtn.onclick = async function() {
      const text = pre.textContent;
      try {
        await navigator.clipboard.writeText(text);
        copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg><span>Copied!</span>';
        copyBtn.classList.add('copied');
        setTimeout(() => {
          copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg><span>Copy</span>';
          copyBtn.classList.remove('copied');
        }, 2000);
      } catch (err) {
        console.error('Failed to copy:', err);
      }
    };
    header.appendChild(copyBtn);

    // Insert header at the start of wrapper (before the highlight/pre)
    wrapper.insertBefore(header, wrapper.firstChild);
  });
</script>

    </main>

    <footer class="site-footer">
      <div class="footer-content">
  <div class="footer-links">
    <a href="/feed.xml" title="RSS Feed" class="footer-icon-link">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M4 11a9 9 0 0 1 9 9"/>
        <path d="M4 4a16 16 0 0 1 16 16"/>
        <circle cx="5" cy="19" r="1"/>
      </svg>
    </a>
    <span class="footer-divider">·</span>
    <button id="theme-btn" onclick="toggleTheme()" class="theme-toggle-btn" title="Toggle theme (press T)" aria-label="Toggle theme" aria-live="polite">
      <svg class="moon-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"/>
      </svg>
      <svg class="sun-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M14.828 14.828a4 4 0 1 0 -5.656 -5.656a4 4 0 0 0 5.656 5.656z"/>
        <path d="M6.343 17.657l-1.414 1.414"/>
        <path d="M6.343 6.343l-1.414 -1.414"/>
        <path d="M17.657 6.343l1.414 -1.414"/>
        <path d="M17.657 17.657l1.414 1.414"/>
        <path d="M4 12h-2"/>
        <path d="M12 4v-2"/>
        <path d="M20 12h2"/>
        <path d="M12 20v2"/>
      </svg>
    </button>
  </div>
</div>

    </footer>
  </div>

  <script>
    // Theme toggle
    function toggleTheme() {
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

      // Use View Transitions API if available
      if (document.startViewTransition) {
        document.startViewTransition(() => {
          html.setAttribute('data-theme', newTheme);
          localStorage.setItem('theme', newTheme);
        });
      } else {
        html.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
      }
    }

    // Keyboard shortcut: press 't' to toggle theme
    document.addEventListener('keydown', function(e) {
      // Don't trigger if user is typing in an input/textarea
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
        return;
      }
      if (e.key === 't' || e.key === 'T') {
        toggleTheme();
      }
    });
  </script>
</body>
</html>
