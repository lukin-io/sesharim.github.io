<!DOCTYPE html>
<html lang="en">
<head>
  <!-- View Transitions API -->
  <meta name="view-transition" content="same-origin">
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-VLFHH5CPGM"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-VLFHH5CPGM');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <title>Rails 8: A Stable `/up` Health Endpoint with One Initializer (ENV‑driven) | Software Engineering consultant</title>
  
  <meta name="theme-color" content="#006cac">

  <link rel="canonical" href="http://localhost:4000/blog/rails-8-stable-up-health-endpoint-env-driven">
  <link rel="alternate" type="application/rss+xml" title="Software Engineering consultant" href="http://localhost:4000/feed.xml" />
  <link rel="shortcut icon" type="image/png" href="http://localhost:4000/favicon.png">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Stylesheets -->
  <link rel="stylesheet" href="/assets/css/global.css">
  <link rel="stylesheet" href="/assets/css/custom.css">
  <link rel="stylesheet" href="/assets/css/typography.css">

  <meta name="description"
    content="A battle-tested, copy‑paste `/up` endpoint for Rails API apps—no autoloading traps, no brittle config. One initializer, ENV‑driven settings, optional DB/Redi...">
  <meta name="keywords"
    content="Software Engineering consultant, programming consultant, Ruby web development, agile Ruby development, Ruby on Rails web design, RoR consulting, Ruby on Rails service, RoR consultant, Ruby on Rails NYC, Ruby on Rails expertise, web agency, ios application development, mobile, api, frontend, backend, development, software engineer partner, sf developer, sf ruby on rails, berling ruby consultant, london consultant">
  <meta name="author" content="Max Lukin">

  <!-- Theme initialization - prevent flash -->
  <script>
    (function() {
      const savedTheme = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const theme = savedTheme || (prefersDark ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Rails 8: A Stable /up Health Endpoint with One Initializer (ENV‑driven) | Software Engineering consultant</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Rails 8: A Stable /up Health Endpoint with One Initializer (ENV‑driven)" />
<meta name="author" content="Max Lukin" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A battle-tested, copy‑paste /up endpoint for Rails API apps—no autoloading traps, no brittle config. One initializer, ENV‑driven settings, optional DB/Redis checks, clear status semantics, and end‑to‑end tests." />
<meta property="og:description" content="A battle-tested, copy‑paste /up endpoint for Rails API apps—no autoloading traps, no brittle config. One initializer, ENV‑driven settings, optional DB/Redis checks, clear status semantics, and end‑to‑end tests." />
<link rel="canonical" href="http://localhost:4000/blog/rails-8-stable-up-health-endpoint-env-driven" />
<meta property="og:url" content="http://localhost:4000/blog/rails-8-stable-up-health-endpoint-env-driven" />
<meta property="og:site_name" content="Software Engineering consultant" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-08-14T15:00:00+03:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Rails 8: A Stable /up Health Endpoint with One Initializer (ENV‑driven)" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Max Lukin"},"dateModified":"2025-08-14T15:00:00+03:00","datePublished":"2025-08-14T15:00:00+03:00","description":"A battle-tested, copy‑paste /up endpoint for Rails API apps—no autoloading traps, no brittle config. One initializer, ENV‑driven settings, optional DB/Redis checks, clear status semantics, and end‑to‑end tests.","headline":"Rails 8: A Stable /up Health Endpoint with One Initializer (ENV‑driven)","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/blog/rails-8-stable-up-health-endpoint-env-driven"},"url":"http://localhost:4000/blog/rails-8-stable-up-health-endpoint-env-driven"}</script>
<!-- End Jekyll SEO tag -->

</head>


<body>
  <!-- Main content wrapper -->
  <div class="main-wrapper centered">
    <main>
      <!-- Reading progress bar -->
<div class="reading-progress" id="reading-progress"></div>

<article class="post-article">
  <!-- Back navigation -->
  <a href="/blog" class="back-home">
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M19 20H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v1m2 13a2 2 0 0 1-2-2V7m2 13a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-2m-4-3H9M7 16h6M7 12h10"/>
    </svg>
    <span>Blog</span>
  </a>

  <!-- Post header -->
  <header class="post-header">
    <h1 class="post-title">Rails 8: A Stable `/up` Health Endpoint with One Initializer (ENV‑driven)</h1>
    <div class="post-meta">
      <time datetime="2025-08-14T15:00:00+03:00">Aug 14, 2025</time>
      
      
      
      <span>· 15 min read</span>
      
        <span>· Max Lukin</span>
      
      
        <span class="post-tags"><a href="/search?q=rails-8" class="tag">rails-8</a><a href="/search?q=rack" class="tag">rack</a><a href="/search?q=healthcheck" class="tag">healthcheck</a><a href="/search?q=devops" class="tag">devops</a><a href="/search?q=reliability" class="tag">reliability</a></span>
      
    </div>
  </header>

  <div class="post-body">
    <!-- Table of Contents (generated by JS for posts with 4+ headings) -->
    <aside class="toc-sidebar" id="toc-sidebar">
      <nav class="toc" id="toc">
        <div class="toc-title">Contents</div>
        <ul class="toc-list" id="toc-list"></ul>
      </nav>
    </aside>

    <!-- Post content -->
    <div class="prose post-content" id="post-content">
      <blockquote>
  <p><strong>TL;DR</strong>: This post shows a <strong>stable</strong> and <strong>simple</strong> health endpoint for Rails (<code class="language-plaintext highlighter-rouge">/up</code>) implemented as a tiny Rack component defined <strong>inside one initializer</strong>. It reads config from <strong>ENV</strong> (deployment‑friendly), supports optional <strong>DB</strong>/<strong>Redis</strong> checks, emits JSON, and lets you choose whether failures return <strong>503</strong> or just mark the response as <strong>degraded</strong>. Includes cURL examples and RSpec tests.</p>
</blockquote>

<hr />

<h2 id="why-another-up">Why another <code class="language-plaintext highlighter-rouge">/up</code>?</h2>
<p>Controller‑based health checks often drag the full Rails stack into the hot path; custom middlewares can be great but are prone to <strong>autoload order</strong> issues or <strong>stale configuration</strong>. This version avoids both:</p>

<ul>
  <li><strong>Single initializer</strong> → no Zeitwerk timing problems, no missing constants.</li>
  <li><strong>ENV‑driven</strong> → consistent across dev/staging/prod and easy to toggle in tests.</li>
  <li><strong>Fast &amp; safe</strong> → short timeouts, minimal dependencies, graceful errors.</li>
  <li><strong>Clear semantics</strong> → <code class="language-plaintext highlighter-rouge">"status":"ok"</code> vs <code class="language-plaintext highlighter-rouge">"degraded"</code>, and independent <strong>HTTP code</strong> policy.</li>
</ul>

<hr />

<h2 id="1-copypaste-initializer">1) Copy‑paste initializer</h2>

<p><strong>File:</strong> <code class="language-plaintext highlighter-rouge">config/initializers/up.rb</code></p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># frozen_string_literal: true</span>

<span class="c1"># A tiny, dependency-light Rack endpoint for /up.</span>
<span class="c1"># - Stable: defined in this initializer (no Zeitwerk/autoload order issues).</span>
<span class="c1"># - Configurable via ENV (see "Configuration via ENV" below).</span>
<span class="c1"># - Optional DB/Redis checks with short timeouts.</span>
<span class="c1"># - Whitelists ENV output with optional prefix and redaction.</span>

<span class="nb">require</span> <span class="s2">"json"</span>
<span class="nb">require</span> <span class="s2">"socket"</span>
<span class="nb">require</span> <span class="s2">"time"</span>
<span class="nb">require</span> <span class="s2">"timeout"</span>

<span class="k">module</span> <span class="nn">Up</span>
  <span class="k">module</span> <span class="nn">Utils</span>
    <span class="kp">module_function</span>

    <span class="k">def</span> <span class="nf">now_iso</span>
      <span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">.</span><span class="nf">utc</span><span class="p">.</span><span class="nf">iso8601</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">hostname</span>
      <span class="no">Socket</span><span class="p">.</span><span class="nf">gethostname</span> <span class="k">rescue</span> <span class="kp">nil</span>
    <span class="k">end</span>

    <span class="c1"># Constant-time compare, avoids ActiveSupport dependency.</span>
    <span class="k">def</span> <span class="nf">secure_compare</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
      <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="nf">to_s</span>
      <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">.</span><span class="nf">to_s</span>
      <span class="k">return</span> <span class="kp">false</span> <span class="k">unless</span> <span class="n">a</span><span class="p">.</span><span class="nf">bytesize</span> <span class="o">==</span> <span class="n">b</span><span class="p">.</span><span class="nf">bytesize</span>
      <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">a</span><span class="p">.</span><span class="nf">bytes</span><span class="p">.</span><span class="nf">zip</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="nf">bytes</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">|</span> <span class="n">l</span> <span class="o">|=</span> <span class="p">(</span><span class="n">x</span> <span class="o">^</span> <span class="n">y</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">l</span><span class="p">.</span><span class="nf">zero?</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">bool_env</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="ss">default: </span><span class="kp">false</span><span class="p">)</span>
      <span class="n">v</span> <span class="o">=</span> <span class="no">ENV</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
      <span class="k">return</span> <span class="n">default</span> <span class="k">if</span> <span class="n">v</span><span class="p">.</span><span class="nf">nil?</span>
      <span class="sx">%w[1 true yes on]</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="nf">to_s</span><span class="p">.</span><span class="nf">strip</span><span class="p">.</span><span class="nf">downcase</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">float_env</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">:)</span>
      <span class="no">Float</span><span class="p">(</span><span class="no">ENV</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="k">rescue</span> <span class="n">default</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">app_name</span>
      <span class="n">app_class</span> <span class="o">=</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">class</span>
      <span class="k">if</span> <span class="n">app_class</span><span class="p">.</span><span class="nf">respond_to?</span><span class="p">(</span><span class="ss">:module_parent_name</span><span class="p">)</span>
        <span class="n">app_class</span><span class="p">.</span><span class="nf">module_parent_name</span>
      <span class="k">elsif</span> <span class="n">app_class</span><span class="p">.</span><span class="nf">respond_to?</span><span class="p">(</span><span class="ss">:parent_name</span><span class="p">)</span>
        <span class="n">app_class</span><span class="p">.</span><span class="nf">parent_name</span>
      <span class="k">else</span>
        <span class="s2">"RailsApp"</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">Endpoint</span>
    <span class="kp">include</span> <span class="no">Utils</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
      <span class="vi">@app</span> <span class="o">=</span> <span class="n">app</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
      <span class="n">req</span> <span class="o">=</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Request</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
      <span class="k">return</span> <span class="vi">@app</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span> <span class="k">unless</span> <span class="n">req</span><span class="p">.</span><span class="nf">get?</span> <span class="o">&amp;&amp;</span> <span class="n">req</span><span class="p">.</span><span class="nf">path</span> <span class="o">==</span> <span class="n">path</span>

      <span class="k">return</span> <span class="n">unauthorized</span> <span class="k">unless</span> <span class="n">authorized?</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>

      <span class="n">checks</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="n">checks</span><span class="p">[</span><span class="ss">:db</span><span class="p">]</span>    <span class="o">=</span> <span class="n">check_db</span>    <span class="k">if</span> <span class="n">db_enabled?</span>
      <span class="n">checks</span><span class="p">[</span><span class="ss">:redis</span><span class="p">]</span> <span class="o">=</span> <span class="n">check_redis</span> <span class="k">if</span> <span class="n">redis_enabled?</span>

      <span class="c1"># Decide body status vs HTTP code separately.</span>
      <span class="n">status_txt</span> <span class="o">=</span> <span class="n">any_failed?</span><span class="p">(</span><span class="n">checks</span><span class="p">)</span> <span class="p">?</span> <span class="s2">"degraded"</span> <span class="p">:</span> <span class="s2">"ok"</span>
      <span class="n">overall_ok</span> <span class="o">=</span> <span class="n">overall_ok?</span><span class="p">(</span><span class="n">checks</span><span class="p">)</span>

      <span class="n">body</span> <span class="o">=</span> <span class="p">{</span>
        <span class="ss">status:   </span><span class="n">status_txt</span><span class="p">,</span>
        <span class="ss">time_utc: </span><span class="n">now_iso</span><span class="p">,</span>
        <span class="ss">app:      </span><span class="n">app_name</span><span class="p">,</span>
        <span class="ss">pid:      </span><span class="no">Process</span><span class="p">.</span><span class="nf">pid</span><span class="p">,</span>
        <span class="ss">hostname: </span><span class="n">hostname</span><span class="p">,</span>
        <span class="ss">env:      </span><span class="n">whitelisted_env</span><span class="p">,</span>
        <span class="ss">checks:   </span><span class="n">checks</span><span class="p">.</span><span class="nf">compact</span>
      <span class="p">}</span>

      <span class="p">[</span><span class="n">overall_ok</span> <span class="p">?</span> <span class="mi">200</span> <span class="p">:</span> <span class="mi">503</span><span class="p">,</span> <span class="n">json_headers</span><span class="p">,</span> <span class="p">[</span><span class="no">JSON</span><span class="p">.</span><span class="nf">generate</span><span class="p">(</span><span class="n">body</span><span class="p">)]]</span>
    <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>
      <span class="n">error_body</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">status: </span><span class="s2">"error"</span><span class="p">,</span> <span class="ss">error: </span><span class="n">e</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">name</span><span class="p">,</span> <span class="ss">message: </span><span class="n">e</span><span class="p">.</span><span class="nf">message</span> <span class="p">}</span>
      <span class="p">[</span><span class="mi">500</span><span class="p">,</span> <span class="n">json_headers</span><span class="p">,</span> <span class="p">[</span><span class="no">JSON</span><span class="p">.</span><span class="nf">generate</span><span class="p">(</span><span class="n">error_body</span><span class="p">)]]</span>
    <span class="k">end</span>

    <span class="kp">private</span>

    <span class="c1"># --------------------------</span>
    <span class="c1"># Configuration (via ENV)</span>
    <span class="c1"># --------------------------</span>
    <span class="k">def</span> <span class="nf">path</span>
      <span class="no">ENV</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="s2">"HEALTHCHECK_PATH"</span><span class="p">,</span> <span class="s2">"/up"</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">token</span>
      <span class="no">ENV</span><span class="p">[</span><span class="s2">"HEALTHCHECK_TOKEN"</span><span class="p">].</span><span class="nf">to_s</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">authorized?</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
      <span class="k">return</span> <span class="kp">true</span> <span class="k">if</span> <span class="n">token</span><span class="p">.</span><span class="nf">empty?</span>
      <span class="n">provided</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="nf">get_header</span><span class="p">(</span><span class="s2">"HTTP_X_HEALTH_TOKEN"</span><span class="p">).</span><span class="nf">to_s</span>
      <span class="n">provided</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="nf">params</span><span class="p">[</span><span class="s2">"token"</span><span class="p">].</span><span class="nf">to_s</span> <span class="k">if</span> <span class="n">provided</span><span class="p">.</span><span class="nf">empty?</span>
      <span class="no">Utils</span><span class="p">.</span><span class="nf">secure_compare</span><span class="p">(</span><span class="n">provided</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">env_whitelist</span>
      <span class="c1"># Comma-separated, e.g. "RAILS_ENV,GIT_SHA,APP_VERSION"</span>
      <span class="p">(</span><span class="no">ENV</span><span class="p">[</span><span class="s2">"HEALTHCHECK_ENV_WHITELIST"</span><span class="p">]</span> <span class="o">||</span> <span class="s2">""</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s2">","</span><span class="p">).</span><span class="nf">map</span> <span class="p">{</span> <span class="n">_1</span><span class="p">.</span><span class="nf">strip</span> <span class="p">}.</span><span class="nf">reject</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:empty?</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">env_prefix</span>
      <span class="no">ENV</span><span class="p">[</span><span class="s2">"HEALTHCHECK_ENV_PREFIX"</span><span class="p">].</span><span class="nf">to_s</span> <span class="c1"># e.g. "APP_"</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">redact_enabled?</span>
      <span class="c1"># Set HEALTHCHECK_REDACT=0 to disable redaction.</span>
      <span class="no">Utils</span><span class="p">.</span><span class="nf">bool_env</span><span class="p">(</span><span class="s2">"HEALTHCHECK_REDACT"</span><span class="p">,</span> <span class="ss">default: </span><span class="kp">true</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">required_checks</span>
      <span class="c1"># Comma-separated, e.g. "db,redis"</span>
      <span class="p">(</span><span class="no">ENV</span><span class="p">[</span><span class="s2">"HEALTHCHECK_REQUIRED"</span><span class="p">]</span> <span class="o">||</span> <span class="s2">""</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s2">","</span><span class="p">).</span><span class="nf">map</span> <span class="p">{</span> <span class="n">_1</span><span class="p">.</span><span class="nf">strip</span><span class="p">.</span><span class="nf">downcase</span><span class="p">.</span><span class="nf">to_sym</span> <span class="p">}.</span><span class="nf">reject</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:nil?</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">db_enabled?</span>
      <span class="no">Utils</span><span class="p">.</span><span class="nf">bool_env</span><span class="p">(</span><span class="s2">"HEALTHCHECK_DB"</span><span class="p">,</span> <span class="ss">default: </span><span class="kp">false</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">redis_enabled?</span>
      <span class="no">Utils</span><span class="p">.</span><span class="nf">bool_env</span><span class="p">(</span><span class="s2">"HEALTHCHECK_REDIS"</span><span class="p">,</span> <span class="ss">default: </span><span class="kp">false</span><span class="p">)</span> <span class="o">||</span>
        <span class="p">(</span><span class="no">ENV</span><span class="p">[</span><span class="s2">"HEALTHCHECK_REDIS_URL"</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="no">ENV</span><span class="p">[</span><span class="s2">"HEALTHCHECK_REDIS_URL"</span><span class="p">].</span><span class="nf">empty?</span><span class="p">)</span> <span class="o">||</span>
        <span class="p">(</span><span class="no">ENV</span><span class="p">[</span><span class="s2">"REDIS_URL"</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="no">ENV</span><span class="p">[</span><span class="s2">"REDIS_URL"</span><span class="p">].</span><span class="nf">empty?</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">db_timeout</span>
      <span class="no">Utils</span><span class="p">.</span><span class="nf">float_env</span><span class="p">(</span><span class="s2">"HEALTHCHECK_DB_TIMEOUT"</span><span class="p">,</span> <span class="ss">default: </span><span class="mf">2.0</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">redis_timeout</span>
      <span class="no">Utils</span><span class="p">.</span><span class="nf">float_env</span><span class="p">(</span><span class="s2">"HEALTHCHECK_REDIS_TIMEOUT"</span><span class="p">,</span> <span class="ss">default: </span><span class="mf">1.5</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="c1"># --------------------------</span>
    <span class="c1"># ENV output</span>
    <span class="c1"># --------------------------</span>
    <span class="k">def</span> <span class="nf">whitelisted_env</span>
      <span class="n">keys</span> <span class="o">=</span> <span class="n">env_whitelist</span><span class="p">.</span><span class="nf">dup</span>
      <span class="k">if</span> <span class="n">env_prefix</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">env_prefix</span><span class="p">.</span><span class="nf">empty?</span>
        <span class="no">ENV</span><span class="p">.</span><span class="nf">each_key</span> <span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="o">|</span> <span class="n">keys</span> <span class="o">&lt;&lt;</span> <span class="n">k</span> <span class="k">if</span> <span class="n">k</span><span class="p">.</span><span class="nf">start_with?</span><span class="p">(</span><span class="n">env_prefix</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>
      <span class="n">keys</span><span class="p">.</span><span class="nf">uniq!</span>

      <span class="n">output</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="n">keys</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">k</span><span class="o">|</span>
        <span class="n">v</span> <span class="o">=</span> <span class="no">ENV</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">next</span> <span class="k">if</span> <span class="n">v</span><span class="p">.</span><span class="nf">nil?</span>
        <span class="n">output</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">redact?</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="p">?</span> <span class="n">redact</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="p">:</span> <span class="n">v</span>
      <span class="k">end</span>
      <span class="n">output</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">redact?</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
      <span class="k">return</span> <span class="kp">false</span> <span class="k">unless</span> <span class="n">redact_enabled?</span>
      <span class="n">key</span> <span class="o">=~</span> <span class="sr">/(secret|key|token|password|pass|credential)/i</span> <span class="o">||</span> <span class="n">value</span><span class="p">.</span><span class="nf">length</span> <span class="o">&gt;</span> <span class="mi">64</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">redact</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
      <span class="n">tail</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="o">..</span><span class="p">]</span> <span class="o">||</span> <span class="s2">""</span>
      <span class="s2">"*****</span><span class="si">#{</span><span class="n">tail</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">end</span>

    <span class="c1"># --------------------------</span>
    <span class="c1"># Checks</span>
    <span class="c1"># --------------------------</span>
    <span class="k">def</span> <span class="nf">check_db</span>
      <span class="n">started</span> <span class="o">=</span> <span class="no">Process</span><span class="p">.</span><span class="nf">clock_gettime</span><span class="p">(</span><span class="no">Process</span><span class="o">::</span><span class="no">CLOCK_MONOTONIC</span><span class="p">)</span>
      <span class="n">ok</span> <span class="o">=</span> <span class="kp">false</span>
      <span class="k">if</span> <span class="k">defined?</span><span class="p">(</span><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">)</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">connection_pool</span><span class="p">.</span><span class="nf">with_connection</span> <span class="p">{</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span> <span class="n">c</span><span class="p">.</span><span class="nf">active?</span> <span class="p">}</span>
      <span class="k">end</span>
      <span class="n">duration</span> <span class="o">=</span> <span class="no">Process</span><span class="p">.</span><span class="nf">clock_gettime</span><span class="p">(</span><span class="no">Process</span><span class="o">::</span><span class="no">CLOCK_MONOTONIC</span><span class="p">)</span> <span class="o">-</span> <span class="n">started</span>
      <span class="p">{</span> <span class="ss">ok: </span><span class="n">ok</span><span class="p">,</span> <span class="ss">duration_s: </span><span class="n">duration</span><span class="p">.</span><span class="nf">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>
      <span class="n">duration</span> <span class="o">=</span> <span class="no">Process</span><span class="p">.</span><span class="nf">clock_gettime</span><span class="p">(</span><span class="no">Process</span><span class="o">::</span><span class="no">CLOCK_MONOTONIC</span><span class="p">)</span> <span class="o">-</span> <span class="n">started</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">warn</span><span class="p">(</span><span class="s2">"[/up] DB check failed: </span><span class="si">#{</span><span class="n">e</span><span class="p">.</span><span class="nf">class</span><span class="si">}</span><span class="s2">: </span><span class="si">#{</span><span class="n">e</span><span class="p">.</span><span class="nf">message</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span> <span class="k">rescue</span> <span class="kp">nil</span>
      <span class="p">{</span> <span class="ss">ok: </span><span class="kp">false</span><span class="p">,</span> <span class="ss">error: </span><span class="n">e</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">name</span><span class="p">,</span> <span class="ss">message: </span><span class="n">e</span><span class="p">.</span><span class="nf">message</span><span class="p">,</span> <span class="ss">duration_s: </span><span class="n">duration</span><span class="p">.</span><span class="nf">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">check_redis</span>
      <span class="n">started</span> <span class="o">=</span> <span class="no">Process</span><span class="p">.</span><span class="nf">clock_gettime</span><span class="p">(</span><span class="no">Process</span><span class="o">::</span><span class="no">CLOCK_MONOTONIC</span><span class="p">)</span>
      <span class="n">ok</span> <span class="o">=</span> <span class="kp">false</span>
      <span class="k">if</span> <span class="k">defined?</span><span class="p">(</span><span class="no">Redis</span><span class="p">)</span>
        <span class="n">client</span> <span class="o">=</span> <span class="k">if</span> <span class="no">Redis</span><span class="p">.</span><span class="nf">respond_to?</span><span class="p">(</span><span class="ss">:current</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="no">Redis</span><span class="p">.</span><span class="nf">current</span>
                   <span class="no">Redis</span><span class="p">.</span><span class="nf">current</span>
                 <span class="k">else</span>
                   <span class="n">url</span> <span class="o">=</span> <span class="no">ENV</span><span class="p">[</span><span class="s2">"HEALTHCHECK_REDIS_URL"</span><span class="p">]</span>
                   <span class="n">url</span> <span class="o">=</span> <span class="no">ENV</span><span class="p">[</span><span class="s2">"REDIS_URL"</span><span class="p">]</span> <span class="k">if</span> <span class="n">url</span><span class="p">.</span><span class="nf">nil?</span> <span class="o">||</span> <span class="n">url</span><span class="p">.</span><span class="nf">empty?</span>
                   <span class="n">url</span> <span class="p">?</span> <span class="no">Redis</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">url: </span><span class="n">url</span><span class="p">)</span> <span class="p">:</span> <span class="no">Redis</span><span class="p">.</span><span class="nf">new</span>
                 <span class="k">end</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="nf">ping</span> <span class="o">==</span> <span class="s2">"PONG"</span><span class="p">)</span>
      <span class="k">end</span>
      <span class="n">duration</span> <span class="o">=</span> <span class="no">Process</span><span class="p">.</span><span class="nf">clock_gettime</span><span class="p">(</span><span class="no">Process</span><span class="o">::</span><span class="no">CLOCK_MONOTONIC</span><span class="p">)</span> <span class="o">-</span> <span class="n">started</span>
      <span class="p">{</span> <span class="ss">ok: </span><span class="n">ok</span><span class="p">,</span> <span class="ss">duration_s: </span><span class="n">duration</span><span class="p">.</span><span class="nf">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>
      <span class="n">duration</span> <span class="o">=</span> <span class="no">Process</span><span class="p">.</span><span class="nf">clock_gettime</span><span class="p">(</span><span class="no">Process</span><span class="o">::</span><span class="no">CLOCK_MONOTONIC</span><span class="p">)</span> <span class="o">-</span> <span class="n">started</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">warn</span><span class="p">(</span><span class="s2">"[/up] Redis check failed: </span><span class="si">#{</span><span class="n">e</span><span class="p">.</span><span class="nf">class</span><span class="si">}</span><span class="s2">: </span><span class="si">#{</span><span class="n">e</span><span class="p">.</span><span class="nf">message</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span> <span class="k">rescue</span> <span class="kp">nil</span>
      <span class="p">{</span> <span class="ss">ok: </span><span class="kp">false</span><span class="p">,</span> <span class="ss">error: </span><span class="n">e</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">name</span><span class="p">,</span> <span class="ss">message: </span><span class="n">e</span><span class="p">.</span><span class="nf">message</span><span class="p">,</span> <span class="ss">duration_s: </span><span class="n">duration</span><span class="p">.</span><span class="nf">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">any_failed?</span><span class="p">(</span><span class="n">checks</span><span class="p">)</span>
      <span class="n">checks</span><span class="p">.</span><span class="nf">values</span><span class="p">.</span><span class="nf">any?</span> <span class="p">{</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">v</span><span class="p">[</span><span class="ss">:ok</span><span class="p">]</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">overall_ok?</span><span class="p">(</span><span class="n">checks</span><span class="p">)</span>
      <span class="c1"># HTTP 200 unless a *required* check fails</span>
      <span class="n">req</span> <span class="o">=</span> <span class="n">required_checks</span>
      <span class="k">return</span> <span class="kp">true</span> <span class="k">if</span> <span class="n">req</span><span class="p">.</span><span class="nf">empty?</span>
      <span class="n">req</span><span class="p">.</span><span class="nf">all?</span> <span class="p">{</span> <span class="o">|</span><span class="nb">name</span><span class="o">|</span> <span class="n">checks</span><span class="p">[</span><span class="nb">name</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">checks</span><span class="p">[</span><span class="nb">name</span><span class="p">][</span><span class="ss">:ok</span><span class="p">]</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="c1"># --------------------------</span>
    <span class="c1"># Responses</span>
    <span class="c1"># --------------------------</span>
    <span class="k">def</span> <span class="nf">json_headers</span>
      <span class="p">{</span>
        <span class="s2">"Content-Type"</span>  <span class="o">=&gt;</span> <span class="s2">"application/json; charset=utf-8"</span><span class="p">,</span>
        <span class="s2">"Cache-Control"</span> <span class="o">=&gt;</span> <span class="s2">"no-store, no-cache, must-revalidate, max-age=0"</span>
      <span class="p">}</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">unauthorized</span>
      <span class="p">[</span><span class="mi">401</span><span class="p">,</span> <span class="n">json_headers</span><span class="p">,</span> <span class="p">[</span><span class="no">JSON</span><span class="p">.</span><span class="nf">generate</span><span class="p">({</span> <span class="ss">status: </span><span class="s2">"unauthorized"</span><span class="p">,</span> <span class="ss">error: </span><span class="s2">"invalid_token"</span> <span class="p">})]]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># Insert at the very top for speed and resilience.</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">middleware</span><span class="p">.</span><span class="nf">insert_before</span> <span class="mi">0</span><span class="p">,</span> <span class="no">Up</span><span class="o">::</span><span class="no">Endpoint</span>
</code></pre></div></div>

<hr />

<h2 id="2-configuration-via-env">2) Configuration via ENV</h2>

<p>Pick what you need. <strong>Unset = defaults.</strong></p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Path (optional)</span>
<span class="nv">HEALTHCHECK_PATH</span><span class="o">=</span>/up

<span class="c"># Token gate (optional, strongly advised on public endpoints)</span>
<span class="nv">HEALTHCHECK_TOKEN</span><span class="o">=</span>supersecret

<span class="c"># Show select ENV keys (comma-separated) and/or a prefix</span>
<span class="nv">HEALTHCHECK_ENV_WHITELIST</span><span class="o">=</span>RAILS_ENV,GIT_SHA,APP_VERSION
<span class="nv">HEALTHCHECK_ENV_PREFIX</span><span class="o">=</span>APP_
<span class="c"># Redaction (default ON). Set to 0 to disable.</span>
<span class="nv">HEALTHCHECK_REDACT</span><span class="o">=</span>1

<span class="c"># Checks (off by default)</span>
<span class="nv">HEALTHCHECK_DB</span><span class="o">=</span>1
<span class="nv">HEALTHCHECK_DB_TIMEOUT</span><span class="o">=</span>2.0

<span class="nv">HEALTHCHECK_REDIS</span><span class="o">=</span>1
<span class="nv">HEALTHCHECK_REDIS_TIMEOUT</span><span class="o">=</span>1.5
<span class="c"># Optional explicit URL (falls back to REDIS_URL)</span>
<span class="nv">HEALTHCHECK_REDIS_URL</span><span class="o">=</span>redis://localhost:6379/0

<span class="c"># HTTP policy: only fail when *required* checks fail (empty =&gt; always 200)</span>
<span class="nv">HEALTHCHECK_REQUIRED</span><span class="o">=</span>db,redis
</code></pre></div></div>

<p><strong>Policy summary</strong></p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">"status"</code> in the JSON is <code class="language-plaintext highlighter-rouge">"ok"</code> if all enabled checks pass, else <code class="language-plaintext highlighter-rouge">"degraded"</code>.</li>
  <li><strong>HTTP code</strong> is <strong>200</strong> unless a <strong>required</strong> check fails (then <strong>503</strong>). If <code class="language-plaintext highlighter-rouge">HEALTHCHECK_REQUIRED</code> is empty, you always get 200 (but <code class="language-plaintext highlighter-rouge">"status":"degraded"</code> can still flag issues).</li>
</ul>

<hr />

<h2 id="3-usage-examples-curl">3) Usage examples (cURL)</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># open (no token set)</span>
curl <span class="nt">-s</span> http://localhost:3000/up | jq

<span class="c"># token via header</span>
curl <span class="nt">-s</span> <span class="nt">-H</span> <span class="s2">"X-Health-Token: supersecret"</span> http://localhost:3000/up | jq

<span class="c"># token via query parameter</span>
curl <span class="nt">-s</span> <span class="s2">"http://localhost:3000/up?token=supersecret"</span> | jq
</code></pre></div></div>

<p><strong>Typical responses</strong></p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w"> </span><span class="nl">"status"</span><span class="p">:</span><span class="s2">"ok"</span><span class="p">,</span><span class="w"> </span><span class="nl">"checks"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"db"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nl">"ok"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">},</span><span class="w"> </span><span class="nl">"redis"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nl">"ok"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w"> </span><span class="nl">"status"</span><span class="p">:</span><span class="s2">"degraded"</span><span class="p">,</span><span class="w"> </span><span class="nl">"checks"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"db"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nl">"ok"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="nl">"error"</span><span class="p">:</span><span class="s2">"..."</span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<hr />

<h2 id="4-kubernetes--docker--nginx-snippets">4) Kubernetes / Docker / Nginx snippets</h2>

<p><strong>Kubernetes (readinessProbe)</strong></p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">readinessProbe</span><span class="pi">:</span>
  <span class="na">httpGet</span><span class="pi">:</span>
    <span class="na">path</span><span class="pi">:</span> <span class="s">/up</span>
    <span class="na">port</span><span class="pi">:</span> <span class="m">3000</span>
  <span class="na">initialDelaySeconds</span><span class="pi">:</span> <span class="m">5</span>
  <span class="na">periodSeconds</span><span class="pi">:</span> <span class="m">10</span>
  <span class="na">timeoutSeconds</span><span class="pi">:</span> <span class="m">2</span>
  <span class="na">failureThreshold</span><span class="pi">:</span> <span class="m">3</span>
</code></pre></div></div>

<p><strong>Nginx location (optional token)</strong></p>
<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">location</span> <span class="p">=</span> <span class="n">/up</span> <span class="p">{</span>
  <span class="kn">proxy_pass</span> <span class="s">http://app_upstream</span><span class="p">;</span>
  <span class="c1"># If you want to require a token at the edge:</span>
  <span class="c1"># if ($http_x_health_token != "supersecret") { return 401; }</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>Docker Compose (environment)</strong></p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">services</span><span class="pi">:</span>
  <span class="na">web</span><span class="pi">:</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">HEALTHCHECK_PATH=/up</span>
      <span class="pi">-</span> <span class="s">HEALTHCHECK_TOKEN=${HEALTHCHECK_TOKEN}</span>
      <span class="pi">-</span> <span class="s">HEALTHCHECK_ENV_WHITELIST=RAILS_ENV,GIT_SHA,APP_VERSION</span>
      <span class="pi">-</span> <span class="s">HEALTHCHECK_DB=1</span>
      <span class="pi">-</span> <span class="s">HEALTHCHECK_REDIS=1</span>
      <span class="pi">-</span> <span class="s">HEALTHCHECK_REQUIRED=db,redis</span>
</code></pre></div></div>

<hr />

<h2 id="5-endtoend-tests-rspec">5) End‑to‑end tests (RSpec)</h2>

<p><strong>File:</strong> <code class="language-plaintext highlighter-rouge">spec/requests/up_spec.rb</code></p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"rails_helper"</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="s2">"Up endpoint"</span><span class="p">,</span> <span class="ss">type: :request</span> <span class="k">do</span>
  <span class="k">def</span> <span class="nf">with_env</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
    <span class="n">old</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">temp</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">|</span> <span class="n">old</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="no">ENV</span><span class="p">[</span><span class="n">k</span><span class="p">];</span> <span class="no">ENV</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span> <span class="p">}</span>
    <span class="k">yield</span>
  <span class="k">ensure</span>
    <span class="n">old</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">|</span> <span class="no">ENV</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">"returns 200 OK and status ok by default"</span> <span class="k">do</span>
    <span class="n">with_env</span><span class="p">(</span><span class="s2">"HEALTHCHECK_TOKEN"</span> <span class="o">=&gt;</span> <span class="kp">nil</span><span class="p">,</span> <span class="s2">"HEALTHCHECK_DB"</span> <span class="o">=&gt;</span> <span class="kp">nil</span><span class="p">,</span> <span class="s2">"HEALTHCHECK_REDIS"</span> <span class="o">=&gt;</span> <span class="kp">nil</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">get</span> <span class="s2">"/up"</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_http_status</span><span class="p">(</span><span class="ss">:ok</span><span class="p">)</span>
      <span class="n">json</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">)</span>
      <span class="n">expect</span><span class="p">(</span><span class="sx">%w[ok degraded]</span><span class="p">).</span><span class="nf">to</span> <span class="kp">include</span><span class="p">(</span><span class="n">json</span><span class="p">[</span><span class="s2">"status"</span><span class="p">])</span> <span class="c1"># no checks enabled =&gt; ok</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">"requires token when HEALTHCHECK_TOKEN is set"</span> <span class="k">do</span>
    <span class="n">with_env</span><span class="p">(</span><span class="s2">"HEALTHCHECK_TOKEN"</span> <span class="o">=&gt;</span> <span class="s2">"secret"</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">get</span> <span class="s2">"/up"</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_http_status</span><span class="p">(</span><span class="ss">:unauthorized</span><span class="p">)</span>

      <span class="n">get</span> <span class="s2">"/up"</span><span class="p">,</span> <span class="ss">headers: </span><span class="p">{</span> <span class="s2">"X-Health-Token"</span> <span class="o">=&gt;</span> <span class="s2">"secret"</span> <span class="p">}</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_http_status</span><span class="p">(</span><span class="ss">:ok</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">"marks degraded when a non-required check fails but still returns 200"</span> <span class="k">do</span>
    <span class="n">with_env</span><span class="p">(</span><span class="s2">"HEALTHCHECK_DB"</span> <span class="o">=&gt;</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"HEALTHCHECK_REQUIRED"</span> <span class="o">=&gt;</span> <span class="kp">nil</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">allow</span><span class="p">(</span><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive_message_chain</span><span class="p">(</span><span class="ss">:connection_pool</span><span class="p">,</span> <span class="ss">:with_connection</span><span class="p">).</span><span class="nf">and_raise</span><span class="p">(</span><span class="no">StandardError</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"boom"</span><span class="p">))</span>
      <span class="n">get</span> <span class="s2">"/up"</span>
      <span class="n">json</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">)</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_http_status</span><span class="p">(</span><span class="ss">:ok</span><span class="p">)</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">json</span><span class="p">[</span><span class="s2">"status"</span><span class="p">]).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s2">"degraded"</span><span class="p">)</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="s2">"checks"</span><span class="p">,</span> <span class="s2">"db"</span><span class="p">,</span> <span class="s2">"ok"</span><span class="p">)).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="kp">false</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">"returns 503 if a required check fails"</span> <span class="k">do</span>
    <span class="n">with_env</span><span class="p">(</span><span class="s2">"HEALTHCHECK_DB"</span> <span class="o">=&gt;</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"HEALTHCHECK_REQUIRED"</span> <span class="o">=&gt;</span> <span class="s2">"db"</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">allow</span><span class="p">(</span><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive_message_chain</span><span class="p">(</span><span class="ss">:connection_pool</span><span class="p">,</span> <span class="ss">:with_connection</span><span class="p">).</span><span class="nf">and_raise</span><span class="p">(</span><span class="no">StandardError</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"boom"</span><span class="p">))</span>
      <span class="n">get</span> <span class="s2">"/up"</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_http_status</span><span class="p">(</span><span class="mi">503</span><span class="p">)</span>
      <span class="n">json</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">)</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">json</span><span class="p">[</span><span class="s2">"status"</span><span class="p">]).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s2">"degraded"</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<hr />

<h2 id="6-troubleshooting">6) Troubleshooting</h2>

<p><strong>DB fails</strong> → run:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bin/rails c
ActiveRecord::Base.establish_connection
ActiveRecord::Base.connection.active?             <span class="c"># =&gt; true/false</span>
ActiveRecord::Base.connection.execute<span class="o">(</span><span class="s2">"SELECT 1"</span><span class="o">)</span> <span class="c"># raises if misconfigured</span>
bin/rails db:prepare                              <span class="c"># create + migrate</span>
</code></pre></div></div>
<p><strong>Redis fails</strong> → verify <code class="language-plaintext highlighter-rouge">REDIS_URL</code>/<code class="language-plaintext highlighter-rouge">HEALTHCHECK_REDIS_URL</code> and can you <code class="language-plaintext highlighter-rouge">PING</code> with your client?
<strong>Token issues</strong> → confirm header name <code class="language-plaintext highlighter-rouge">X-Health-Token</code> or <code class="language-plaintext highlighter-rouge">?token=...</code> param; ensure constant‑time compare (already built‑in).</p>

<hr />

<h2 id="7-security-notes">7) Security notes</h2>

<ul>
  <li>Never expose all ENV; use the <strong>whitelist</strong> and optional <strong>prefix</strong>.</li>
  <li>Keep redaction on (default).</li>
  <li>If <code class="language-plaintext highlighter-rouge">/up</code> is public, <strong>set a token</strong> and/or restrict by IP/WAF (Nginx/Cloudflare).</li>
</ul>

<hr />

<h2 id="8-design-choices-faq">8) Design choices (FAQ)</h2>

<ul>
  <li><strong>Why ENV over Rails config?</strong> ENV is stable at boot, easy for 12‑factor deploys, and testable without rebuilding middleware.</li>
  <li><strong>Why single initializer?</strong> Avoids Zeitwerk load order pitfalls and keeps the endpoint fast (no controller stack).</li>
  <li><strong>Why 200 even if degraded?</strong> Many orchestrators treat 503 as restart-worthy. Use <code class="language-plaintext highlighter-rouge">HEALTHCHECK_REQUIRED</code> to specify which checks should <em>gate</em> readiness.</li>
  <li><strong>Can I add custom checks?</strong> Yes—clone <code class="language-plaintext highlighter-rouge">check_redis</code> pattern and enable via another ENV flag; then add its name to <code class="language-plaintext highlighter-rouge">HEALTHCHECK_REQUIRED</code> if critical.</li>
</ul>

<hr />

<h3 id="final-note">Final note</h3>
<p>This “one‑initializer, ENV‑driven” <code class="language-plaintext highlighter-rouge">/up</code> endpoint has been reliable in practice and easy to reason about. Start minimal, enable checks as you harden the service, and mark only truly critical dependencies as <strong>required</strong>.</p>

    </div>
  </div>

  <!-- Post navigation (Previous/Next) -->
  
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      
      
      
      
      

  <nav class="post-navigation">
    
      <a href="/blog/mastering-freeze_time-in-rails-tests" class="post-nav-link post-nav-prev">
        <span class="post-nav-label">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="19" y1="12" x2="5" y2="12"/>
            <polyline points="12 19 5 12 12 5"/>
          </svg>
          Older
        </span>
        <span class="post-nav-title">Mastering freeze_time in Rails Tests: Practical Patterns and...</span>
      </a>
    
    
      <a href="/blog/rails-profile-endpoint-optimization-first-person" class="post-nav-link post-nav-next">
        <span class="post-nav-label">
          Newer
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="5" y1="12" x2="19" y2="12"/>
            <polyline points="12 5 19 12 12 19"/>
          </svg>
        </span>
        <span class="post-nav-title">Optimizing a Complex Rails Profile Endpoint — my...</span>
      </a>
    
  </nav>

  <!-- Back to top button -->
  <button id="back-to-top" class="back-to-top" onclick="window.scrollTo({top: 0, behavior: 'smooth'})" title="Back to top" aria-label="Back to top">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <line x1="12" y1="19" x2="12" y2="5"/>
      <polyline points="5 12 12 5 19 12"/>
    </svg>
  </button>
</article>

<script>
  // Show/hide back-to-top button based on scroll position
  const backToTop = document.getElementById('back-to-top');
  window.addEventListener('scroll', function() {
    if (window.scrollY > 400) {
      backToTop.classList.add('visible');
    } else {
      backToTop.classList.remove('visible');
    }
  });

  // Reading progress bar
  const progressBar = document.getElementById('reading-progress');
  const article = document.querySelector('.post-article');

  window.addEventListener('scroll', function() {
    const articleTop = article.offsetTop;
    const articleHeight = article.offsetHeight;
    const windowHeight = window.innerHeight;
    const scrolled = window.scrollY - articleTop + windowHeight * 0.3;
    const progress = Math.min(Math.max(scrolled / articleHeight * 100, 0), 100);
    progressBar.style.width = progress + '%';
  });

  // Generate Table of Contents
  const postContent = document.getElementById('post-content');
  const tocList = document.getElementById('toc-list');
  const tocSidebar = document.getElementById('toc-sidebar');
  const headings = postContent.querySelectorAll('h2, h3');

  if (headings.length >= 4) {
    tocSidebar.classList.add('visible');

    headings.forEach((heading, index) => {
      // Add ID to heading if not present
      if (!heading.id) {
        heading.id = 'heading-' + index;
      }

      const li = document.createElement('li');
      li.className = 'toc-item toc-' + heading.tagName.toLowerCase();

      const a = document.createElement('a');
      a.href = '#' + heading.id;
      a.textContent = heading.textContent;
      a.className = 'toc-link';

      li.appendChild(a);
      tocList.appendChild(li);
    });

    // Highlight current section in TOC
    const tocLinks = document.querySelectorAll('.toc-link');

    const observerOptions = {
      rootMargin: '-80px 0px -70% 0px'
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          tocLinks.forEach(link => link.classList.remove('active'));
          const activeLink = document.querySelector('.toc-link[href="#' + entry.target.id + '"]');
          if (activeLink) activeLink.classList.add('active');
        }
      });
    }, observerOptions);

    headings.forEach(heading => observer.observe(heading));
  }

  // Add copy buttons and language labels to code blocks
  document.querySelectorAll('.highlight, pre').forEach(element => {
    // Skip if already wrapped or if this is a pre inside a highlight we'll process
    if (element.closest('.code-block-wrapper')) return;
    if (element.tagName === 'PRE' && element.closest('.highlight')) return;

    // Determine what to wrap: the .highlight div or standalone pre
    const highlightDiv = element.classList.contains('highlight') ? element : null;
    const pre = highlightDiv ? highlightDiv.querySelector('pre') : element;
    if (!pre) return;

    const wrapper = document.createElement('div');
    wrapper.className = 'code-block-wrapper';

    // Wrap the highlight div if exists, otherwise wrap pre
    const toWrap = highlightDiv || pre;
    toWrap.parentNode.insertBefore(wrapper, toWrap);
    wrapper.appendChild(toWrap);

    // Detect language from class
    const code = pre.querySelector('code');
    let language = '';

    // Method 1: Check code element class
    if (code && code.className) {
      const match = code.className.match(/language-(\w+)/);
      if (match) language = match[1];
    }

    // Method 2: Check highlight div class (Rouge uses class like "highlight ruby")
    if (!language && highlightDiv) {
      const classes = highlightDiv.className.split(' ');
      for (const cls of classes) {
        if (cls !== 'highlight' && cls.length > 0 && !cls.startsWith('code')) {
          language = cls;
          break;
        }
      }
    }

    // Method 3: Try to detect from code patterns
    if (!language) {
      const text = pre.textContent.trim();
      if (text.startsWith('#') && !text.startsWith('#!/')) {
        const firstLine = text.split('\n')[0];
        if (firstLine.match(/\.rb$/)) language = 'ruby';
        else if (firstLine.match(/\.py$/)) language = 'python';
        else if (firstLine.match(/\.yml$|\.yaml$/)) language = 'yaml';
      } else if (text.startsWith('//')) {
        language = 'javascript';
      } else if (text.match(/^(RSpec|describe|it|context|let)\b/)) {
        language = 'ruby';
      } else if (text.match(/^(def |class |module |require )/)) {
        language = 'ruby';
      }
    }

    // Create header with language and copy button
    const header = document.createElement('div');
    header.className = 'code-block-header';

    if (language) {
      const langLabel = document.createElement('span');
      langLabel.className = 'code-lang';
      langLabel.textContent = language;
      header.appendChild(langLabel);
    }

    const copyBtn = document.createElement('button');
    copyBtn.className = 'code-copy-btn';
    copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg><span>Copy</span>';
    copyBtn.onclick = async function() {
      const text = pre.textContent;
      try {
        await navigator.clipboard.writeText(text);
        copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg><span>Copied!</span>';
        copyBtn.classList.add('copied');
        setTimeout(() => {
          copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg><span>Copy</span>';
          copyBtn.classList.remove('copied');
        }, 2000);
      } catch (err) {
        console.error('Failed to copy:', err);
      }
    };
    header.appendChild(copyBtn);

    // Insert header at the start of wrapper (before the highlight/pre)
    wrapper.insertBefore(header, wrapper.firstChild);
  });
</script>

    </main>

    <footer class="site-footer">
      <div class="footer-content">
  <div class="footer-links">
    <a href="/feed.xml" title="RSS Feed" class="footer-icon-link">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M4 11a9 9 0 0 1 9 9"/>
        <path d="M4 4a16 16 0 0 1 16 16"/>
        <circle cx="5" cy="19" r="1"/>
      </svg>
    </a>
    <span class="footer-divider">·</span>
    <button id="theme-btn" onclick="toggleTheme()" class="theme-toggle-btn" title="Toggle theme (press T)" aria-label="Toggle theme" aria-live="polite">
      <svg class="moon-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"/>
      </svg>
      <svg class="sun-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M14.828 14.828a4 4 0 1 0 -5.656 -5.656a4 4 0 0 0 5.656 5.656z"/>
        <path d="M6.343 17.657l-1.414 1.414"/>
        <path d="M6.343 6.343l-1.414 -1.414"/>
        <path d="M17.657 6.343l1.414 -1.414"/>
        <path d="M17.657 17.657l1.414 1.414"/>
        <path d="M4 12h-2"/>
        <path d="M12 4v-2"/>
        <path d="M20 12h2"/>
        <path d="M12 20v2"/>
      </svg>
    </button>
  </div>
</div>

    </footer>
  </div>

  <script>
    // Theme toggle
    function toggleTheme() {
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

      // Use View Transitions API if available
      if (document.startViewTransition) {
        document.startViewTransition(() => {
          html.setAttribute('data-theme', newTheme);
          localStorage.setItem('theme', newTheme);
        });
      } else {
        html.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
      }
    }

    // Keyboard shortcut: press 't' to toggle theme
    document.addEventListener('keydown', function(e) {
      // Don't trigger if user is typing in an input/textarea
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
        return;
      }
      if (e.key === 't' || e.key === 'T') {
        toggleTheme();
      }
    });
  </script>
</body>
</html>
