<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="canonical" href="http://localhost:4000/blog/rails-instrumentation-notifications-logsubscriber">
  <link rel="alternate" type="application/rss+xml" title="Software Engineering consultant" href="http://localhost:4000/%20feed.xml" />

  <title>Rails Instrumentation Notifications Logsubscriber — Software Engineering consultant</title>

  <!-- Remove Bootstrap <link> here if present -->
  <link rel="stylesheet" href="/assets/css/styles.css">
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-VLFHH5CPGM"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-VLFHH5CPGM');
  </script>
  <meta name="description" content="layout: posttitle: “Deep Rails Instrumentation: ActiveSupport::Notifications &amp; LogSubscriber (Rails 8+)”date: 2025-08-11tags: [ruby-on-rails, rails-8, in...">
  <meta name="keywords" content="Software Engineering consultant, programming consultant, Ruby web development, agile Ruby development, Ruby on Rails web design, RoR consulting, Ruby on Rails service, RoR consultant, Ruby on Rails NYC, Ruby on Rails expertise, web agency, ios application development, mobile, api, frontend, backend, development, software engineer partner, sf developer, sf ruby on rails, berling ruby consultant, london consultant">
  <meta name="author" content="Max Lukin">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Rails Instrumentation Notifications Logsubscriber | Software Engineering consultant</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Rails Instrumentation Notifications Logsubscriber" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="layout: post title: “Deep Rails Instrumentation: ActiveSupport::Notifications &amp; LogSubscriber (Rails 8+)” date: 2025-08-11 tags: [ruby-on-rails, rails-8, instrumentation, performance, logging] description: “Practical, copy-paste-ready patterns for ActiveSupport::Notifications and ActiveSupport::LogSubscriber in Rails 8+.” —" />
<meta property="og:description" content="layout: post title: “Deep Rails Instrumentation: ActiveSupport::Notifications &amp; LogSubscriber (Rails 8+)” date: 2025-08-11 tags: [ruby-on-rails, rails-8, instrumentation, performance, logging] description: “Practical, copy-paste-ready patterns for ActiveSupport::Notifications and ActiveSupport::LogSubscriber in Rails 8+.” —" />
<link rel="canonical" href="http://localhost:4000/blog/rails-instrumentation-notifications-logsubscriber" />
<meta property="og:url" content="http://localhost:4000/blog/rails-instrumentation-notifications-logsubscriber" />
<meta property="og:site_name" content="Software Engineering consultant" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-08-11T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Rails Instrumentation Notifications Logsubscriber" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-08-11T00:00:00+00:00","datePublished":"2025-08-11T00:00:00+00:00","description":"layout: post title: “Deep Rails Instrumentation: ActiveSupport::Notifications &amp; LogSubscriber (Rails 8+)” date: 2025-08-11 tags: [ruby-on-rails, rails-8, instrumentation, performance, logging] description: “Practical, copy-paste-ready patterns for ActiveSupport::Notifications and ActiveSupport::LogSubscriber in Rails 8+.” —","headline":"Rails Instrumentation Notifications Logsubscriber","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/blog/rails-instrumentation-notifications-logsubscriber"},"url":"http://localhost:4000/blog/rails-instrumentation-notifications-logsubscriber"}</script>
<!-- End Jekyll SEO tag -->

</head>

<body>
  <header class="header">
    <div class="wrap nav">
      <a class="brand" href="/">Software Engineering consultant</a>
      <nav class="nav">
        <a href="/blog">Blog</a>
      </nav>
    </div>
  </header>

  <main class="page wrap">
    <article class="article">
  <header>
    <h1>Rails Instrumentation Notifications Logsubscriber</h1>
    <time datetime="2025-08-11T00:00:00+00:00">11 August 2025</time>
    <p class="lead">

layout: post
title: “Deep Rails Instrumentation: ActiveSupport::Notifications &amp; LogSubscriber (Rails 8+)”
date: 2025-08-11
tags: [ruby-on-rails, rails-8, instrumentation, performance, logging]
description: “Practical, copy-paste-ready patterns for ActiveSupport::Notifications and ActiveSupport::LogSubscriber in Rails 8+.”
—
</p>
    <hr />
  </header>

  <div class="prose">
    
<hr />
<p>layout: post
title: “Deep Rails Instrumentation: ActiveSupport::Notifications &amp; LogSubscriber (Rails 8+)”
date: 2025-08-11
tags: [ruby-on-rails, rails-8, instrumentation, performance, logging]
description: “Practical, copy-paste-ready patterns for ActiveSupport::Notifications and ActiveSupport::LogSubscriber in Rails 8+.”
—</p>

<blockquote>
  <p><strong>Update (typo fixes):</strong> corrected Ruby block braces <code class="language-plaintext highlighter-rouge">{}</code> and regex escapes in code samples.</p>
</blockquote>

<blockquote>
  <p>This post combines two answers: (1) practical use cases for <strong>ActiveSupport::Notifications</strong>, and (2) a curated, Rails-8-friendly <strong>cheat sheet of built-in events</strong> you can subscribe to. It’s plug-and-play and safe for production, with dev-friendly extras.</p>
</blockquote>

<h2 id="tldr">TL;DR</h2>
<ul>
  <li>Use <strong>ActiveSupport::Notifications</strong> to instrument anything (timings, payloads, cache hits, external API calls).</li>
  <li>Use <strong>ActiveSupport::LogSubscriber</strong> for <strong>clean, structured, centralized logs</strong> per framework (AR/AC/AV/Job/Mailer) and your own domains.</li>
  <li>Prefer <strong>pattern subscriptions</strong> (regex) and <strong>sampling</strong> for noisy events.</li>
  <li>Ship metrics to your APM (Datadog, Prometheus, etc.) by subscribing and forwarding durations.</li>
</ul>

<hr />

<h1 id="part-1--useful-cases-for-activesupportnotifications">Part 1 — Useful cases for ActiveSupport::Notifications</h1>

<h3 id="1-performance-monitoring-for-hot-paths">1) Performance monitoring for hot paths</h3>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="c1"># Anywhere in your code</span>
<span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Notifications</span><span class="p">.</span><span class="nf">instrument</span><span class="p">(</span><span class="s2">"query.user_search"</span><span class="p">)</span> <span class="k">do</span>
  <span class="no">User</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">active: </span><span class="kp">true</span><span class="p">).</span><span class="nf">limit</span><span class="p">(</span><span class="mi">100</span><span class="p">).</span><span class="nf">to_a</span>
<span class="k">end</span>

<span class="c1"># e.g. config/initializers/instrumentation.rb</span>
<span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Notifications</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="s2">"query.user_search"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">_name</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">finish</span><span class="p">,</span> <span class="n">_id</span><span class="p">,</span> <span class="n">payload</span><span class="o">|</span>
  <span class="n">duration</span> <span class="o">=</span> <span class="p">(</span><span class="n">finish</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
  <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"User search took </span><span class="si">#{</span><span class="n">duration</span><span class="p">.</span><span class="nf">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">ms"</span><span class="p">)</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>Why:</strong> Quick timing without invasive changes.</p>

<hr />

<h3 id="2-domain-events-decouple-side-effects">2) Domain events (decouple side-effects)</h3>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="c1"># After order is completed</span>
<span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Notifications</span><span class="p">.</span><span class="nf">instrument</span><span class="p">(</span><span class="s2">"order.completed"</span><span class="p">,</span> <span class="ss">order_id: </span><span class="n">order</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="ss">total: </span><span class="n">order</span><span class="p">.</span><span class="nf">total_cents</span><span class="p">)</span>

<span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Notifications</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="s2">"order.completed"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">_n</span><span class="p">,</span> <span class="n">_s</span><span class="p">,</span> <span class="n">_f</span><span class="p">,</span> <span class="n">_i</span><span class="p">,</span> <span class="n">payload</span><span class="o">|</span>
  <span class="no">AnalyticsService</span><span class="p">.</span><span class="nf">track</span><span class="p">(</span><span class="s2">"Order Completed"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span> <span class="c1"># async-friendly</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>Why:</strong> Analytics/email/etc. stay out of core logic.</p>

<hr />

<h3 id="3-leverage-built-in-framework-events">3) Leverage built-in framework events</h3>
<p>Common ones you’ll use a lot:</p>
<ul>
  <li><strong>ActiveRecord:</strong> <code class="language-plaintext highlighter-rouge">sql.active_record</code>, <code class="language-plaintext highlighter-rouge">instantiation.active_record</code></li>
  <li><strong>ActionController:</strong> <code class="language-plaintext highlighter-rouge">start_processing.action_controller</code>, <code class="language-plaintext highlighter-rouge">process_action.action_controller</code>, <code class="language-plaintext highlighter-rouge">redirect_to.action_controller</code>, <code class="language-plaintext highlighter-rouge">send_file.action_controller</code></li>
  <li><strong>ActionView:</strong> <code class="language-plaintext highlighter-rouge">render_template.action_view</code>, <code class="language-plaintext highlighter-rouge">render_partial.action_view</code>, <code class="language-plaintext highlighter-rouge">render_collection.action_view</code></li>
  <li><strong>ActiveJob:</strong> <code class="language-plaintext highlighter-rouge">enqueue.active_job</code>, <code class="language-plaintext highlighter-rouge">enqueue_at.active_job</code>, <code class="language-plaintext highlighter-rouge">perform_start.active_job</code>, <code class="language-plaintext highlighter-rouge">perform.active_job</code></li>
  <li><strong>ActionMailer:</strong> <code class="language-plaintext highlighter-rouge">deliver.action_mailer</code>, <code class="language-plaintext highlighter-rouge">receive.action_mailer</code></li>
  <li><strong>Cache (ActiveSupport):</strong> <code class="language-plaintext highlighter-rouge">cache_read.active_support</code>, <code class="language-plaintext highlighter-rouge">cache_fetch_hit.active_support</code>, <code class="language-plaintext highlighter-rouge">cache_generate.active_support</code>, <code class="language-plaintext highlighter-rouge">cache_write.active_support</code>, <code class="language-plaintext highlighter-rouge">cache_delete.active_support</code>, <code class="language-plaintext highlighter-rouge">cache_exist?.active_support</code></li>
  <li><strong>ActionCable:</strong> <code class="language-plaintext highlighter-rouge">perform_action.action_cable</code>, <code class="language-plaintext highlighter-rouge">broadcast.action_cable</code>, <code class="language-plaintext highlighter-rouge">transmit.action_cable</code></li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Notifications</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="s2">"sql.active_record"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">_n</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">_i</span><span class="p">,</span> <span class="n">payload</span><span class="o">|</span>
  <span class="k">next</span> <span class="k">if</span> <span class="n">payload</span><span class="p">[</span><span class="ss">:name</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"SCHEMA"</span>
  <span class="n">ms</span> <span class="o">=</span> <span class="p">((</span><span class="n">f</span> <span class="o">-</span> <span class="n">s</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">).</span><span class="nf">round</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="s2">"SQL (</span><span class="si">#{</span><span class="n">ms</span><span class="si">}</span><span class="s2">ms) {name=</span><span class="si">#{</span><span class="n">payload</span><span class="p">[</span><span class="ss">:name</span><span class="p">]</span><span class="si">}</span><span class="s2">} {sql=</span><span class="si">#{</span><span class="n">payload</span><span class="p">[</span><span class="ss">:sql</span><span class="p">]</span><span class="si">}</span><span class="s2">}"</span><span class="p">)</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>Why:</strong> Build custom loggers, catch slow queries/N+1s, trace requests end-to-end.</p>

<hr />

<h3 id="4-background-job-timing">4) Background job timing</h3>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Notifications</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="s2">"perform.active_job"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">_n</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">_i</span><span class="p">,</span> <span class="nb">p</span><span class="o">|</span>
  <span class="n">ms</span> <span class="o">=</span> <span class="p">((</span><span class="n">f</span> <span class="o">-</span> <span class="n">s</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">).</span><span class="nf">round</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"[job] {class=</span><span class="si">#{</span><span class="nb">p</span><span class="p">[</span><span class="ss">:job</span><span class="p">].</span><span class="nf">class</span><span class="si">}</span><span class="s2">} {id=</span><span class="si">#{</span><span class="nb">p</span><span class="p">[</span><span class="ss">:job</span><span class="p">].</span><span class="nf">job_id</span><span class="si">}</span><span class="s2">} {duration_ms=</span><span class="si">#{</span><span class="n">ms</span><span class="si">}</span><span class="s2">}"</span><span class="p">)</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>Why:</strong> Observe job latency and failures by class/queue.</p>

<hr />

<h3 id="5-track-external-http-requests">5) Track external HTTP requests</h3>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Notifications</span><span class="p">.</span><span class="nf">instrument</span><span class="p">(</span><span class="s2">"http.request"</span><span class="p">,</span> <span class="ss">url: </span><span class="n">url</span><span class="p">,</span> <span class="ss">service: </span><span class="s2">"billing"</span><span class="p">)</span> <span class="k">do</span>
  <span class="no">HTTP</span><span class="p">.</span><span class="nf">timeout</span><span class="p">(</span><span class="mi">20</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="k">end</span>

<span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Notifications</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="s2">"http.request"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">_n</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">_i</span><span class="p">,</span> <span class="nb">p</span><span class="o">|</span>
  <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"[http] {service=</span><span class="si">#{</span><span class="nb">p</span><span class="p">[</span><span class="ss">:service</span><span class="p">]</span><span class="si">}</span><span class="s2">} {url=</span><span class="si">#{</span><span class="nb">p</span><span class="p">[</span><span class="ss">:url</span><span class="p">]</span><span class="si">}</span><span class="s2">} {ms=</span><span class="si">#{</span><span class="p">((</span><span class="n">f</span><span class="o">-</span><span class="n">s</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="p">).</span><span class="nf">round</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">}"</span><span class="p">)</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>Why:</strong> Watch third-party latency, alert on anomalies.</p>

<hr />

<h3 id="6-centralized-auditing">6) Centralized auditing</h3>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Notifications</span><span class="p">.</span><span class="nf">instrument</span><span class="p">(</span><span class="s2">"user.login"</span><span class="p">,</span> <span class="ss">user_id: </span><span class="n">user</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>

<span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Notifications</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="s2">"user.login"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">_n</span><span class="p">,</span> <span class="n">_s</span><span class="p">,</span> <span class="n">_f</span><span class="p">,</span> <span class="n">_i</span><span class="p">,</span> <span class="n">payload</span><span class="o">|</span>
  <span class="no">AuditLog</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">event: </span><span class="s2">"login"</span><span class="p">,</span> <span class="ss">user_id: </span><span class="n">payload</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">])</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>Why:</strong> One pipeline for audit events.</p>

<hr />

<h3 id="7-conditional-logging-devstaging-only">7) Conditional logging (dev/staging only)</h3>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="k">if</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">env</span><span class="p">.</span><span class="nf">development?</span>
  <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Notifications</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="s2">"render_template.action_view"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">_n</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">_i</span><span class="p">,</span> <span class="nb">p</span><span class="o">|</span>
    <span class="nb">puts</span> <span class="s2">"Rendered {view=</span><span class="si">#{</span><span class="nb">p</span><span class="p">[</span><span class="ss">:identifier</span><span class="p">]</span><span class="si">}</span><span class="s2">} in {ms=</span><span class="si">#{</span><span class="p">((</span><span class="n">f</span><span class="o">-</span><span class="n">s</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="p">).</span><span class="nf">round</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">}"</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>Why:</strong> Keep prod quiet, keep dev noisy.</p>

<hr />

<h1 id="part-2--cheat-sheet-built-in-rails-events--a-ready-initializer">Part 2 — Cheat sheet: Built-in Rails events &amp; a ready initializer</h1>

<h2 id="copy-paste-initializer">Copy-paste initializer</h2>
<p>Create <strong><code class="language-plaintext highlighter-rouge">config/initializers/instrumentation.rb</code></strong>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
</pre></td><td class="rouge-code"><pre><span class="c1"># config/initializers/instrumentation.rb</span>

<span class="k">def</span> <span class="nf">redact_params</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">params</span> <span class="k">unless</span> <span class="n">params</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="no">Hash</span><span class="p">)</span>
  <span class="n">params</span><span class="p">.</span><span class="nf">deep_dup</span><span class="p">.</span><span class="nf">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">h</span><span class="o">|</span>
    <span class="sx">%w[password password_confirmation token Authorization]</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="o">|</span> <span class="n">h</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"[FILTERED]"</span> <span class="k">if</span> <span class="n">h</span><span class="p">.</span><span class="nf">key?</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">log_event</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">finish</span><span class="p">,</span> <span class="n">_id</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
  <span class="n">ms</span> <span class="o">=</span> <span class="p">((</span><span class="n">finish</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">).</span><span class="nf">round</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">safe</span> <span class="o">=</span> <span class="n">payload</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="no">Hash</span><span class="p">)</span> <span class="p">?</span> <span class="n">payload</span><span class="p">.</span><span class="nf">except</span><span class="p">(</span><span class="ss">:connection</span><span class="p">,</span> <span class="ss">:binds</span><span class="p">,</span> <span class="ss">:mail</span><span class="p">)</span> <span class="p">:</span> <span class="n">payload</span>
  <span class="k">if</span> <span class="nb">name</span> <span class="o">==</span> <span class="s2">"process_action.action_controller"</span> <span class="o">&amp;&amp;</span> <span class="n">safe</span><span class="p">[</span><span class="ss">:params</span><span class="p">]</span>
    <span class="n">safe</span> <span class="o">=</span> <span class="n">safe</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="ss">params: </span><span class="n">redact_params</span><span class="p">(</span><span class="n">safe</span><span class="p">[</span><span class="ss">:params</span><span class="p">]))</span>
  <span class="k">end</span>
  <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"[</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">] {ms=</span><span class="si">#{</span><span class="n">ms</span><span class="si">}</span><span class="s2">} {payload=</span><span class="si">#{</span><span class="n">safe</span><span class="si">}</span><span class="s2">}"</span><span class="p">)</span>
<span class="k">end</span>

<span class="no">EVENTS</span> <span class="o">=</span> <span class="sx">%w[
  start_processing.action_controller
  process_action.action_controller
  redirect_to.action_controller
  send_file.action_controller

  render_template.action_view
  render_partial.action_view
  render_collection.action_view

  sql.active_record
  instantiation.active_record

  enqueue.active_job
  enqueue_at.active_job
  perform_start.active_job
  perform.active_job

  deliver.action_mailer
  receive.action_mailer

  cache_read.active_support
  cache_fetch_hit.active_support
  cache_generate.active_support
  cache_write.active_support
  cache_delete.active_support
  cache_exist?.active_support

  perform_action.action_cable
  broadcast.action_cable
  transmit.action_cable
]</span>

<span class="no">EVENTS</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Notifications</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="nb">method</span><span class="p">(</span><span class="ss">:log_event</span><span class="p">))</span> <span class="p">}</span>

<span class="c1"># Example: sample noisy events (only 5%) in production</span>
<span class="k">if</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">env</span><span class="p">.</span><span class="nf">production?</span>
  <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Notifications</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="sr">/\.active_record$/</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="nb">name</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">finish</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">payload</span><span class="o">|</span>
    <span class="k">next</span> <span class="k">if</span> <span class="nb">rand</span> <span class="o">&gt;</span> <span class="mf">0.05</span>
    <span class="n">log_event</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">finish</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="what-each-family-carries-payload-highlights">What each family carries (payload highlights)</h2>
<ul>
  <li><strong>ActionController</strong>: <code class="language-plaintext highlighter-rouge">:controller, :action, :params, :format, :method, :path, :status, :view_runtime, :db_runtime</code></li>
  <li><strong>ActionView</strong>: <code class="language-plaintext highlighter-rouge">:identifier, :layout, :count</code></li>
  <li><strong>ActiveRecord</strong>: <code class="language-plaintext highlighter-rouge">:sql, :name, :binds, :cached</code></li>
  <li><strong>ActiveJob</strong>: <code class="language-plaintext highlighter-rouge">:job, :queue, :priority, :scheduled_at, :exception</code></li>
  <li><strong>ActionMailer</strong>: <code class="language-plaintext highlighter-rouge">:mail</code> (with headers, recipients, subject)</li>
  <li><strong>Cache</strong>: <code class="language-plaintext highlighter-rouge">:key, :hit, :expires_in</code></li>
  <li><strong>ActionCable</strong>: <code class="language-plaintext highlighter-rouge">:channel_class, :action, :data</code> / <code class="language-plaintext highlighter-rouge">:broadcasting, :message</code> / <code class="language-plaintext highlighter-rouge">:via</code></li>
</ul>

<blockquote>
  <p>Tip: To discover adapter-specific events (e.g., ActiveStorage), temporarily subscribe to <code class="language-plaintext highlighter-rouge">/\.active_storage$/</code> and log names as they appear.</p>
</blockquote>

<hr />

<h1 id="part-3--logsubscriber-clean-centralized-log-formatting">Part 3 — LogSubscriber: clean, centralized log formatting</h1>

<p>Use <strong>ActiveSupport::LogSubscriber</strong> when you want to <strong>format</strong> how events are logged in one place (per namespace) instead of sprinkling <code class="language-plaintext highlighter-rouge">subscribe</code> blocks.</p>

<h3 id="example-custom-sql-log-subscriber-highlight-slow-queries">Example: Custom SQL log subscriber (highlight slow queries)</h3>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="c1"># app/log_subscribers/sql_log_subscriber.rb</span>
<span class="k">class</span> <span class="nc">SqlLogSubscriber</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">LogSubscriber</span>
  <span class="no">SLOW_MS</span> <span class="o">=</span> <span class="mf">150.0</span>

  <span class="k">def</span> <span class="nf">sql</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="nf">payload</span>
    <span class="k">return</span> <span class="k">if</span> <span class="n">payload</span><span class="p">[</span><span class="ss">:name</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"SCHEMA"</span>

    <span class="n">ms</span> <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="nf">duration</span><span class="p">.</span><span class="nf">round</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">"SQL (</span><span class="si">#{</span><span class="n">ms</span><span class="si">}</span><span class="s2">ms) </span><span class="si">#{</span><span class="n">payload</span><span class="p">[</span><span class="ss">:name</span><span class="p">]</span><span class="si">}</span><span class="s2"> -- </span><span class="si">#{</span><span class="n">payload</span><span class="p">[</span><span class="ss">:sql</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
    <span class="n">ms</span> <span class="o">&gt;=</span> <span class="no">SLOW_MS</span> <span class="p">?</span> <span class="nb">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="p">:</span> <span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="c1"># uses Rails logger levels</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">SqlLogSubscriber</span><span class="p">.</span><span class="nf">attach_to</span> <span class="ss">:active_record</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="example-structured-controller-logs-as-json">Example: Structured controller logs as JSON</h3>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="c1"># app/log_subscribers/controller_log_subscriber.rb</span>
<span class="k">class</span> <span class="nc">ControllerLogSubscriber</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">LogSubscriber</span>
  <span class="k">def</span> <span class="nf">process_action</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="nb">p</span> <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="nf">payload</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
      <span class="ss">at: </span><span class="s2">"end"</span><span class="p">,</span>
      <span class="ss">controller: </span><span class="nb">p</span><span class="p">[</span><span class="ss">:controller</span><span class="p">],</span>
      <span class="ss">action:     </span><span class="nb">p</span><span class="p">[</span><span class="ss">:action</span><span class="p">],</span>
      <span class="ss">status:     </span><span class="nb">p</span><span class="p">[</span><span class="ss">:status</span><span class="p">],</span>
      <span class="ss">method:     </span><span class="nb">p</span><span class="p">[</span><span class="ss">:method</span><span class="p">],</span>
      <span class="ss">path:       </span><span class="nb">p</span><span class="p">[</span><span class="ss">:path</span><span class="p">],</span>
      <span class="ss">view_ms:    </span><span class="nb">p</span><span class="p">[</span><span class="ss">:view_runtime</span><span class="p">],</span>
      <span class="ss">db_ms:      </span><span class="nb">p</span><span class="p">[</span><span class="ss">:db_runtime</span><span class="p">],</span>
      <span class="ss">duration_ms: </span><span class="n">event</span><span class="p">.</span><span class="nf">duration</span><span class="p">.</span><span class="nf">round</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
      <span class="ss">request_id: </span><span class="no">Current</span><span class="p">.</span><span class="nf">request_id</span> <span class="c1"># if you set this in a middleware</span>
    <span class="p">}</span>
    <span class="n">info</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">to_json</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">ControllerLogSubscriber</span><span class="p">.</span><span class="nf">attach_to</span> <span class="ss">:action_controller</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="example-job-logs-to-a-separate-file">Example: Job logs to a separate file</h3>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="c1"># config/initializers/job_logger.rb</span>
<span class="no">JOB_LOGGER</span> <span class="o">=</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Logger</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"log/jobs.log"</span><span class="p">))</span>

<span class="c1"># app/log_subscribers/job_log_subscriber.rb</span>
<span class="k">class</span> <span class="nc">JobLogSubscriber</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">LogSubscriber</span>
  <span class="k">def</span> <span class="nf">perform</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="n">job</span> <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="nf">payload</span><span class="p">[</span><span class="ss">:job</span><span class="p">]</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">"[job] class={</span><span class="si">#{</span><span class="n">job</span><span class="p">.</span><span class="nf">class</span><span class="si">}</span><span class="s2">} id={</span><span class="si">#{</span><span class="n">job</span><span class="p">.</span><span class="nf">job_id</span><span class="si">}</span><span class="s2">} ms={</span><span class="si">#{</span><span class="n">event</span><span class="p">.</span><span class="nf">duration</span><span class="p">.</span><span class="nf">round</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">}"</span>
    <span class="no">JOB_LOGGER</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">JobLogSubscriber</span><span class="p">.</span><span class="nf">attach_to</span> <span class="ss">:active_job</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="tips">Tips</h3>
<ul>
  <li>Use <strong><code class="language-plaintext highlighter-rouge">attach_to :namespace</code></strong> where namespace matches the event suffix (e.g., <code class="language-plaintext highlighter-rouge">:active_record</code>, <code class="language-plaintext highlighter-rouge">:action_controller</code>, <code class="language-plaintext highlighter-rouge">:active_job</code>).</li>
  <li>Prefer <strong>LogSubscriber</strong> for <strong>formatting and routing logs</strong>, and <strong>Notifications</strong> for <strong>wiring side-effects</strong> (metrics, auditing, async work).</li>
  <li>Combine with <strong><code class="language-plaintext highlighter-rouge">ActiveSupport::TaggedLogging</code></strong> to add <code class="language-plaintext highlighter-rouge">request_id</code>, <code class="language-plaintext highlighter-rouge">user_id</code>, <code class="language-plaintext highlighter-rouge">tenant</code>, etc.</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="c1"># config/application.rb</span>
<span class="n">config</span><span class="p">.</span><span class="nf">log_tags</span> <span class="o">=</span> <span class="p">[</span><span class="ss">:request_id</span><span class="p">]</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<hr />

<h1 id="part-4--bonus-power-patterns">Part 4 — Bonus power patterns</h1>

<h3 id="a-quick-n1-detector-dev-only">A) Quick N+1 detector (dev only)</h3>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="k">if</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">env</span><span class="p">.</span><span class="nf">development?</span>
  <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Notifications</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="s2">"sql.active_record"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">_n</span><span class="p">,</span> <span class="n">_s</span><span class="p">,</span> <span class="n">_f</span><span class="p">,</span> <span class="n">_i</span><span class="p">,</span> <span class="n">payload</span><span class="o">|</span>
    <span class="k">if</span> <span class="n">payload</span><span class="p">[</span><span class="ss">:name</span><span class="p">]</span> <span class="o">!~</span> <span class="sr">/SCHEMA/</span> <span class="o">&amp;&amp;</span> <span class="n">payload</span><span class="p">[</span><span class="ss">:sql</span><span class="p">].</span><span class="nf">match?</span><span class="p">(</span><span class="sr">/SELECT/i</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">caller</span><span class="p">.</span><span class="nf">any?</span> <span class="p">{</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span> <span class="n">c</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="s2">"app/views"</span><span class="p">)</span> <span class="p">}</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">warn</span><span class="p">(</span><span class="s2">"[N+1?] {sql=</span><span class="si">#{</span><span class="n">payload</span><span class="p">[</span><span class="ss">:sql</span><span class="p">].</span><span class="nf">truncate</span><span class="p">(</span><span class="mi">140</span><span class="p">)</span><span class="si">}</span><span class="s2">}"</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="b-prometheusstatsd-metrics">B) Prometheus/StatsD metrics</h3>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Notifications</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="s2">"process_action.action_controller"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">_n</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">_i</span><span class="p">,</span> <span class="nb">p</span><span class="o">|</span>
  <span class="n">duration_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span> <span class="o">-</span> <span class="n">s</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
  <span class="no">PROM</span><span class="p">.</span><span class="nf">histogram</span><span class="p">(</span><span class="ss">:http_request_duration_ms</span><span class="p">,</span>
    <span class="ss">labels: </span><span class="p">{</span> <span class="ss">action: </span><span class="s2">"</span><span class="si">#{</span><span class="nb">p</span><span class="p">[</span><span class="ss">:controller</span><span class="p">]</span><span class="si">}</span><span class="s2">#</span><span class="si">#{</span><span class="nb">p</span><span class="p">[</span><span class="ss">:action</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="ss">status: </span><span class="nb">p</span><span class="p">[</span><span class="ss">:status</span><span class="p">]</span> <span class="p">}</span>
  <span class="p">).</span><span class="nf">observe</span><span class="p">(</span><span class="n">duration_ms</span><span class="p">)</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="c-sample-noisy-families-in-production">C) Sample noisy families in production</h3>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Notifications</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="sr">/\.active_record$/</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="nb">name</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">finish</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">payload</span><span class="o">|</span>
  <span class="k">next</span> <span class="k">if</span> <span class="nb">rand</span> <span class="o">&gt;</span> <span class="mf">0.05</span>
  <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"[sampled] {event=</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">} {ms=</span><span class="si">#{</span><span class="p">((</span><span class="n">finish</span><span class="o">-</span><span class="n">start</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="p">).</span><span class="nf">round</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">}"</span><span class="p">)</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<hr />

<h2 id="wrap-up">Wrap-up</h2>
<ul>
  <li>Start with the copy-paste initializer to get <strong>visibility fast</strong>.</li>
  <li>Add <strong>LogSubscribers</strong> where you need <strong>consistent formatting</strong> or <strong>separate sinks</strong>.</li>
  <li>Instrument your own domain events so analytics/auditing stay <strong>decoupled</strong>.</li>
  <li>Use <strong>sampling</strong> and <strong>redaction</strong> to keep production logs usable.</li>
</ul>

<p>Happy instrumenting! ✨</p>

  </div>
</article>

  </main>

  <footer class="footer">
    <div class="wrap">
      <a href="https://lukin.io/cv.pdf" target="_blank">cv</a>
    </div>
  </footer>
</body>

</html>
